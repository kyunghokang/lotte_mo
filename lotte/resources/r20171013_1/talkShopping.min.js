!function(a,b,c){"use strict";var d=b.module("app",["lotteComm","lotteSrh","lotteSideCtg","lotteCommFooter"]);d.controller("TalkShoppingCtrl",["$scope","LotteCommon","commInitData",function(a,b,c){a.showWrap=!0,a.subTitle="음성 쇼핑",a.DEV_MODE="",a.ts_basicInfo={initiated:!1,showBasicInfo:!1,showGuideInfo:!1,prior_info_chk:!1,et_mbr_dlvp_chk:!1,base_op_pay_chk:!1},a.ts_micStat={init:!1,inited:!1,open:!1,listening:!1,sending:!1,warning:!1},a.ts_stt={text:"",strength:0},a.ts_loadingData=!1,a.ts_currentStep=0,a.ts_currentGroup=null,a.ts_currentGoodsNo=null,a.ts_currentQue=null,a.ts_prodGroup=[],a.ts_groupMap={},a.ts_prodList=[],a.ts_goodsList=null,a.ts_talkList=[{},{},{},{},{},{}],a.ts_toastList=[],a.TOAST_LIST={step1:['"생수 주문해줘"라고 말해보세요'],step2:['"1번 주문해줘"라고 말해보세요','"1번 자세히"라고 말해보세요'],step3:['"결제해줘"라고 말해보세요'],nospeak:["듣고 있어요"]},a.ts_toastCnt=0,a.ts_toastIdx=0,a.ts_orderReview=null,a.ts_ttsPlayer=null,a.CHAT_QUE=[]}]),d.directive("lotteContainer",["LotteCommon","LotteUserService","LotteStorage","commInitData","$http","$timeout","$interval",function(d,e,f,g,h,i,j){return{templateUrl:"/lotte/resources_dev/talk/talkShopping_container.html",replace:!0,link:function(k,l,m){function n(){if(k.ts_micStat.listening){var a="";switch(k.ts_currentStep){case 1:a="생수 주문해줘";break;case 2:a="1번 주문해줘";break;case 3:a="결제해줘";break;default:return}var b=Math.round(100*Math.random());k.setSTTText(a,b)}}function o(){if(ta.member_no=k.loginInfo.mbrNo,ta.member_nm=k.loginInfo.name,ta.grade_cd=k.loginInfo.gradeCd,ta.customer_no=getCookie("CUSTNO"),ta.uagent=k.appObj.isAndroid?"Android":"iOS",ta.cp_schema=g.query.schema,ta.cp_v=g.query.v,ta.cp_udid=g.query.udid,ta.voice="Y",!k.isValidString(ta.member_no)||!k.isValidString(ta.customer_no)){var a=encodeURIComponent(ua+"?"+k.baseParam);return void k.gotoService("loginUrl",{targetUrl:a})}p(),s()}function p(){var a={rnd:Math.random()};h.get(va,{params:a}).success(q).error(r)}function q(a){if(ra){var b='{"response_code":"00000","response_msg":"","prior_info_chk":true,"et_mbr_dlvp_chk":true,"base_op_pay_chk":true,"card_pay_meth_cd":"카드결제방식코드","pay_mean_cd":"은행코드","pay_nm":"매입사명","acqr_cd":"매입사코드","dlvp_nm":"배송지명","post_no":"우편번호","post_addr":"주소","dtl_addr":"상세주소","rmit_nm":"수취인명","cell_txno_no":"휴대폰국번","cell_sct_no":"휴대폰앞","cell_end_no":"휴대폰뒤","pay_mean_nm":"결제수단명","morc_man_nm":"입금자명","cbl_tel_rgn_no":"유선지역번호","cbl_tel_txno_no":"유선국번","cbl_tel_end_no":"유선끝번호","cbl_tel_exno_no":"유선내선","addr_choc_sct_cd":"02","member_no":"123456","pr_dlvp_chane_chk":false}';a={},a.data=JSON.parse(b)}k.ts_basicInfo=a.data;var c=k.ts_basicInfo;c.initiated="Y"===f.getLocalStorage("TALK_SHOP_basicInitiated"),k.showHideBIPop(c.prior_info_chk!==!0||c.initiated===!1),u()}function r(){k.contVisible=!0}function s(){a.lpay=new Lpay({name:"lpay",url:xa,merchantSignKey:ya,reqTypeCd:"6000002",style:"1",openMode:"0",closeCallback:t,__iframe:{},popupReturnUrl:""})}function t(){console.warn("lpayCloseCB")}function u(){var a={mchtAuthKey:za,onlCno:Aa,callback:v};lpay.merchantAuth(a)}function v(a){a==c||"S"!=a.resClac?(k.ts_basicInfo.prior_info_chk=!1,k.ts_basicInfo.base_op_pay_chk=!1,k.showHideBIPop(!0),k.contVisible=!0,k.alert_2016("Lpay 가맹점 사용자 인증을 하지 못했습니다. 결제수단을 변경해 주세요.")):w()}function w(){var a={onlCno:Aa,callback:x};lpay.getPaymentMethod(a)}function x(a){a==c||"S"!=a.resClac?(k.ts_basicInfo.prior_info_chk=!1,k.ts_basicInfo.base_op_pay_chk=!1,k.showHideBIPop(!0),k.contVisible=!0,k.alert_2016("Lpay 결제수단 인증을 하지 못했습니다. 결제수단을 변경해 주세요.")):"function"==typeof sa?sa():y()}function y(){k.ts_currentStep=1,k.contVisible=!0,z(),i(R,100),k.initTTS(Z)}function z(){var a=k.ts_basicInfo;0==a.showBasicInfo&&0==k.ts_prodGroup.length&&k.talkRecomDelegate("getProdGroup")}function A(a,b){k.CHAT_QUE.push({param:a,data:b}),B()}function B(){if(0!=k.CHAT_QUE.length&&!k.ts_loadingData){T(),k.stopTTS();var a=k.CHAT_QUE.shift();k.ts_currentQue=a,k.ts_loadingData=!0,h.get(wa,{params:a.param}).success(D).error(C)}}function C(a,b,d,e){if(a&&a.err_msg&&""!=a.err_msg)k.alert_2016(a.err_msg);else{var f=!1;k.modalPopList2016!=c&&k.modalPopList2016.length>0&&"채팅 데이터 전송 에러"==k.modalPopList2016[0].message&&(f=!0),f||k.alert_2016("채팅 데이터 전송 에러")}k.ts_loadingData=!1,B()}function D(a,b,d,e){if(a==c||"0000"!=a.err_cd||a.data==c)C(a,b,d,e);else{var f=e.params,g=a.data;G(g,f),k.isValidArray(g.error_list)?E(g,f):"getProdGroup"==f.command?F(g,f):H(g,f),k.ts_loadingData=!1}B()}function E(a,b){na=!1,console.warn(a.error_list.join("<br/>"))}function F(a,d){var e=k.ts_talkList[1];e.talk_list=a.talk_list,e.tts_list=a.tts_list;var f,g;if(k.ts_prodGroup.length=0,b.isArray(a.group_list)){var h,i;for(g=a.group_list.length,f=0;g>f;f++)h=a.group_list[f],i=Math.floor(f/4),k.ts_prodGroup[i]==c&&(k.ts_prodGroup[i]=[]),k.ts_prodGroup[i].push(h),k.ts_groupMap[h.prod_grp_id]=h}na=!0,X("step")}function G(a,b){if(na=!1,k.isValidArray(a.tts_text)){na=!0;var c=a.tts_text.join("\n");k.loadTTS(c)}}function H(b,c){switch(b.command){case"goFirst":return void K(1);case"goBack":return void(5==k.ts_currentStep?K(3):J());case"gotoCart":ha();break;case"scrollDown":return $("html, body").stop(!0),void $("html, body").animate({scrollTop:$(a).scrollTop()+a.innerHeight},300);case"scrollTop":return $("html, body").stop(!0),void $("html, body").animate({scrollTop:0},300)}switch(k.ts_currentStep){case 1:M(b,c);break;case 2:N(b,c);break;case 3:O(b,c);break;case 4:P(b,c);break;case 5:Q(b,c)}na=!0,X("step")}function I(){E({error_list:["지금 실행할 수 없어요."]})}function J(){k.ts_currentStep>1&&(k.ts_currentStep-=1,L(),X("step"))}function K(a){!b.isNumber(a)||1>a||a>5||(k.ts_currentStep=a,L(),X("step"))}function L(){for(var a=5;a>=1;a--)a>k.ts_currentStep&&(k.ts_talkList[a]={});1==k.ts_currentStep?(k.ts_currentGroup=null,k.ts_currentGoodsNo=null,k.ts_goodsList=null):2==k.ts_currentStep&&(k.ts_currentGoodsNo=null),k.ts_currentStep<3&&(k.ts_orderReview=null)}function M(a,b){switch(a.command){case"selectGroup":if(k.ts_groupMap[a.prod_group_id]==c)return void k.alert_2016("잘못된 그룹입니다.");k.ts_currentGroup=a.prod_group_id,k.ts_goodsList=a.goods_no_list,k.ts_prodList.length=0;var d,e,f=k.ts_groupMap[k.ts_currentGroup].prod_list,g=f.length;if(k.isValidArray(a.goods_no_list))for(d=0;g>d;d++)e=f[d],a.goods_no_list.indexOf(e.goods_no)>=0&&k.ts_prodList.push(f[d]);else k.ts_prodList=[].concat(f);k.ts_currentStep=2;var h=k.ts_talkList[k.ts_currentStep];h.user_text=b.text,h.talk_list=a.talk_list,h.tts_list=a.tts_list;break;default:I()}}function N(a,b){switch(a.command){case"productDetail":ga(a.goods_no);break;case"selectProduct":k.ts_currentStep=3,k.ts_currentGoodsNo=a.goods_no;var c=k.ts_talkList[k.ts_currentStep];c.user_text=b.text,c.talk_list=a.talk_list,c.tts_list=a.tts_list,k.ts_orderReview=a.ret_object,console.warn(k.ts_orderReview);break;default:I()}}function O(a,b){switch(a.command){case"payRequest":k.ts_currentStep=4;var c=k.ts_talkList[k.ts_currentStep];c.user_text=b.text,c.talk_list=a.talk_list,c.tts_list=a.tts_list;break;default:I()}}function P(a,b){switch(a.command){case"payComplete":k.ts_currentStep=5;var c=k.ts_talkList[k.ts_currentStep];c.talk_list=a.talk_list,c.tts_list=a.tts_list;break;default:I()}}function Q(a,b){switch(a.command){default:I()}}function R(){k.ts_micStat.init=!0,i(function(){k.ts_micStat.inited=!0},300),i(_,1e3)}function S(){i.cancel(oa.activateMic),k.stopTTS(),k.ts_micStat.open=!0,oa.activateMic=i(U,pa.activateMic)}function T(){k.callAppAPI("stopSTT"),i.cancel(oa.activateMic),i.cancel(oa.noSpeaking),i.cancel(oa.quitRecognition),k.ts_micStat.open=!1,k.ts_micStat.listening=!1,k.ts_micStat.sending=!1,k.ts_micStat.warning=!1,k.ts_stt.text="",k.ts_stt.strength=0,qa.angle=0,qa.top=0,X("step")}function U(){k.ts_micStat.listening=!0,i.cancel(oa.noSpeaking),i.cancel(oa.quitRecognition),oa.noSpeaking=i(W,pa.noSpeaking),oa.quitRecognition=i(V,pa.quitRecognition),k.callAppAPI("startSTT")}function V(){k.isValidString(k.ts_stt.text)&&k.talkRecomDelegate("sendSpeech",k.ts_stt.text),T()}function W(){""==k.ts_stt.text&&X("nospeak")}function X(a){switch(j.cancel(oa.rotateToast),"step"==a&&(a+=k.ts_currentStep),a){case"step1":k.ts_toastList=k.TOAST_LIST.step1;break;case"step2":k.ts_toastList=k.TOAST_LIST.step2;break;case"step3":k.ts_toastList=k.TOAST_LIST.step3;break;case"nospeak":k.ts_toastList=k.TOAST_LIST.nospeak;break;default:k.ts_toastList=[]}k.ts_toastCnt=k.ts_toastList.length,k.ts_toastIdx=Math.floor(Math.random()*k.ts_toastCnt),k.ts_toastCnt>1&&(oa.rotateToast=j(Y,pa.rotateToast))}function Y(){k.ts_toastCnt<=1||(k.ts_toastIdx=(k.ts_toastIdx+1)%k.ts_toastCnt)}function Z(){console.warn("TTS END"),na&&k.ts_currentStep<=3&&S()}function _(){j(aa,20)}function aa(){if(k.ts_micStat.listening||k.ts_micStat.sending||k.ts_micStat.warning){qa.angle+=10;var a=b.element(".tsmc_dot span.a1"),c=b.element(".tsmc_dot span.a2"),d=b.element(".tsmc_dot span.a3"),e=a.find("span"),f=c.find("span"),g=d.find("span");0!=a.length&&(k.ts_micStat.listening?(ba(),ca()):k.ts_micStat.sending?da():k.ts_micStat.warning&&ea(),a.css(ia),c.css(ja),d.css(ka),la.top=-qa.top,la.bottom=-qa.top,ma.top=.6*-qa.top,ma.bottom=.6*-qa.top,e.css(la),f.css(ma),g.css(la))}}function ba(){return}function ca(){var a=2,b=qa.angle,c=b-120,d=b-240;0>c&&(c=0),0>d&&(d=0);var e=b/180*Math.PI,f=c/180*Math.PI,g=d/180*Math.PI,h=Math.sin(e)*a,i=Math.sin(f)*a,j=Math.sin(g)*a;ia.top=h,ja.top=i,ka.top=j,qa.top=fa(qa.top,0),ia.opacity=fa(ia.opacity,1),ja.opacity=fa(ja.opacity,1),ka.opacity=fa(ka.opacity,1)}function da(){var a=.4,b=.6,c=qa.angle,d=c-60,e=c-120;0>d&&(d=0),0>e&&(e=0);var f=c/180*Math.PI,g=d/180*Math.PI,h=e/180*Math.PI,i=Math.sin(f)*a+b,j=Math.sin(g)*a+b,k=Math.sin(h)*a+b;ia.opacity=i,ja.opacity=j,ka.opacity=k,qa.top=fa(qa.top,0),ia.top=fa(ia.top,0),ja.top=fa(ja.top,0),ka.top=fa(ka.top,0)}function ea(){ia.top=fa(ia.top,0),ja.top=fa(ja.top,0),ka.top=fa(ka.top,0),qa.top=fa(qa.top,0),ia.opacity=fa(ia.opacity,1),ja.opacity=fa(ja.opacity,1),ka.opacity=fa(ka.opacity,1)}function fa(a,b){var c=b-a;return Math.abs(c)<.05?b:a+c/10}function ga(a){var b={curDispNoSctCd:94,goodsNo:a},c="";k.productView(b,"","",c)}function ha(){k.gotoService("cartLstUrl")}k.DEV_MODE="m.lotte.com"!=location.host&&"Y"==g.query.dev_mode;var ia={top:0,opacity:1},ja={top:0,opacity:1},ka={top:0,opacity:1},la={top:0,bottom:0},ma={top:0,bottom:0},na=!1,oa={activateMic:null,quitRecognition:null,noSpeaking:null,rotateToast:null},pa={activateMic:500,quitRecognition:1e4,noSpeaking:4e3,rotateToast:2e3},qa={angle:0,top:0},ra=location.host.indexOf(":8082")<0;ra&&(d.talkShopUrl=d.secureUrl+"/talk/main/talkShopping.do",d.talkShopChatbot=d.talkRecomChatbot,d.talkShopPriorInfo="/json/talk/talk_prior_info.json",d.talkShopDelevery="/popup/talk_delivery_service.do",d.talkShopPayment="/popup/talk_base_pay.do");var sa,ta={},ua=d.talkShopUrl,va=d.talkShopPriorInfo,wa=d.talkShopChatbot,xa="https://web.lpay.com:1452",ya="e30f88c2c39f2a82af5d08f4691ba6b6",za="00076790",Aa="17617766";("localhost:8082"===location.host||"10.149.132.91:8082"===location.host)&&(d.loginUrl="/login/m/loginForm_dev.html",setCookie("LOGINCHK","9nXuTbHiBiw="),setCookie("LOGINID","zE7jB5V8+oLdIjKcRj1zmA=="),setCookie("CUSTNO","XLbE+wLdXZE=")),k.isValidArray=function(a){return b.isArray(a)&&a.length>0},k.isValidString=function(a){return b.isString(a)&&a.length>0},k.DEV_MODE&&j(n,200),k.delLS=function(){f.delLocalStorage("TALK_SHOP_basicInitiated")},k.stopSpeechRecog=function(){k.stopTTS(),T()},k.changeBasicInfo=function(a){switch(a){case 1:k.gotoService("talkShopDelevery");break;case 2:k.gotoService("talkShopPayment")}},k.closeBasicInfo=function(a){var b=k.ts_basicInfo;switch(a){case 0:history.back();break;case 1:case 2:if(b.prior_info_chk!==!0)return;f.setLocalStorage("TALK_SHOP_basicInitiated","Y"),b.initiated=!0,k.showHideBIPop(!1),z()}},k.showHideBIPop=function(a){k.ts_basicInfo.showGuideInfo=!1,a===!0?(k.ts_basicInfo.showBasicInfo=!0,b.element("body").addClass("ts_basic_pop")):(k.ts_basicInfo.showBasicInfo=!1,b.element("body").removeClass("ts_basic_pop"))},k.showHideGuidePop=function(a){k.ts_basicInfo.showBasicInfo=!1,b.element("body").removeClass("ts_basic_pop"),a===!0?k.ts_basicInfo.showGuideInfo=!0:k.ts_basicInfo.showGuideInfo=!1},k.goHistoryBack=function(){history.back()},k.talkRecomDelegate=function(){if(0!=arguments.length){var a=[].slice.call(arguments),c=a.shift(),d={command:c,step:k.ts_currentStep,text:a[0],prod_group_id:k.ts_currentGroup,goods_no:k.ts_currentGoodsNo};k.isValidArray(k.ts_goodsList)&&(d.goods_no_list=k.ts_goodsList.join(","));var e=b.extend(ta,d);A(e)}},k.paymentSuccess=function(){k.talkRecomDelegate("sendSpeech","결제완료")},k.paymentFail=function(){k.alert_2016("결제 실패"),J()},k.selectProdGroup=function(a){k.talkRecomDelegate("sendSpeech",a.title+" 주문해줘")},k.selectProduct=function(a){k.talkRecomDelegate("sendSpeech",a+"번 주문해줘")},k.closeOrderLayer=function(){b.element("#tsol_iframe").prop("src","about:blank"),J()},k.setSTTText=function(a,c){b.isString(a)&&b.isNumber(c)&&(k.ts_stt.text=a,k.ts_stt.strength=c)},a.setSTTText=k.setSTTText,k.callAppAPI=function(a,b){var c,d="talkshop://"+a,e="?";for(c in b)d+=e+c+"="+b[c],e="&";k.appObj.isApp&&($window.location.href=d)},k.micClick=function(){0!=k.ts_micStat.inited&&(k.ts_micStat.open?V():S())},e.promiseLoginInfo()["finally"](function(a){o()})}}}]),d.directive("talkShopTts",["LotteCommon","LotteUserService","LotteStorage","commInitData","$http","$timeout","$interval",function(a,d,e,f,g,h,i){return{replace:!0,link:function(a,d,e){function f(){b.isFunction(g)&&g()}var g;a.initTTS=function(b){var c=document.getElementById("tts_audio");c.addEventListener("ended",f),g=b,a.ts_ttsPlayer=c},a.loadTTS=function(a){return},a.stopTTS=function(){a.ts_ttsPlayer!=c&&a.ts_ttsPlayer.pause()}}}}])}(window,window.angular);