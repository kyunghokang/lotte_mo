!function(a,b,c){"use strict";var d=b.module("app",["lotteComm","lotteSrh","lotteSideCtg","lotteCommFooter"]);d.controller("TalkShoppingCtrl",["$scope","LotteCommon","commInitData",function(a,b,c){a.showWrap=!0,a.contVisible=!0,a.subTitle="음성 쇼핑",a.DEV_MODE="",a.ts_showIntroPop=!1,a.ts_basicInfo={initiated:!1,showBasicInfo:!1,showGuideInfo:!1,prior_info_chk:!1,et_mbr_dlvp_chk:!1,base_op_pay_chk:!1},a.ts_micStat={init:!1,inited:!1,open:!1,listening:!1,sending:!1,warning:!1},a.ts_stt={text:"",strength:0},a.ts_loadingData=!1,a.ts_currentStep=0,a.ts_currentGroup=null,a.ts_currentGoodsNo=null,a.ts_currentOrderNo=null,a.ts_currentQue=null,a.ts_groupList=[],a.ts_prodGroup=[],a.ts_groupMap={},a.ts_prodList=[],a.ts_goodsList=null,a.ts_talkList=[{},{},{},{},{},{}],a.ts_toastList=[],a.TOAST_LIST={step1:['"생수 주문해줘"라고 말해보세요'],step2:['"1번 주문해줘"라고 말해보세요','"1번 자세히"라고 말해보세요'],step3:['"결제해줘"라고 말해보세요'],nospeak:["듣고 있어요"]},a.ts_toastCnt=0,a.ts_toastIdx=0,a.ts_orderReview=null,a.ts_orderPaying=null,a.ts_orderResult=null,a.ts_ttsPlayer=null,a.CHAT_QUE=[]}]),d.directive("lotteContainer",["LotteCommon","LotteUserService","LotteStorage","commInitData","$http","$timeout","$interval",function(d,e,f,g,h,i,j){return{templateUrl:"/lotte/resources_dev/talk/talkShopping_container.html",replace:!0,link:function(k,l,m){function n(){if(k.ts_micStat.listening){var a="";switch(k.ts_currentStep){case 1:a="생수 주문해줘";break;case 2:a="1번 주문해줘";break;case 3:a="결제해줘";break;default:return}var b=Math.round(100*Math.random());k.setSTTText(a,b)}}function o(a){La=a,console.log("chat server changed: "+La)}function p(){if(Ia.member_no=k.loginInfo.mbrNo,Ia.member_nm=k.loginInfo.name,Ia.uagent=k.appObj.isAndroid?"Y":"N",Ia.cp_schema=g.query.schema,Ia.cp_v=g.query.v,Ia.cp_udid=g.query.udid,Ia.chl_no=g.query.cn,Ia.voice="Y",!k.isValidString(Ia.member_no)){var a=encodeURIComponent(Ja+"?"+k.baseParam);return void k.gotoService("loginUrl",{targetUrl:a})}"Y"===f.getSessionStorage("TALK_SHOP_closeIntro")||"Y"===f.getLocalStorage("TALK_SHOP_noMoreIntro")?(k.ts_showIntroPop=!1,q()):k.ts_showIntroPop=!0}function q(){k.ts_showIntroPop=!1,w(),k.$watch("ts_currentStep",P),null==history.state||"talkshopping"!=history.state.name?(console.log("NEW VISIT"),history.replaceState({name:"talkshopping"},"talkshopping"),t()):(console.log("REVISIT"),s()?console.log("HAS SESSION"):(console.log("NO SESSION"),t())),b.element(a).on("unload",r)}function r(){if(Ha===!0){var c={};c.scrollTop=b.element(a).scrollTop(),c.currentStep=k.ts_currentStep,c.basicInfo=k.ts_basicInfo,c.talkList=k.ts_talkList,c.toastList=k.ts_toastList,c.groupList=k.ts_groupList,c.prodList=k.ts_prodList,c.currentGroup=k.ts_currentGroup,c.currentGoodsNo=k.ts_currentGoodsNo,c.currentOrderNo=k.ts_currentOrderNo,c.goodsNoList=k.ts_goodsList,c.orderReview=k.ts_orderReview,c.orderPaying=k.ts_orderPaying,c.orderResult=k.ts_orderResult,console.log("SAVE SESSION"),console.log(c),f.setSessionStorage("TALK_SHOP_SSST",c,"json")}}function s(){if(Ha!==!0)return!1;var a=f.getSessionStorage("TALK_SHOP_SSST","json");if(a==c)return!1;try{console.log(a),k.ts_micStat={init:!0,inited:!0,open:!1,listening:!1,sending:!1,warning:!1},k.ts_currentStep=a.currentStep,k.ts_basicInfo=a.basicInfo,k.ts_basicInfo.showBasicInfo=!1,k.ts_talkList=a.talkList,k.ts_toastList=a.toastList,k.ts_groupList=a.groupList,L(),k.ts_prodList=a.prodList,k.ts_currentGroup=a.currentGroup,k.ts_currentGoodsNo=a.currentGoodsNo,k.ts_currentOrderNo=a.currentOrderNo,k.ts_goodsList=a.goodsNoList,k.ts_orderReview=a.orderReview,k.ts_orderPaying=a.orderPaying,k.ts_orderResult=a.orderResult,i(function(){Q(!0)},100),isNaN(a.scrollTop)||scrollTo(0,a.scrollTop)}catch(b){return!1}return!0}function t(){var a={member_no:Ia.member_no};h.get(Ka,{params:a}).success(u).error(v)}function u(a){if(a==c||a.data==c)return k.showHideBIPop(!0),void v();k.ts_basicInfo=a.data;var b=k.ts_basicInfo;b.initiated="Y"===f.getLocalStorage("TALK_SHOP_basicInitiated"),k.showHideBIPop(b.prior_info_chk!==!0||b.initiated===!1),"40"==b.pay_mean_cd?(Qa=b.onlCno,y()):D()}function v(){}function w(){a.lpay=new Lpay({name:"lpay",url:Na,merchantSignKey:Oa,reqTypeCd:"6000002",style:"1",openMode:"0",closeCallback:x,__iframe:{},popupReturnUrl:""})}function x(){console.warn("lpayCloseCB")}function y(){var a={mchtAuthKey:Pa,onlCno:Qa,callback:z};lpay.merchantAuth(a)}function z(a){a==c||"S"!=a.resClac?C():A()}function A(){var a={onlCno:Qa,callback:B};lpay.getPaymentMethod(a)}function B(a){if(a==c||"S"!=a.resClac)C();else{try{k.ts_basicInfo.fnCoNm="",k.ts_basicInfo.pmtMthdAlias="",b.forEach(a.pmtMthdList,function(a,b){console.log(a),a.pmtMthdId==k.ts_basicInfo.pay_card_rcgn_id&&(k.ts_basicInfo.fnCoNm=a.fnCoNm,k.ts_basicInfo.pmtMthdAlias=a.pmtMthdAlias)}),k.isValidString(k.ts_basicInfo.pmtMthdAlias)||C()}catch(d){C()}"function"==typeof xa?xa():D()}}function C(){k.ts_basicInfo.prior_info_chk=!1,k.ts_basicInfo.base_op_pay_chk=!1,k.showHideBIPop(!0),k.alert_2016("Lpay 결제수단 인증을 하지 못했습니다. 결제수단을 변경해 주세요.")}function D(){k.ts_currentStep=1,E(),i(ea,100)}function E(){var a=k.ts_basicInfo;0==a.showBasicInfo&&0==k.ts_prodGroup.length&&k.talkRecomDelegate("getProdGroup")}function F(a,b){k.CHAT_QUE.push({param:a,data:b}),G()}function G(){if(0!=k.CHAT_QUE.length&&!k.ts_loadingData){ga(),na();var a=k.CHAT_QUE.shift();k.ts_currentQue=a,k.ts_loadingData=!0,h.get(La,{params:a.param}).success(I).error(H)}}function H(a,b,d,e){if(a&&a.err_msg&&""!=a.err_msg)k.alert_2016(a.err_msg);else{var f=!1;k.modalPopList2016!=c&&k.modalPopList2016.length>0&&"채팅 데이터 전송 에러"==k.modalPopList2016[0].message&&(f=!0),f||k.alert_2016("채팅 데이터 전송 에러")}k.ts_loadingData=!1,G()}function I(a,b,d,e){if(a==c||"0000"!=a.err_cd||a.data==c)H(a,b,d,e);else{var f=e.params,g=a.data;M(g,f),k.isValidArray(g.error_list)?J(g,f):"getProdGroup"==f.command?K(g,f):N(g,f),k.ts_loadingData=!1,r()}G()}function J(a,b){Da=!1,console.warn(a.error_list.join("<br/>"))}function K(a,b){var c=k.ts_talkList[1];c.talk_list=a.talk_list,c.tts_text=a.tts_text,k.ts_groupList=a.group_list,L(),Da=!0,ka("step")}function L(){k.ts_prodGroup.length=0;var a=k.ts_groupList;if(k.isValidArray(a)){var b,d,e,f;for(d=a.length,b=0;d>b;b++)e=a[b],f=Math.floor(b/4),k.ts_prodGroup[f]==c&&(k.ts_prodGroup[f]=[]),k.ts_prodGroup[f].push(e),k.ts_groupMap[e.prod_grp_id]=e}}function M(a,b){if(Da=!1,k.isValidArray(a.tts_text)){Da=!0;var c=a.tts_text.join("\n");ma(c)}}function N(b,c){switch(b.command){case"goFirst":return void S(1);case"goBack":return void(5==k.ts_currentStep?S(3):R());case"gotoCart":wa();break;case"scrollDown":return $("html, body").stop(!0),void $("html, body").animate({scrollTop:$(a).scrollTop()+a.innerHeight},300);case"scrollTop":return $("html, body").stop(!0),void $("html, body").animate({scrollTop:0},300)}switch(aa(b.talk_list),k.ts_currentStep){case 1:U(b,c);break;case 2:V(b,c);break;case 3:W(b,c);break;case 4:Y(b,c);break;case 5:Z(b,c)}Da=!0,ka("step")}function O(a){a!=c&&k.isValidArray(a.tts_text)||J({error_list:["이해하지 못했어요."]})}function P(a,b){a!=b&&i(Q,100)}function Q(c){var d=$(".ts_step_cont > div"),e=d.children();if(0==d.length&&4!=k.ts_currentStep)return void i(Q,100);d.stop(!0),e.stop(!0),d.css({top:1.02*b.element(a).height(),opacity:1}),e.css({opacity:0});var f={top:0},g={easing:k.checkJQueryEasing("easeOutQuad"),duration:500},h={opacity:1},j={easing:k.checkJQueryEasing("linear"),duration:200};if(c===!0)d.css(f),e.css(h);else{var l,m,n=0;d.each(function(a,b){l=$(b),m=l.children(),n+=0==a?250:250/(a+1),l.delay(n).animate(f,g),m.delay(n+200).animate(h,j)})}}function R(){k.ts_currentStep>1&&(da(),k.ts_currentStep-=1,T(),ka("step"))}function S(a){!b.isNumber(a)||1>a||a>5||(da(),k.ts_currentStep=a,T(),ka("step"))}function T(){for(var a=5;a>=1;a--)a>k.ts_currentStep&&(k.ts_talkList[a]={});1==k.ts_currentStep?(k.ts_currentGroup=null,k.ts_currentGoodsNo=null,k.ts_goodsList=null):2==k.ts_currentStep&&(k.ts_currentGoodsNo=null),k.ts_currentStep<3&&(k.ts_orderReview=null),k.ts_currentStep<4&&(k.ts_orderPaying=null,k.ts_currentOrderNo=null),k.ts_currentStep<5&&(k.ts_orderResult=null)}function U(a,b){switch(a.command){case"selectGroup":if(k.ts_groupMap[a.prod_grp_id]==c)return void k.alert_2016("잘못된 그룹입니다.");da(),k.ts_currentGroup=a.prod_grp_id,k.ts_goodsList=a.goods_no_list,k.ts_prodList.length=0;var d,e,f=k.ts_groupMap[k.ts_currentGroup].prod_list,g=f.length;if(k.isValidArray(a.goods_no_list))for(d=0;g>d;d++)e=f[d],a.goods_no_list.indexOf(e.goods_no)>=0&&k.ts_prodList.push(f[d]);else k.ts_prodList=[].concat(f);k.ts_currentStep=2;var h=k.ts_talkList[k.ts_currentStep];h.user_text=b.text,h.talk_list=a.talk_list,h.tts_text=a.tts_text;break;default:O(a)}}function V(a,b){switch(a.command){case"productDetail":va(a.goods_no);break;case"selectProduct":da(),k.ts_currentStep=3,k.ts_currentGoodsNo=a.goods_no;var c=k.ts_talkList[k.ts_currentStep];c.user_text=b.text,c.talk_list=a.talk_list,c.tts_text=a.tts_text,k.ts_orderReview=a.ret_object;break;default:O(a)}}function W(a,b){switch(a.command){case"payRequest":da(),k.ts_orderPaying={r:a,q:b},"40"==k.ts_basicInfo.pay_mean_cd?(xa=X,y()):X();break;default:O(a)}}function X(){da();var a=k.ts_orderPaying.r,b=k.ts_orderPaying.q;k.ts_currentStep=4;var c=k.ts_talkList[k.ts_currentStep];c.user_text=b.text,c.talk_list=a.talk_list,c.tts_text=a.tts_text,i(ba,10)}function Y(a,b){switch(a.command){case"payComplete":da(),k.ts_currentStep=5;var c=k.ts_talkList[k.ts_currentStep];c.talk_list=a.talk_list,c.tts_text=a.tts_text,k.ts_orderResult=a.ret_object;break;default:O(a)}}function Z(a,b){switch(a.command){default:O(a)}}function _(a){return Ra[a]}function aa(a){if(k.isValidArray(a))for(var b=a.length,c=0;b>c;c++)a[c]=a[c].replace(Sa,_)}function ba(){var a,d;try{a=k.ts_orderReview.cart_sn,d=k.ts_orderReview.goods_list.items[0].goods_no}catch(e){}if(a==c||d==c)return void k.alert_2016("유효하지 않은 상품입니다.");var f=Ma+"?talkYN=Y&"+k.baseParam+"&cart_sn="+a+"&goods_no="+d;b.element("#tsol_iframe").prop("src",f)}function ca(a,b,c){console.warn(a,b,c),"0000"==a?k.paymentSuccess(c):k.paymentFail(a,b)}function da(){a.scrollTo(0,0)}function ea(){k.ts_micStat.init=!0,i(function(){k.ts_micStat.inited=!0},300),i(pa,1e3)}function fa(){i.cancel(Ea.activateMic),i.cancel(Ea.returnFirst),na(),k.ts_micStat.open=!0,Ea.activateMic=i(ha,Fa.activateMic)}function ga(){k.callAppAPI("stopSTT"),i.cancel(Ea.activateMic),i.cancel(Ea.noSpeaking),i.cancel(Ea.quitRecognition),k.ts_micStat.open=!1,k.ts_micStat.listening=!1,k.ts_micStat.sending=!1,k.ts_micStat.warning=!1,k.ts_stt.text="",k.ts_stt.strength=0,Ga.angle=0,Ga.top=0,ka("step")}function ha(){k.ts_micStat.listening=!0,i.cancel(Ea.noSpeaking),i.cancel(Ea.quitRecognition),Ea.noSpeaking=i(ja,Fa.noSpeaking),Ea.quitRecognition=i(ia,Fa.quitRecognition),k.callAppAPI("startSTT")}function ia(){k.isValidString(k.ts_stt.text)&&k.talkRecomDelegate("sendSpeech",k.ts_stt.text),ga()}function ja(){""==k.ts_stt.text&&ka("nospeak")}function ka(a){switch(j.cancel(Ea.rotateToast),"step"==a&&(a+=k.ts_currentStep),a){case"step1":k.ts_toastList=k.TOAST_LIST.step1;break;case"step2":k.ts_toastList=k.TOAST_LIST.step2;break;case"step3":k.ts_toastList=k.TOAST_LIST.step3;break;case"nospeak":k.ts_toastList=k.TOAST_LIST.nospeak;break;default:k.ts_toastList=[]}k.ts_toastCnt=k.ts_toastList.length,k.ts_toastIdx=Math.floor(Math.random()*k.ts_toastCnt),k.ts_toastCnt>1&&(Ea.rotateToast=j(la,Fa.rotateToast))}function la(){k.ts_toastCnt<=1||(k.ts_toastIdx=(k.ts_toastIdx+1)%k.ts_toastCnt)}function ma(a){k.callAppAPI("startTTS",{text:a})}function na(){k.callAppAPI("stopTTS")}function oa(){console.warn("TTS END"),Da&&k.ts_currentStep<=3&&fa(),5==k.ts_currentStep&&(Ea.returnFirst=i(function(){S(1)},3e3))}function pa(){j(qa,20)}function qa(){if(k.ts_micStat.listening||k.ts_micStat.sending||k.ts_micStat.warning){Ga.angle+=10;var a=b.element(".tsmc_dot span.a1"),c=b.element(".tsmc_dot span.a2"),d=b.element(".tsmc_dot span.a3"),e=a.find("span"),f=c.find("span"),g=d.find("span");0!=a.length&&(k.ts_micStat.listening?ra():k.ts_micStat.sending?sa():k.ts_micStat.warning&&ta(),a.css(ya),c.css(za),d.css(Aa),Ba.top=-Ga.top,Ba.bottom=-Ga.top,Ca.top=.6*-Ga.top,Ca.bottom=.6*-Ga.top,e.css(Ba),f.css(Ca),g.css(Ba))}}function ra(){var a=2,b=Ga.angle,c=b-120,d=b-240;0>c&&(c=0),0>d&&(d=0);var e=b/180*Math.PI,f=c/180*Math.PI,g=d/180*Math.PI,h=Math.sin(e)*a,i=Math.sin(f)*a,j=Math.sin(g)*a;ya.top=h,za.top=i,Aa.top=j,Ga.top=ua(Ga.top,0),ya.opacity=ua(ya.opacity,1),za.opacity=ua(za.opacity,1),Aa.opacity=ua(Aa.opacity,1)}function sa(){var a=.4,b=.6,c=Ga.angle,d=c-60,e=c-120;0>d&&(d=0),0>e&&(e=0);var f=c/180*Math.PI,g=d/180*Math.PI,h=e/180*Math.PI,i=Math.sin(f)*a+b,j=Math.sin(g)*a+b,k=Math.sin(h)*a+b;ya.opacity=i,za.opacity=j,Aa.opacity=k,Ga.top=ua(Ga.top,0),ya.top=ua(ya.top,0),za.top=ua(za.top,0),Aa.top=ua(Aa.top,0)}function ta(){ya.top=ua(ya.top,0),za.top=ua(za.top,0),Aa.top=ua(Aa.top,0),Ga.top=ua(Ga.top,0),ya.opacity=ua(ya.opacity,1),za.opacity=ua(za.opacity,1),Aa.opacity=ua(Aa.opacity,1)}function ua(a,b){var c=b-a;return Math.abs(c)<.05?b:a+c/10}function va(a){var b={curDispNoSctCd:94,goodsNo:a},c="";k.productView(b,"","",c)}function wa(){k.gotoService("cartLstUrl")}k.DEV_MODE="m.lotte.com"!=location.host&&"Y"==g.query.dev_mode;var xa,ya={top:0,opacity:1},za={top:0,opacity:1},Aa={top:0,opacity:1},Ba={top:0,bottom:0},Ca={top:0,bottom:0},Da=!1,Ea={activateMic:null,quitRecognition:null,noSpeaking:null,rotateToast:null,returnFirst:null},Fa={activateMic:500,quitRecognition:1e4,noSpeaking:4e3,rotateToast:2e3},Ga={angle:0,top:0},Ha=(location.host.indexOf(":8082")<0,!0),Ia={},Ja=d.talkShopUrl,Ka=d.talkShopPriorInfo,La=d.talkShopChatbot,Ma=d.talkShopOrderFrame,Na="https://web.lpay.com:1452",Oa="e30f88c2c39f2a82af5d08f4691ba6b6",Pa="00076790",Qa="";("localhost:8082"===location.host||"10.149.132.91:8082"===location.host)&&(d.loginUrl="/login/m/loginForm_dev.html",setCookie("LOGINCHK","9nXuTbHiBiw="),setCookie("LOGINID","zE7jB5V8+oLdIjKcRj1zmA=="),setCookie("CUSTNO","XLbE+wLdXZE=")),k.isValidArray=function(a){return b.isArray(a)&&a.length>0},k.isValidString=function(a){return b.isString(a)&&a.length>0},k.isValidNumber=function(a){return b.isNumber(a)&&a>0},k.DEV_MODE&&!k.appObj.isApp&&j(n,200),k.delLS=function(){f.delLocalStorage("TALK_SHOP_basicInitiated"),f.delLocalStorage("TALK_SHOP_noMoreIntro"),f.delSessionStorage("TALK_SHOP_closeIntro"),f.delSessionStorage("TALK_SHOP_SSST"),location.href=d.talkShopUrl+"?"+k.baseParam+"&dev_mode=Y&a="+Math.round(100*Math.random())},k.stopSpeechRecog=function(){na(),ga()},k.toggleDevSidebar=function(){b.element(".dev_sidebar").toggleClass("minize")},k.talkUserInput=function(){var b=a.prompt();k.isValidString(b)&&k.talkRecomDelegate("sendSpeech",b)},a.changeServer=o,k.changeBasicInfo=function(a){switch(a){case 1:k.gotoService("talkShopDelevery");break;case 2:k.gotoService("talkShopPayment")}},k.closeBasicInfo=function(a){var b=k.ts_basicInfo;switch(a){case 0:history.back();break;case 1:case 2:if(b.prior_info_chk!==!0)return;f.setLocalStorage("TALK_SHOP_basicInitiated","Y"),b.initiated=!0,k.showHideBIPop(!1),E()}},k.showHideBIPop=function(a){k.ts_basicInfo.showGuideInfo=!1,a===!0?(k.ts_basicInfo.showBasicInfo=!0,b.element("body").addClass("ts_basic_pop")):(k.ts_basicInfo.showBasicInfo=!1,b.element("body").removeClass("ts_basic_pop"),i(function(){Q(!0)},10))},k.showHideGuidePop=function(a){k.ts_basicInfo.showBasicInfo=!1,b.element("body").removeClass("ts_basic_pop"),a===!0?k.ts_basicInfo.showGuideInfo=!0:k.ts_basicInfo.showGuideInfo=!1},k.goHistoryBack=function(){history.back()},k.talkRecomDelegate=function(){if(0!=arguments.length){var a=[].slice.call(arguments),c=a.shift(),d={command:c,step:k.ts_currentStep,text:a[0],prod_grp_id:k.ts_currentGroup,goods_no:k.ts_currentGoodsNo,order_no:k.ts_currentOrderNo};k.isValidArray(k.ts_goodsList)&&(d.goods_no_list=k.ts_goodsList.join(","));var e=b.extend(Ia,d);F(e)}},k.goPrevStep=R;var Ra={"&lt;":"<","&gt;":">"},Sa=new RegExp(Object.keys(Ra).join("|"),"gi");a.talkOrderCallBack=ca,k.paymentSuccess=function(a){k.ts_currentOrderNo=a,k.talkRecomDelegate("sendSpeech","결제완료")},k.paymentFail=function(a,b){k.alert_2016("["+a+"] "+b),R()},k.selectProdGroup=function(a){k.talkRecomDelegate("sendSpeech",a.title+" 주문해줘")},k.selectProduct=function(a){k.talkRecomDelegate("sendSpeech",a+"번 주문해줘")},k.closeOrderLayer=function(){b.element("#tsol_iframe").prop("src","about:blank"),R()},k.closeIntroPop=function(a){document.getElementById("tsi_mov").pause(),a===!0&&f.setLocalStorage("TALK_SHOP_noMoreIntro","Y"),f.setSessionStorage("TALK_SHOP_closeIntro","Y"),q()},k.ts_playVideo=function(){b.element(".ts_intro .tsi_mov").addClass("playing"),document.getElementById("tsi_mov").play()},k.setSTTText=function(a,c){b.isString(a)&&(k.ts_stt.text=a)},a.setSTTText=k.setSTTText,k.callAppAPI=function(b,c){var d,e="talkshop://"+b,f="?";for(d in c)e+=f+d+"="+c[d],f="&";console.log("▷▷▷▷▷ ",e),k.appObj.isApp&&(a.location.href=e)},k.micClick=function(){0!=k.ts_micStat.inited&&(k.ts_micStat.open?ia():fa())},a.ttsEndCallback=oa,e.promiseLoginInfo()["finally"](function(a){p()})}}}])}(window,window.angular);