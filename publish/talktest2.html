<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head>
<title>LOTTE.COM</title>
<meta charset="UTF-8">
<meta http-equiv="cache-control" content="no-cache"/>
<meta http-equiv="expires" content="0"/>
<meta http-equiv="pragma" content="no-cache"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
<meta name="format-detection" content="telephone=no">
<link rel="apple-touch-icon-precomposed" href="/images/common/icon/bookmark_and.ico">
<link rel="apple-touch-icon" href="/images/common/icon/bookmark_iso.png">
<script>
var userId = "charisema";
var schema = "";
var dubCallProc = false;
var onceAction = true;
var onceAction2 = true; //이전내역 불러오기 한번 체크
var scrollHoldForImage = true;
var ua_script = "-1";
var isAppForTalk_script = "-1";
var isAppForTalk2_script = "-1";
var isMostVerForTalk_script = "-1";
var isMultiCheckComplete = false;
var getNewMessageBlock = false;
var sur_div_class = "satisfaction_pop";
var curr_page_node_id = ""; // 현재 페이지 node_id
</script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/jquery-1.11.3.min.js"></script>
<link rel="stylesheet" type="text/css" href="http://m.lotte.com/chat/css/chat_service_v2.css">
<script type="text/javascript" src="http://m.lotte.com/chat/js/EGSlider_20150707_v1.js"></script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/gateway/org/cometd.js"></script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/gateway/org/cometd/ReloadExtension.js"></script>
<!--  <script type="text/javascript" src="js/gateway/jquery/jquery-1.7.2.js"></script>-->
<script type="text/javascript" src="http://m.lotte.com/chat/js/gateway/jquery/json2.js"></script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/gateway/jquery/jquery.cookie.js"></script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/gateway/jquery/jquery.cometd.js"></script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/gateway/jquery/jquery.cometd-reload.js"></script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/gateway/gateway.js"></script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/spectra/talk/talkGateway.js?dummy=11111"></script>
<script type="text/javascript" src="http://m.lotte.com/chat/js/spectra/common/common.js"></script>
<!-- cloud[S] -->
<script type="text/javascript" src="http://m.lotte.com/chat/js/jquery.form.js"></script>
<!-- cloud[E] -->
<script src="http://m.lotte.com/chat/js/action_v2.js"></script>
<script type="text/javascript">
var defaultDomain = "https://m.lotte.com";
var isPhone = "true";
var talkPreUrl = "";
if(schema != ""){//앱이면서 최신버전이면
	talkPreUrl = "talk://";
}
//gateway broken일때 메시지 가져오기
var timer = setInterval(function(){
	if(!isGetMessage3Ing){
		fn_getMessage();
	}
},3000);
//-- cloud 추가 [S]
var holdScroll = true;
var diffScrollHeight = 0;
var prevScrollHeight = 0;
var prevHistoryCnt = 0;
var cartInfoJson = '';
var orderInfoJson = '';
$(document).ready(function(){
	//진입시 로그인 처리
	if(userId == ""){
		self.location.href = "https://m.lotte.com/login/loginForm.do?c=mlotte&udid=&v=&cn=&cdn=&targetUrl=" + encodeURIComponent(window.location.href,'UTF-8');
	}
	curr_page_node_id = node_id;
	fn_getTalkHistory();//상담내역 불러오기
	$("#msg").focus();
	fn_loadEmoticon();//이모티콘 호출
});
//이명규 20171113
var nativeAppInfo = {
		isApp : false,
		isSKT : false,
		isAndroid : false,
		isIOS : false,
		isIPhone : false,
		isIPad : false,
		versionNum : 0
};
var ua = (navigator.userAgent).toLowerCase();
var uaStr = ua,
 versionChk = uaStr.match(/(mlotte001|mlotte003|sklotte001)\/([0-9\.])+/gi),
 versionNum = 0;
//console.log("uaStr-->"+ uaStr);
//console.log("versionChk-->"+ versionChk);
if (versionChk && versionChk.length > 0) {
 versionNum = parseInt(versionChk[0].replace(/(mlotte001|mlotte003|sklotte001)\/|\./gi, ""));
}
//console.log("versionNum-->"+ versionNum);
nativeAppInfo.versionNum = versionNum;
/**
* Native 앱 여부 확인
* mlotte001 : 닷컴 AOS/iPhone
* sklotte001 : 닷컴(SKT) AOS
* mlotte003 : 닷컴 iPad
**/
nativeAppInfo.isApp = /mlotte001|sklotte001|mlotte003/gi.test(ua);
nativeAppInfo.isSKT = /sklotte001/gi.test(ua);
//Native APP 여부가 아닌 OS 구분
nativeAppInfo.isAndroid = /android/gi.test(ua);
nativeAppInfo.isIOS = /iphone|ipad/gi.test(ua);
nativeAppInfo.isIPhone = /iphone/gi.test(ua);
nativeAppInfo.isIPad = /ipad/gi.test(ua);
//console.log("nativeAppInfo.isApp-->"+ nativeAppInfo.isApp);
//console.log("nativeAppInfo.isSKT-->"+ nativeAppInfo.isSKT);
//console.log("nativeAppInfo.isAndroid-->"+ nativeAppInfo.isAndroid);
//console.log("nativeAppInfo.isIOS-->"+ nativeAppInfo.isIOS);
//console.log("nativeAppInfo.isIPhone-->"+ nativeAppInfo.isIPhone);
//console.log("nativeAppInfo.versionNum-->"+ nativeAppInfo.versionNum);
var isNativeHeader = false;
if((nativeAppInfo.isIOS && nativeAppInfo.versionNum >= 2800) || (nativeAppInfo.isAndroid && nativeAppInfo.versionNum >= 290  && !nativeAppInfo.isSKT)) {
 isNativeHeader = true;
}
//console.log("isNativeHeader111-->"+ isNativeHeader);
//이명규 20171113 END 
//이명규 뒤로가기 작업 20161215
	function goBack(){
	//$("#goBack").on("click", function(e){
		//e.preventDefault();
		//console.log("isNativeHeader-->"+ isNativeHeader);
		if(isNativeHeader) {
         appSendBack();
	    } else {
	        history.go(-1);
	    }
	}
//이명규 20171113
function appSendBack() {
       setTimeout(function () {
    	   //console.log("back--nativeAppInfo.isApp-->"+ nativeAppInfo.isApp);
           if (nativeAppInfo.isApp) { // 앱일 경우
        	   //console.log("back--nativeAppInfo.isAndroid-->"+ nativeAppInfo.isAndroid);
        	   if (nativeAppInfo.isAndroid) { // AOS
                   try {
                      window.lottebridge.back()
                   } catch(e) {}
               } else { // iOS
                     location.href = 'lottebridge://back';
               }
           }
       },500);
}
$(window).load(function(){
	//-- cloud 추가 [S]
	$(window).scroll( function() {
		//alert("window.scroll");
		if(scrollHoldForImage){
			if ($(document).height() - $(window).scrollTop() >= $(document).height())
			{
				prevScrollHeight = $(document).height();
	//			alert("prevScrollHeight:"+prevScrollHeight);
				var checkHistorySplit = $("#historyTalkId").val().split(",");   
				if($("#historyTalkId").val() != ''){
					if(prevHistoryCnt <= checkHistorySplit.length){
						holdScroll = false;
						//중복호출 제외 true값이면 현재 호출중인상태
						if(!dubCallProc){
							dubCallProc=true;
							$("#chatLoading").attr("class","loading");
							setTimeout("fn_getHistoryGet()",500);	
						}
					}else{
						holdScroll = true;
					}
				}
			}else{
				if($(window).scrollTop() + $(window).height() == $(document).height()) {
					$("#nowMsgDiv").hide();
				}
				holdScroll = true;
			}
		}
		//-- TODO 전송버튼 누르면 holdScroll = true; 코드 추가
	});
	//-- cloud 추가 [E]
	//$("a").click(function (event){
	//	event.preventDefault(); // a 태크 # 방지
	//});
});
function scrollBottomMove(){
	$("html, body").animate({scrollTop: 60000}, "slow" );
}
function scrollBottomMove2(){
	$("html, body").animate({scrollTop: $("#chat").height()}, 0 );
}
//connection 끊겼을 때 메시지 가져오기
function fn_getMessage(){
	var connectionYn = $("#connectionYn").val();
	  if(connectionYn == 'N' && $("#getTalkId").val() != ""){
		  if (!document.hidden) {
			  if(!isGetMessage3Ing){
				  fn_getMessage2();	
			  }
			}
	  }
}
/* ******************************************
환경설정 정보 조회 (확인용)
******************************************* */
function fn_getEnvValue(){
	var mForm = document.frm; 
	var obj = new Object(); 
	command = "CommonEnvValue";
	obj.command = command; 
	obj.domain_id = domain_id;
	obj.service_type = service_type;
	obj.item_list = "TLK_CUSTOMER_ATTACH_USE_FLAG,TLK_CUSTOMER_ATTACH_MAX_SIZE,TLK_CUSTOMER_ATTACH_EXT_LIST,COM_CUSTOMER_ATTACH_DOWNLOAD_URL";
	var cmd = JSON.stringify(obj); 
	mForm.cmd2.value = cmd;
	var param = "cmd=" + cmd;
	var result_list = "";
	var request = $.ajax({
	 url:"/proxy", //url:url,
	 type:"POST",
	 data: param,
	 dataType:"json"
	});
	request.done(function(result){ 
	 if (result != null){
	  if (result.error_code == 0) { 
		  var data_message = new Object();
			data_message = result.data;
		  var env_list = [];
		      env_list = data_message.env_list;
		  var id = "";
		  var value = "";
		  //상담사 대표 이미지
		  var img_flag = "";
		  var img_url = "";
		  var img_type = "";
		  var img_fath = "";
		  for(var i=0; i < env_list.length; i++){
			  id = env_list[i].id;
			  value = env_list[i].value;
			  if(id == 'KNW_URL_TITLE'){
				  $("#knwTitle").val(value);
			  }
		  }
	  }else if(result.error_code == -49999){  //비로그인 관련 추가_20151117
		fn_goLogin();			
	  }else{ 
	   	//존재하는 데이터 없음
	  }
	 }
	});
	request.fail(function(jqXHR, textStatus){ // 에러 발생
	});	
}
/* ******************************************
금칙어 조회
******************************************* */
function fn_getRestrictedWord(){
	var mForm = document.frm; 
	var obj = new Object(); 
	command = "TalkRestrictedWord";
	obj.command = command; 
	obj.domain_id = domain_id;
	obj.service_type = service_type;
	var cmd = JSON.stringify(obj); 
	mForm.cmd2.value = cmd;
	var param = "cmd=" + cmd;
	var result_list = "";
	var request = $.ajax({
	 url:url,
	 type:"POST",
	 data: param,
	 dataType:"json"
	});
	request.done(function(result){ 
	 if (result != null){
		  if (result.error_code == 0) { 
				var data_message = new Object();
					data_message = result.data;
				var word_count = data_message.word_count;
				var word = [];
				    word = data_message.word;
				var wordList = "";
				for(var i = 0; i < word_count; i++){
				  wordList += word[i] + ",";
			  	}
		  		$("#restrictedWord").val(wordList);
		  }else{ 
			  //alert('금칙어 없음');
		  }
	 }
	});
	request.fail(function(jqXHR, textStatus){ // 에러 발생
		//alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
	});	
}
var isPossibleTp = true;
/* ******************************************
 상담가능 체크 (멀티)
******************************************* */
function fn_timeCheck(){
var mForm = document.frm; 
var obj = new Object(); 
command = "TalkMultiCheck";
subcommand = "isWorkTime,isBlockStatus,isUpToWaitingCustomer";
obj.command = command; 
obj.domain_id = domain_id;
//obj.service_type = "SVTBM";
obj.service_type = service_type;
obj.subcommand = subcommand;
obj.in_channel_id = in_channel_id;
var cmd = JSON.stringify(obj); 
mForm.cmd2.value = cmd;
var param = "cmd=" + cmd;
var result_list = "";
var request = $.ajax({
 url: url ,
 type:"POST",
 data: param,
 dataType:"json",
 success:function(result){
	 if (result != null){
		if (result.error_code == 0) {
			var data_message = new Object();
				data_message = result.data;
			var isBlockStatus = new Object();
			    isBlockStatus = data_message.isBlockStatus;
			var isBlockStatus_yn = "";
			//상담원 인입차단여부
			if(isBlockStatus.error_code == 0){
				isBlockStatus_yn = "N";
			}else{
				isBlockStatus_yn = "Y";
			}
			var isUpToWaitingCustomer = new Object();
			isUpToWaitingCustomer = data_message.isUpToWaitingCustomer;
			var isUpToWaitingCustomer_yn = "";
			//최대대기수 
			if(isUpToWaitingCustomer.error_code == 0){
				isUpToWaitingCustomer_yn = "Y";
			}else{
				isUpToWaitingCustomer_yn = "N";
			}
			var isWorkTime = new Object();
				isWorkTime = data_message.isWorkTime;
			var isWorkTime_data = new Object();
				isWorkTime_data = isWorkTime.data;
			var is_work_time = "";
			//상담가능시간 체크
			if(isWorkTime_data.is_work_time){
				is_work_time = "Y";
			}else{
				is_work_time = "N";
			}
			var working_msg = new Object();
				working_msg = isWorkTime_data.WORKTIME_MSG;
			//상담시간 시작
			var timeDiff = working_msg.timeDiff;
			var fromDate = working_msg.fromDate;
			    fromDate = fromDate.substring(0,2) + ":" + fromDate.substring(2,4);
			    $("#onFromTime").val(fromDate);
			var timeZone = working_msg.timeZone;
			//상담시간 끝
			var toDate = working_msg.toDate;
				toDate = toDate.substring(0,2) + ":" + toDate.substring(2,4);
				$("#onEndTime").val(toDate);
			$("#output").text('');
		  //상담가능
		  if (true || is_work_time == "Y" && isBlockStatus_yn == 'N' && isUpToWaitingCustomer_yn == 'Y') { 
					  result_list +="<p>반갑습니다, 고객님! 롯데닷컴 톡 입니다.</p>";
					  result_list +="<p>우측 하단의 <span class=\"blue\">[상담신청] 또는 메시지를 입력</span>해 주시면 톡 상담이 시작됩니다.</p>";
				  result_list +="<p>오늘도 활기찬 하루 되세요.</p>";
				  result_list +="<p>감사합니다.</p>";				  
			  	  result_list += "<a href=\"#none\" class=\"close\" onClick=\"javascript:chatCloseWin2ForChat('divLayChatNoti', 1);\">닫기</a>";
			  $("#chatInput").attr("style" ,"display:block");
			  //금칙어 조회
			  fn_getRestrictedWord();
			  $("#sendBtn").html("상담<br/>신청");
			  $("#sendBtnSee").html("상담<br/>신청");
			//전송버튼 가능하도록 처리
			$("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
			  //$("#talkEndBtn").attr("style","display:none");
			  var blnCookie2ForChat	= getCookieForChat( "divLayChatNoti" );
		      if( blnCookie2ForChat != "done" ) {
				$("#head").find("> h1 > a").addClass("on02");
				$("#head").find("> .layer_info").show();
			  }
		  //상담가능시간이지만 상담사가 인입차단했음
		  } else if(is_work_time == "Y" && (isBlockStatus_yn == 'Y'|| isUpToWaitingCustomer_yn == 'N')){
			  isPossibleTp = false;
			  var insertLog = isUpToWaitingCustomer_yn == 'N' ? true : false;
					  result_list +="<p>안녕하세요, 고객님. 롯데닷컴 톡 입니다.</p>";
				  result_list +="<p>현재 톡 상담 이용고객이 많아 상담이 어렵습니다.</p>";
				  result_list +="<p><span class=\"red\">[1:1문의하기]로 접수</span>해 주시면 신속히 답변 드리겠습니다. </p>";
				  result_list +="<p>감사합니다.</p>";
				  result_list +="<div class=\"btn\">";
				  //result_list +="<a href=\"#none\" onClick=\"fn_goCustomer();\">1:1 문의하기</a>";
				  result_list +="<a href=\"#none\" onClick=\"fn_goCustomer(" + insertLog + ");\">1:1 문의하기</a>";
				  result_list +="</div>";
				  result_list += "<a href=\"#none\" class=\"close\" onClick=\"layerClose();\">닫기</a>";
				  var outMessage = "<p class=\"no_info\">잠시 상담원과 연결이 불가능 합니다.</p>";
				  $("#chatInput").html(outMessage);
				  $("#head").find("> h1 > a").addClass("on02");
			      $("#head").find("> .layer_info").show();
		  //그외
		  }else {
			  isPossibleTp = false;
					  result_list +="<p>안녕하세요, 고객님. 롯데닷컴 톡 입니다.</p>";
			   result_list +="<p>지금은 톡 상담시간이 아닙니다.</p>";
			   result_list +="<p><span class=\"red\">[1:1문의하기]로 접수</span>해 주시면 신속히 답변 드리겠습니다.</p>";
			   result_list +="<p>감사합니다.</p>";
			   result_list +="<div class=\"counsel_time\">";
			   result_list +="<h2>상담시간 안내</h2>";
			   result_list +="<table>";
			   result_list +="<tr>";
			   result_list +="<th>평일</th>";
			   result_list +="<th>토요일</th>";
			   result_list +="<th>일/공휴일</th>";
			   result_list +="</tr>";
			   result_list +="<tr>";
			   result_list +="<td>09~18시</td>";
			   result_list +="<td>09~13시</td>";
			   result_list +="<td>휴무</td>";
			   result_list +="</tr>";
			   result_list +="</table>";
			   result_list +="</div>";
			   result_list +="<div class=\"btn\">";
			   result_list +="<a href=\"#none\" onClick=\"fn_goCustomer();\">1:1 문의하기</a>";
			   result_list +="</div>";
			   result_list += "<a href=\"#none\" class=\"close\" onClick=\"layerClose();\">닫기</a>";
			   //$("#chatInput").attr("style" ,"display:none");
			   var outMessage = "<p class=\"no_info\">지금은 톡 상담시간이 아닙니다.</p>";
			   $("#chatInput").html(outMessage);
			   $("#head").find("> h1 > a").addClass("on02");
			   $("#head").find("> .layer_info").show();
		  }
		  //로그 시작
		  fn_setOkLog( !isPossibleTp );
		  $("#output").append(result_list);
		    if(cartInfoJson.length > 0){
				fn_send(cartInfoJson);
				cartInfoJson = "";
			}
		    if(orderInfoJson.length > 0){
				fn_send(orderInfoJson);
				orderInfoJson = "";
			}
		}else if(result.error_code == -49999){  //20151117_비로그인 처리_추가
			fn_goLogin();
	    }else{
	    }	
	 }
	 isMultiCheckComplete = true;
	 //- cloud [S]
	 //- cloud [E]
 },
 error:function(){
	 //alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
 }
});
request.done(function(result){
});
request.fail(function(jqXHR, textStatus){ // 에러 발생
	//alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
});
}
/* ******************************************
기존에 진행중이던 상담이 있는지를 체크
******************************************* */
function fn_getTicket(){
	onceAction = false;
	var mForm = document.frm; 
	var obj = new Object(); 
	command = "TalkCheck";
	//subcommand = "getTicketByCustomerId";
    subcommand = "isUpToActiveCustomer";
	obj.command = command; 
	obj.domain_id = domain_id;
	obj.service_type = service_type;
	obj.subcommand = subcommand;
	obj.customer_id = customer_id;
	var cmd = JSON.stringify(obj); 
	mForm.cmd2.value = cmd;
	var param = "cmd=" + cmd;
	var result_list = "";
	var request = $.ajax({
	 url: url,
	 type:"POST",
	 data: param,
	 dataType:"json",
	 contentType: "application/x-www-form-urlencoded;charset=utf-8",
	 success:function(result){
		 if (result != null){ 
		  //기존 상담중이던 티켓이 있는
		  if (result.error_code == 1003) { //티켓이 존재
			  var data_message = new Object();
				  data_message = result.data;
			  if (curr_page_node_id!=data_message.node_id){ // 다른 노드아이디 상담중인지 체크				  
				  var confirm_msg = (data_message.node_id=="NODE0000000004"?"스마트 톡상담을 진행하고 계시네요~\n톡상담과 톡추천은 동시 이용이 어렵습니다.\n\n진행 중인 톡상담을 종료할까요?":"스마트 톡추천을 진행하고 계시네요~\n톡추천과 톡상담은 동시 진행이 어렵습니다.\n\n진행 중인 톡추천을 종료할까요?");
				  if (confirm(confirm_msg)){
					  $("#getTalkId").val(data_message.ticket_id);
					  fn_talkEnd(true);
				  }else{
					  goChatOut(); // back;
				  }
			  }
			  var log_client_id = data_message.log_client_id;
			  var service_type = data_message.service_type;
			  var ticket_id = data_message.ticket_id;
			  var node_id = data_message.node_id;
			  //공지사항 불러와서 노출...
			  $("#output").text('');
			  //롯데닷컴
			         result_list +="<p>반갑습니다, 고객님! 롯데닷컴 톡 입니다.</p>";
			         result_list +="<p>우측 하단의 <span class=\"blue\">[상담신청] 또는 메시지를 입력</span>해 주시면 톡 상담이 시작됩니다.</p>";
			         result_list +="<p>오늘도 활기찬 하루 되세요.</p>";
			         result_list +="<p>감사합니다.</p>";
			  		 result_list += "<a href=\"#none\" class=\"close\" onClick=\"layerClose();\">닫기</a>";
			      $("#output").append(result_list);
				  //$("#chat_ok").attr("style" ,"display:block");
				  $("#chatInput").attr("style" ,"display:block");
				  //입력중일때 공지사항 안보이게 처리
				  $("#head").find("> h1 > a").removeClass("on"); 
				  $("#head").find("> .layer_info").hide(); 
			  //금칙어 조회
			  fn_getRestrictedWord();
			    $("#sendBtn").html("전송");
			    $("#sendBtnSee").html("전송");
			    $("#getTalkId").val(ticket_id);
				//$("#talkEndBtn").attr("style","display:block");
				//$("#chat_ok").attr("style","display:block");
				$("#chatInput").attr("style" ,"display:block");
				loadConnection();
				fn_getTalkContentsIng(ticket_id ,'ING'); 
				//fn_getTalkContents(ticket_id ,'ING'); 
				onceAction = false;
				//fn_getMessage2();
				//$("#chatIng").attr("style","display:block");				
				isMultiCheckComplete = true; // fn_timeCheck() [상담가능 체크 가능 시]
		  }else{ //티켓이 없음 (상담신청 버튼으로 보여줌)
			  onceAction = false;
			  fn_timeCheck();//상담가능체크 
			  //$("#msg").focus();
		  }
		 }
	 },
	 error:function(result){
	 }
	});
	request.done(function(result){
	});
	request.fail(function(jqXHR, textStatus){ // 에러 발생
		//alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
	});	
}
/* ******************************************
상담신청 시작 (메시지 전송)
******************************************* */
var isEmoAndTextEnable = false;
var isEmoOnlyEnable = false;
function fn_send(infoJson, rop_obj, opt_idx){
	var set_focus = (typeof rop_obj!="undefined"?false:true); // 포커스 set 여부
	$("#chatLoading2").attr("class","attach_loading");
	var message_list = "";
	var msg = $("#msg").val();
	console.log("===========");
	console.log("msg="+msg);
	    msg = msg.trim(); //공백제거
	  //xss 스크립트 문자열 방지
	    //msg = msg.replace(/\&/gi,"&amp;");
	    //msg = msg.replace(/\</g, "&lt;");
	    //msg = msg.replace(/\>/g, "&gt;");
	    //msg = msg.replace(/\,/gi,"&quot;");
	    //msg = msg.replace(/\(/g, "&#40;");
	    //msg = msg.replace(/\)/g, "&#41;");
	    if(infoJson != null){
	    	msg = infoJson;
	    }
	var restrictedWord = $("#restrictedWord").val();
	/*
	//개인정보 관련 번호가 있는지 체크 (연속적인 숫자가 있는지로 구분?!)
	var check_cnt = 0; 
	for(var k = 0; k < message.length; k ++){
		var check_msg = message.substring(k,k+1);
		var result_msg = $.isNumeric(check_msg);
		if(result_msg){
			check_cnt++;
		}else{
			check_cnt = 0;
		}
		if(check_cnt > 9){
			alert('개인정보에 유의해주세요.');
			return;
		}
	}
	*/
	//금칙어 체크
	var check_word = restrictedWord.split(",");
	//var msgCh = msg.replace(/ /g, '');
	for(var  j = 0; j < check_word.length -1 ; j ++){
		if(msg.indexOf(check_word[j]) >= 0){
			//alert("입력한 내용에 금칙어가 포함되어 전송이 불가합니다. \n금칙어를 삭제한후 다시 전송하시기 바랍니다.");
			alert("사용할수 없는 단어가(금칙어)가 포함되어 있습니다. \n금칙어를 삭제한후 다시 전송하시기 바랍니다.");
			$("#chatLoading2").attr("class","attach_loading none");
			return;
		}
	}
	//alert('start');
	//창닫기안내레이어 쿠키설정
	var blnCookieForChat	= getCookieForChat( "divLayChatOutPopup" );
	if( blnCookieForChat != "done" ) {
		if($("#sendBtn").html() == "상담<br>신청"){
			$("#head").find("> ul > li.out").attr("class","out on01");
			setTimeout("divOutLayerClose()",5000);
		}
	}else{
		$("#head").find("> ul > li.out").attr("class","out on02");
	}
	if($("#sendBtn").html() == "상담<br>신청"){
		if (!isMultiCheckComplete)
		{
			return;
		}
		var mForm = document.frm; 
		var obj = new Object();  //기본적인 오브젝트
		var obj2 = new Object(); //이모티콘하고 문자 같이 전송시 쓰일 오브젝트
		var url_con = "";
		command = "TalkStart";
		var message = "";
		if($("#msg").val().trim() == ""){
			message = "상담을 신청합니다";
		}else{
			message = msg;
		}
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.service_type = service_type;
		obj.node_id = node_id;
		obj.in_channel_id = in_channel_id;
		obj.customer_id = customer_id;
		obj.message = message;
		//관리자 통계화면을 위한 데이터 수집 파라미터 추가
		obj.log_request_flag = "N";
		obj.log_request_fail_flag = "Y";
		obj.log_client_id = $("#log_client_id").val();
		//이모티콘하고 메시지 전송시 쓰임
		/*
		obj2.command = command; 
		obj2.domain_id = domain_id;
		obj2.service_type = service_type;
		obj2.node_id = node_id;
		obj2.in_channel_id = in_channel_id;
		obj2.customer_id = customer_id;
		obj2.message = message;
		*/
		obj2.command = command; 
		obj2.domain_id = domain_id;
		obj2.service_type = service_type;
		obj2.node_id = node_id;
		obj2.in_channel_id = in_channel_id;
		obj2.customer_id = customer_id;
		obj2.message = message;
		//관리자 통계화면을 위한 데이터 수집 파라미터 추가
		obj2.log_request_flag = "N";
		obj2.log_request_fail_flag = "Y";
		obj2.log_client_id = $("#log_client_id").val();
		//이모티콘 포함해서 전송할 때
		var emoticonYn = "";
		var emoticonName = $("#emoticonName").val();
		var emoticonInfo = $("#emoticonInfo").val();
		var message2 = ""; 
		if(emoticonInfo != null && emoticonInfo != ""){
			isEmoOnlyEnable = true;
			obj.emoticon_flag = 'Y';
			obj.title = '이모티콘';
			//emoticonInfo = emoticonInfo.replace(/\>/g, '');
			//emoticonInfo = emoticonInfo.replace(/\</g, '');
			//emoticonInfo = emoticonInfo.replace(/\n/g, '');
			//emoticonInfo = emoticonInfo.replace('%0A', '');
			//emoticonInfo = emoticonInfo.replace('<br>', '');
			//emoticonInfo = emoticonInfo.replace(/\%0A/g, '');
			if($("#msg").val() != ""){
				message2 = $("#msg").val();
				obj2.message = message2;
			}
			obj.message = "?fileInfo=" + emoticonInfo;
		}
		//첨부파일 있을 때
		var fileAttach = $("#" + fileType).val();
		var attach_flag = "";
		if(fileType != "" && fileAttach !="" ){
			//alert('파일있음');
			obj.attach_flag = 'Y';
			attach_flag = 'Y';
			obj.title = '첨부파일';
			obj.message = "";
		}
		var cmd = JSON.stringify(obj); 
		console.log(cmd);
		//alert("12345:"+cmd);
		/*
		if(cmd.length > 800){
			//alert('전송할 메시지는 800자를 넘을 수 없습니다.');
			return;
		}
		*/
		//이모티콘하고 메시지 동시 전송시 사용
		var cmd2 = JSON.stringify(obj2); 
		/*
		if(cmd2.length > 800){
			alert('전송할 메시지는 800자를 넘을 수 없습니다.');
			return;
		}*/
		$("#cmd").val(cmd);
		var frm = $("#frm");
		var result_list = "";
		if(attach_flag == 'Y'){//첨부파일이 있을때
			url_con = url +"?domain_id=" + domain_id +"&service_type="+service_type + "&customer_id="+customer_id +"&cmd=" + cmd;
		}else{ //첨부파일이 없을때
			url_con = url;
		}
		if(attach_flag == 'Y'){ //첨부파일이 있을 때 
			$("#frm").attr("action",url_con);
			$("#frm").ajaxSubmit({
				 dataType:'json',
				  success: function(result) {
	             if (result != null){
	    			if (result.error_code == 0) {	    				
						var data_message = new Object();
							data_message = result.data;
						var talk_id = data_message.talk_id;
						var message = [];
							message = data_message.messages;
						var customer_read_flag = "";
						var type = "";
						var seq = "";
						var msg = "";
						var flag = "";
						var agent_read_flag = "";
						var cdate = "";
						var ctime = "";
						var sender = "";
						var cdate_ch = ""; //상단 날짜가 중복되지 않았는지 체크
						var senderGubun = ""; //발신인 구분
						//메시지 유형이 link_msg일때 처리할 변수들(장바구니, 지식상담.. 등등)
						var link_msg = new Object(); 
						var link_type = "";
						var link_icon = "";
						var link_title = "";
						var link_message = "";
						var link_titleUrl = "";
						var link_linkUrl = "";
						var link_imgUrl = "";
						//상담사 이미지
					    var img_path = "";
					    var img_url = "";
					    var downloadUrl = "";						
					  	//TAG_LINK 추가사용 cloud_20151028
						var link_option = "";
						var link_price = "";
						var link_orderStatus = "";
						var link_iconText = "";
						var link_priceColor = "";
						var link_statusColor = "";
						var link_orderNo = "";
						var link_productNo = "";
					    for(var i = 0; i < message.length; i++){
					    	var messageDivId = message[i].talk_id + "_" + message[i].seq;
							// 메시지 중복 방지 처리
							if ($("#" + messageDivId).length > 0)
							{
								continue;
							}
						  cdate_ch = $("#cdate_ch").val();
						  senderGubun = $("#senderGubun").val();
						  customer_read_flag = message[i].customer_read_flag;
						  type = message[i].type;
						  seq = message[i].seq;
						  msg = message[i].msg;
						//xss 스크립트 문자열 방지
						  //msg = msg.replace(/\&/gi,"&amp;");
						  //msg = msg.replace(/\</g, "&lt;");
						  //msg = msg.replace(/\>/g, "&gt;");
						  //msg = msg.replace(/\,/gi,"&quot;");
						  //msg = msg.replace(/\(/g, "&#40;");
						 //msg = msg.replace(/\)/g, "&#41;");
						  sender = message[i].sender;
						//메시지 유형이 link일때	
							if((msg.indexOf('type') > -1) && (msg.indexOf('title') > -1) && (msg.indexOf('message') > -1)){
								link_msg = JSON.parse(msg);
								link_type = link_msg.type;
								link_icon = link_msg.icon;
								link_title = link_msg.title;
								link_message = link_msg.message;
								link_titleUrl = link_msg.titleUrl+"";
								link_linkUrl = link_msg.linkUrl;
								link_imgUrl = link_msg.imgUrl;
								//cloud_20151028
								if(link_type == 'TAG_LINK'){
									link_option = link_msg.option;
									link_price = link_msg.price;
									link_orderStatus = link_msg.orderStatus;
									link_iconText = link_msg.iconText;
									link_priceColor = link_msg.priceColor;
									link_statusColor = link_msg.statusColor;
									link_orderNo = link_msg.orderNo;
									link_productNo = link_msg.productNo;
								}else{
									link_option = "";
									link_price = "";
									link_orderStatus = "";
									link_iconText = "";
									link_priceColor = "";
									link_statusColor = "";
									link_orderNo = "";
									link_productNo = "";
								}
							}else{
								link_type = "";
								link_icon = "";
								link_title = "";
								link_message = "";
								link_titleUrl = "";
								link_linkUrl = "";
								link_imgUrl = "";
								//cloud_20151028
								link_option = "";
								link_price = "";
								link_orderStatus = "";
								link_iconText = "";
								link_priceColor = "";
								link_statusColor = "";
								link_orderNo = "";
								link_productNo = "";
							}
						  //flag = message[i].flag;
						  flag = message[i].flag == "H"?"A":message[i].flag;
						  agent_read_flag = message[i].agent_read_flag;
						  if(agent_read_flag == 'Y' && flag == 'C'){
							  agent_read_flag = "읽음 ";
						  }else if(agent_read_flag == 'N' && flag == 'C'){
							  agent_read_flag = "1 ";
						  }else{
							  agent_read_flag = "";
						  }
						  cdate = message[i].cdate;
						  if(cdate.substring(8,10) < '12'){
							  ctime = "오전 " + cdate.substring(8,10) + ":" + cdate.substring(10,12);
						  }else{
							  if(cdate.substring(8,10) == '12'){
									ctime = "오후 " + parseInt(cdate.substring(8,10)) + ":" + cdate.substring(10,12);
							  }else{
							  		ctime = "오후 " + parseInt(cdate.substring(8,10)-12) + ":" + cdate.substring(10,12); 
							  }
						  }
						  var getDay = fu_getDay(cdate.substring(0,4), cdate.substring(4,6)-1 , cdate.substring(6,8));
						  cdate = cdate.substring(0,4) + "년 " + cdate.substring(4,6) + "월 " + cdate.substring(6,8) + "일 " + getDay;
						  if(cdate_ch != cdate){
						  	message_list += "<div class=\"date\"><p>"+ cdate + "</p></div>";
						  }
						  $("#cdate_ch").val(cdate);
						  if(flag == 'S'){
							  message_list += "<div id='" + messageDivId + "' class=\"message opp\"><div class=\"writer\">";
								//상담사 이미지
								/*
							  if($("#Agent_imgType").val() != ""){
								  if($("#Agent_imgType").val() == "FILE"){ //파일일때
									  img_path = $("#Agent_imgPath").val();
									  downloadUrl = $("#getUrl").val();
									  message_list += "<img src=\""+ downloadUrl + "?fileInfo=" + img_path +"&ticketId=ETC \" alt=\"LOTTE.COM\" /> ";
								  }else{ //URL일때
									  img_url = $("#Agent_imgUrl").val();
									  message_list += "<img src=\""+ img_url +  "\" alt=\"LOTTE.COM\" /> ";
								  }	  
							  }*/
							  message_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />";
							  message_list += "</div>";
							  agent_read_flag = "";
						  }else if(flag == 'A'){
								   message_list += "<div id='" + messageDivId + "' class=\"message opp\">";
									  if((senderGubun !="A" && $("#sameTimeCh_A").val() != ctime) || (senderGubun =="A" && $("#sameTimeCh_A").val() != ctime ) || (senderGubun !="A" && $("#sameTimeCh_C").val() == ctime)){
										  message_list += "<div class=\"writer\">";
								      //상담사 이미지
								      /*
										  if($("#Agent_imgType").val() != ""){
											  if($("#Agent_imgType").val() == "FILE"){ //파일일때
												  img_path = $("#Agent_imgPath").val();
												  downloadUrl = $("#getUrl").val();
												  message_list += "<img src=\""+ downloadUrl + "?fileInfo=" + img_path +"&ticketId=ETC \" alt=\"LOTTE.COM\" /> ";
											  }else{ //URL일때
												  img_url = $("#Agent_imgUrl").val();
												  message_list += "<img src=\""+ img_url +  "\" alt=\"LOTTE.COM\" /> ";
											  }	  
										  }*/
								        message_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />";
										message_list += ""+sender+" 상담원</div>";
									  }
									   agent_read_flag = "";	
						  }else if(flag == 'C'){
								  	message_list += "<div id='" + messageDivId + "' class=\"message me\">";
						  }
					  	  //메시지 타입에 따른 구분
					  	  if(type == 'MSG'){//일반 메시지(www도 포함)
					  		var format = new RegExp( '[\\w-]+(\\.[\\w-]+)+([\\w-.,@?^=%&:/~+#-]*[\\w@?^=%&;/~+#-])?' );					  	  
							if(format.test(msg) && link_type != 'TAG_LINK' && link_type != 'SELF_LINK' && link_type != 'URL_LINK' && link_type != 'KNW_LINK' ) {
						  		if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
					  				message_list += "<p class=\"text no_tail\" >";
					  			}else{
					  				message_list += "<p class=\"text\" >";
					  			}
						  		var msgR = "";	
						  		var followParam = "";
						  		if(msg.indexOf('lotte.com') > -1){
									if(msg.indexOf('?') > -1){
										followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
									}else{
										followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
									}
								}
						  		//메시지 타입에 따른 구분
					  			if(msg.indexOf('<br//>') > 0){//줄바꿈이 온경우
					  				var msgSplit1 = msg.split("<br//>");
					  				for(var lyh1=0;lyh1 < msgSplit1.length;lyh1++){
					  					if(msgSplit1[lyh1].indexOf(' ') > 0){//줄바꿈안에 공백이 있는경우
						  					var msgSplit2 = msgSplit1[lyh1].split(" ");
						  					for(var lyh2=0;lyh2 < msgSplit2.length;lyh2++){
						  						if(format.test(msgSplit2[lyh2])){
						  							if(msgSplit2[lyh2].indexOf('http://') < 0 && msgSplit2[lyh2].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit2[lyh2];
										  			}else{
										  				msgR = msgSplit2[lyh2];
										  			}
						  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  								message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit2[lyh2] + "<br></a>";
													}else{
														message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit2[lyh2] + "<br></a>";
													}
						  						}else{
						  							message_list += msgSplit2[lyh2];
						  						}
						  						message_list += " ";
						  					}
						  				}else{ //줄바꿈만 있는경우
						  					if(format.test(msgSplit1[lyh1])){
						  						if(msgSplit1[lyh1].indexOf('http://') < 0 && msgSplit1[lyh1].indexOf('https://') < 0){
										  			msgR = "http://" + msgSplit1[lyh1];
									  			}else{
									  				msgR = msgSplit1[lyh1];
									  			}
						  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  							message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit1[lyh1] + "<br></a>";
												}else{
													message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit1[lyh1] + "<br></a>";
												}
						  					}else{
						  						message_list += msgSplit1[lyh1];
						  					}
						  				}
					  					message_list += "<br>";
					  				}
					  			}else{ //줄바꿈 없음
					  				if(msg.indexOf(' ') > 0){ //공백이 있음
					  					var msgSplit3 = msg.split(" ");
					  					for(var lyh3=0;lyh3 < msgSplit3.length;lyh3++){
					  						if(format.test(msgSplit3[lyh3])){
					  							if(msgSplit3[lyh3].indexOf('http://') < 0 && msgSplit3[lyh3].indexOf('https://') < 0){
										  			msgR = "http://" + msgSplit3[lyh3];
									  			}else{
									  				msgR = msgSplit3[lyh3];
									  			}
					  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  								message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit3[lyh3] + "<br></a>";
												}else{
													message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit3[lyh3] + "<br></a>";
												}
					  						}else{
					  							message_list += msgSplit3[lyh3];
					  						}
					  						message_list += " ";
					  					}
					  				}else{ //공백이 없음
					  					if(format.test(msg)){
					  						if(msg.indexOf('http://') < 0 && msg.indexOf('https://') < 0){
									  			msgR = "http://" + msg;
								  			}else{
								  				msgR = msg;
								  			}
					  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  							message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msg + "<br></a>";
											}else{
												message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msg + "<br></a>";
											}
					  					}else{
					  						message_list += msg;	
					  					}
					  				}
					  			}
						  		message_list += "</p>";
						  	}else{
						  		//메시지 유형이 링크메시지이면
						  		if(link_type != ""){
						  		    if(link_type == 'TAG_LINK'){
						  		    	//cloud_20151028
						  		    	message_list += "<div class=\"text\">";
						  		    	message_list += "<p class=\"title\">"+link_title+"</p>";
						  		    	message_list += "<div class=\"prd_cont\">";
										var makeLinkUrl = "";
						  		    	if(link_orderNo != ""){ //주문정보
											if(makeLinkUrl == "INTERPARKTICKET"){
												message_list += "<a href=\"#\" onclick=\"alert('티켓 주문은 WEB(PC)를 통해 확인할 수 있습니다');\">";
											}else{
												makeLinkUrl = "/mylotte/purchase/purchase_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
								  		    	//message_list += "<a href=\"#\" onclick=\""+makeLinkUrl+"\">";
												if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
													message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
												}else{
													message_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
												}
											}
						  		    	}else{//장바구니 정보
						  		    		makeLinkUrl = "/product/product_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
							  		    	//message_list += "<a href=\"#\" onclick=\""+makeLinkUrl+"\">";
						  		    		if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
												message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
											}else{
												message_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
											}
						  		    	}
						  		    	message_list += "<div class=\"thumbnail\">";
						  		    	message_list += "<img src=\""+link_imgUrl+"\" alt=\"\" onError=\"this.src='http://image.lotte.com/lotte/images/common/product/no_150.gif'\" />";
										if(link_orderStatus != ""){
											message_list += "<span class=\""+link_statusColor+"\">"+link_orderStatus+"</span>";
										}
										message_list += "</div>";
										message_list += "<div class=\"detail\">";
										message_list += "<P class=\"name\">"+link_message+"</p>";
										if(typeof link_option!="undefined"){
											message_list += "<p class=\"option\">"+link_option+"</p>";
										}
										message_list += "<P>"+link_option+"</p>";
										message_list += "<P>"+link_price+"</p>";
										message_list += "</div>";
										message_list += "</a>";
										message_list += "</div>";
										message_list += "</div>";
						  		    }else if(link_type == 'SELF_LINK'){
						  		    	var followParam = "";
								  		if(link_linkUrl.indexOf('lotte.com') > -1){
											if(link_linkUrl.indexOf('?') > -1){
												followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
											}else{
												followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
											}
										}
						  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
						  		    		message_list += "<p class=\"text no_tail\" >";
							  			}else{
							  				message_list += "<p class=\"text\" >";
							  			}
						  		    	message_list += link_message;
						  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  		    		message_list += "<a  href=\"#\" onClick=\"appLoad('"+ link_title+"');return false;\">" + link_title + "</a>";
										}else{
											message_list += "<a href=\""+ talkPreUrl +link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
										}
						  		    	message_list += "</p>";
						  		    }else if(link_type == 'KNW_LINK'){
						  		    	//receive_list += link_message;
						  		    	//receive_list += link_icon ;
						  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  				message_list += "<p class=\"text no_tail\" >";
							  			}else{
							  				message_list += "<p class=\"text\" >";
							  			}
						  		    	if(link_message.indexOf('\n') > 0){
						  		    		link_message = (link_message+"").replace(/\n/gi,'<br//>');
										}
						  		    	message_list += link_message;
						  		    	var knw_link_msg = link_linkUrl.substring(link_linkUrl.indexOf('kbId=') + 5, link_linkUrl.length); //URL에서 kb_id를 가져옴
										var kb_id_url = decodeURIComponent(knw_link_msg);  // 가져온 kb_id를 디코딩
										//url은 나중에 바꿔야함...
						  		    	//message_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\"http://211.63.24.55/demo/jsp/kb/kb.jsp?kbId=" + kb_id_url +"\">" + link_title + "</a>";
						  		    	//message_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\"/chat/knowConsult.jsp?kbId=" + kb_id_url +"\">" + link_title + "</a>";
						  		      if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  		    		message_list += "<a class=\"opp_btn allview_btn\"  href=\"#\" onClick=\"appLoad('"+ defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url+"');return false;\">" + link_title + "</a>";
							  		  }else{
							  				message_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url + "&c=mlotte&udid=&v=&cn=&cdn= \">" + link_title + "</a>";
							  		  }
						  		    	message_list += "</p>";
						  		    }else if(link_type == 'URL_LINK'){
						  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
						  		    		message_list += "<p class=\"text no_tail\" >";
							  			}else{
							  				message_list += "<p class=\"text\" >";
							  			}
						  		    	//receive_list += link_message;
						  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  		    		message_list += "<a class=\"opp_btn back_btn\"  href=\"#\" onClick=\"appLoad('"+ defaultDomain+link_linkUrl+"');return false;\">" + link_title + "</a>";
							  		  }else{
							  				message_list += "<a target=\"_blank\" href=\""+ talkPreUrl + defaultDomain+link_linkUrl + "c=mlotte&udid=&v=&cn=&cdn=" +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
							  		  }
						  		    	message_list += "</p>";
						  		    }
						  		}else{
						  		//꼬리 없는 메시지
						  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
						  				message_list += "<p class=\"text no_tail\" >" + msg + "</p>";
						  			}else{
						  				message_list += "<p class=\"text\" >" + msg + "</p>";
						  			}
						  		}
						  	}
					  	  }else if(type == 'URL'){//첨부파일
					  		var ext = message[i].ext;
						    var filename = message[i].ext;  
						    //첨부파일 확장자 구분
						    var format01 = "\.(bmp|gif|jpg|jpeg|png|tif)$"; //이미지
						    var format02 = "\.(mov|mp4|wmv|3gp)$"; //동영상
						    var format03 = "\.(amr|mp3|m4a|ogg|3gpp)$"; //음성파일
						    var defaulImg = "http://image.lotte.com/lotte/mobile/chat_service/@temp_stop.png"; 
						  	if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
						  	//var fileInfo = msg.substring(msg.indexOf("fileInfo") + 9, msg.length);
						  		message_list +="<div class=\"thumbnail\">";
						  		//receive_list +="<a href=\"#none\" onClick=\"fn_imgPop('"+ msg+"')\">";
						  		message_list +="<a href=\"#none\" onClick=\"fn_imgPop(this,'"+msg+"');return false;\">";
						  		message_list +="<img src=\""+ msg +  "\" alt=\"\" onError=\"this.src=\'"+defaulImg+"'\" />";
						  		message_list +="</a>";
						  		message_list +="</div>";
						  		//receive_list +="<img src=\"http://211.63.24.55:443/enomix/common/DownloadAttach.ee?fileInfo="+ fileInfo +  "\"/></a>";
						  	}
						  	if((new RegExp(format02, "i")).test(ext)){ //동영상 일때
						  		message_list += "<div class=\"movie\">";
						  	//-------------------앱개발 완료 후 주석 해제 ----------------
						  		//message_list += "<a href=\""+ talkPreUrl + msg+ "\">";/*[2016.01.28 주석해지]*/
						  		message_list += "<a href=\"#\" onClick=\"go_MplayStop();return false;\">";/*[2016.01.28 주석처리]*/
						  		message_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/@temp_play.png\" alt=\"\" />";
						  		message_list += "</a>";
						  		message_list += "</div>";
						  	}
						  	if((new RegExp(format03, "i")).test(ext)){ //음성파일 일때
						  		 //아이폰 일때 
						  		message_list += "<p class=\"text\" ><a  href=\"#none\" onClick=\"fn_unLoadV()\" class=\"voice_btn\">";
						  		message_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/icon_voice_btn.png\" alt=\"\" />";
						  		message_list += "</a></p>";
						  		//receive_list += "<a target=\"_blank\" href=\'" + msg+ "'\">" + msg + "</a>";
						  	}
					  	  }else if(type == 'EMO'){//이모티콘
					  		//var fileInfo = msg.substring(msg.indexOf("fileInfo") + 9, msg.length);
					  		message_list += "<div class=\"thumbnail\">";
					  		message_list += "<img style=\"width:100px;height:100px;\" src=\""+ msg +  "\"/>"; 
					  		message_list += "</div>"; 
					  	  }else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
					  		message_list += msg + "<br>";
						  	message_list +="**************<br>";
						  	message_list += "<a href=\"#\" onclick=\"fn_getSuerveyList()\" > 상담만족도 평가 > </a>";
						  }else if(type == 'KNW'){ //지식상담
							var knw_msg = msg.substring(msg.indexOf('kbId=') + 5, msg.length); //URL에서 kb_id를 가져옴
							var kb_id = decodeURIComponent(knw_msg);  // 가져온 kb_id를 디코딩
							//fn_getBContents(kb_id); //상담지식 컨텐츠 가져오기
							var knw_title = $("#knwTitle").val();
							message_list += "======================<br>";
							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  		message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain + msg+"');return false;\">" + knw_title + "</a>";
							}else{
								message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + defaultDomain + msg +"c=mlotte&udid=&v=&cn=&cdn="+ "'\">"+ knw_title +"</a>";
							}
						  }else{ //기타
							  if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
					  				message_list += "<p class=\"text no_tail\" >" + msg + "</p>";
					  			}else{
					  				message_list += "<p class=\"text\" >" + msg + "</p>";
					  			}
					  	  }
					  	if(flag == 'C'){
					  		message_list += "<div class=\"check\" style=\"display:block\"><span id=\"R"+talk_id+"_"+seq+"\" name=\"R"+talk_id+"_"+seq+"\">"+agent_read_flag + "</span>" + ctime +"</div>";
					  	}else if(flag == 'A'){
					  		message_list += "<div class=\"check\" style=\"display:block\">" + ctime +"</div>"; 
					  	}else{
					  		message_list += "<div class=\"check\" style=\"display:block\">" + ctime +"</div>"; 
					  	}
					  	  $("#getTalkId").val(talk_id);
						  $("#getTalkSeq").val(seq);
						  $("#cdate_ch").val(cdate); 
						  $("#senderGubun").val(flag);  
							  message_list += "</div>";
					  } // --for End
					  $("#chatIng").append(message_list);
					  //$("#getTalkId").val(talk_id);
					  //$("#getTalkSeq").val(seq);
					  $("#sendBtn").html("전송");
					  $("#sendBtnSee").html("전송");
					  //$("#talkEndBtn").attr("style","display:block");
	    				//$("#msg").val("");
	    				$("#emoticonName").val("");
	    				  $("#emoticonInfo").val("");
	    				  //$("#file_name").val("");
	    				 // $("#file_size").val("");
	    				  //$("#file_ext").val("");
	    				  //$("#file_path").val("");
	    				  $("#file_type").val("");
	    				  //첨부된 파일 초기화
	    					//if ($.browser.msie) { 
	    						// ie 일때 input[type=file] init.
	    						//$("#fileAttach").replaceWith( $("#fileAttach").clone(true) );
	    						//$("#" + fileType).replaceWith($("#" + fileType).clone(true) );
	    					//} else {
	    						// other browser 일때 input[type=file] init.
	    						//$("#fileAttach").val("");
	    						$("#" + fileType).val("");
	    					//}
	    				  loadConnection();//웹소켓 연결
	    				  if($("#connectionYn").val() == 'Y'){
	    					  //$("#msg").focus();
		    			  }	    				  
	    				  scrollBottomMove();
	    				  //$("#chatLoading2").attr("class","attach_loading none");	    				  
	  	    		}else if(result.error_code == -49999){  //20151117_비로그인 처리_추가
	    				fn_goLogin();
		    		}else{//그외 처리 (인입차단, 상담불가시간, 관심고객등등
	    				//$("#chatLoading2").attr("class","attach_loading none");
	    				var errorMgr = result.error_message;
	    				$("#fileAttach").val("");
						$("#fileAttach2").val("");
						$("#fileAttach3").val("");
						$("#fileAttach4").val("");
						$("#file_type").val("");
						//$("#chatLoading2").attr("class","attach_loading none");
	    				 //상담사 인입차단
						 if(result.error_code == 1004 || result.error_code == 1011 || result.error_code == 1001)
						{
							if(confirm(errorMgr)){
								fn_goQuestion();
							}
						}
						// 최대대기상담수 초과 or 대체채널모드인 경우 대체채널접수 로그 쌓기
						else if(result.error_code == 1002 || result.error_code == 1012)
						{
							if(confirm(errorMgr)){
								fn_setOtherLog();   // 대체채널 로그 입력 후 1:1문의 페이지로 이동
							}
						}else if(result.error_code == 1011 ){ //고객 개인별 동시채팅수 초과
						}else if(result.error_code == -1006 || result.error_code == -1007){ // 파일첨부 불가일 때 에러
							alert(result.error_message);
						}else {
							if(confirm('지금은 상담원과 연결이 불가능합니다.\n문의사항은 1:1문의하기로 접수해주시기 바랍니다.\n1:1문의하기로 이동하시겠습니까?')){
								fn_goQuestion();
							}
						 }
						 $("#sendBtn").attr("disabled",false);
						 $("#sendBtnSee").attr("disabled",false);
						 $("#head").find("> ul > li.out").attr("class","out");
	    			}
	    			$("#chatLoading2").attr("class","attach_loading none");
	    		  }
	             $("#chatLoading2").attr("class","attach_loading none");
	            }
	        }); 
		}else{//일반 메시지, 이모티콘 일때			
			if(message2 == ""){
				var request = $.ajax({
				 url:url_con,
				 type:"POST",
				//data: "cmd=" + cmd,
				 data: {cmd: cmd},
				 dataType:"json",
				 success:function(result){
					 if (result != null){
						if (result.error_code == 0) { 
							var error_message = result.error_message;
							var data_message = new Object();
								data_message = result.data;
							var talk_id = data_message.talk_id;
							var message = [];
								message = data_message.messages;
							var customer_read_flag = "";
							var type = "";
							var seq = "";
							var msg = "";
							var flag = "";
							var agent_read_flag = "";
							var cdate = "";
							var ctime = "";
							var sender = "";
							var cdate_ch = ""; //상단 날짜가 중복되지 않았는지 체크
							var senderGubun = ""; //발신인 구분
							//메시지 유형이 link_msg일때 처리할 변수들(장바구니, 지식상담.. 등등)
							var link_msg = new Object(); 
							var link_type = "";
							var link_icon = "";
							var link_title = "";
							var link_message = "";
							var link_titleUrl = "";
							var link_linkUrl = "";
							var link_imgUrl = "";
							//상담사 이미지
						    var img_path = "";
						    var img_url = "";
						    var downloadUrl = "";
						  for(var i = 0; i < message.length; i++){
							  var messageDivId = message[i].talk_id + "_" + message[i].seq;
							  // 메시지 중복 방지 처리
							  if ($("#" + messageDivId).length > 0)
							  {
									continue;
							  }
							  cdate_ch = $("#cdate_ch").val();
							  senderGubun = $("#senderGubun").val();
							  customer_read_flag = message[i].customer_read_flag;
							  type = message[i].type;
							  seq = message[i].seq;
							  msg = message[i].msg;
							  if(msg.indexOf('\n') > 0){
									msg = (msg+"").replace(/\n/gi,'<br//>');
								}
							//메시지 유형이 link일때	
								if((msg.indexOf('type') > -1) && (msg.indexOf('title') > -1) && (msg.indexOf('message') > -1)){
									try{
										link_msg = JSON.parse(msg);
									}catch(ex){
										alert(ex.message);
									}
									link_type = link_msg.type;
									link_icon = link_msg.icon;
									link_title = link_msg.title;
									link_message = link_msg.message;
									link_titleUrl = link_msg.titleUrl+"";
									link_linkUrl = link_msg.linkUrl;
									link_imgUrl = link_msg.imgUrl;
								}
							//xss 스크립트 문자열 방지
							  //msg = msg.replace(/\&/gi,"&amp;");
							  if(msg.indexOf('<!') > -1 || msg.indexOf('<?') > -1){
								  msg = msg.replace(/\</g, "&lt;");
								  msg = msg.replace(/\>/g, "&gt;");
							  }
							  //msg = msg.replace(/\,/gi,"&quot;");
							  //msg = msg.replace(/\(/g, "&#40;");
							  //msg = msg.replace(/\)/g, "&#41;");
							  sender = message[i].sender;
							  //flag = message[i].flag;
							  flag = message[i].flag == "H"?"A":message[i].flag;
							  agent_read_flag = message[i].agent_read_flag;
							  if(agent_read_flag == 'Y' && flag == 'C'){
								  agent_read_flag = "읽음 ";
							  }else if(agent_read_flag == 'N' && flag == 'C'){
								  agent_read_flag = "1 ";
							  }else{
								  agent_read_flag = "";
							  }
							  cdate = message[i].cdate;
							  if(cdate.substring(8,10) < '12'){
								  ctime = "오전 " + cdate.substring(8,10) + ":" + cdate.substring(10,12);
							  }else{
								  if(cdate.substring(8,10) == '12'){
										ctime = "오후 " + parseInt(cdate.substring(8,10)) + ":" + cdate.substring(10,12);
									  }else{
								  		ctime = "오후 " + parseInt(cdate.substring(8,10)-12) + ":" + cdate.substring(10,12); 
									  }
							  }
							  var getDay = fu_getDay(cdate.substring(0,4), cdate.substring(4,6)-1 , cdate.substring(6,8));
							  cdate = cdate.substring(0,4) + "년 " + cdate.substring(4,6) + "월 " + cdate.substring(6,8) + "일 " + getDay;
							  if(cdate_ch != cdate){
							  	message_list += "<div class=\"date\"><p>"+ cdate + "</p></div>";
							  }
							  $("#cdate_ch").val(cdate);
							  if(flag == 'S'){
								  message_list += "<div id='" + messageDivId + "' class=\"message opp\"><div class=\"writer\">";
									//상담사 이미지
									/*
								  if($("#Agent_imgType").val() != ""){
									  if($("#Agent_imgType").val() == "FILE"){ //파일일때
										  img_path = $("#Agent_imgPath").val();
										  downloadUrl = $("#getUrl").val();
										  message_list += "<img src=\""+ downloadUrl + "?fileInfo=" + img_path +"&ticketId=ETC \" alt=\"LOTTE.COM\" /> ";
									  }else{ //URL일때
										  img_url = $("#Agent_imgUrl").val();
										  message_list += "<img src=\""+ img_url +  "\" alt=\"LOTTE.COM\" /> ";
									  }	  
								  }*/
								  message_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
								  message_list += "</div>";
								  agent_read_flag = "";
							  }else if(flag == 'A'){
								  message_list += "<div id='" + messageDivId + "' class=\"message opp\">";
								  if((senderGubun !="A" && $("#sameTimeCh_A").val() != ctime) || (senderGubun =="A" && $("#sameTimeCh_A").val() != ctime ) || (senderGubun !="A" && $("#sameTimeCh_C").val() == ctime)){
									  message_list += "<div class=\"writer\">";
							      //상담사 이미지
							      /*
									  if($("#Agent_imgType").val() != ""){
										  if($("#Agent_imgType").val() == "FILE"){ //파일일때
											  img_path = $("#Agent_imgPath").val();
											  downloadUrl = $("#getUrl").val();
											  message_list += "<img src=\""+ downloadUrl + "?fileInfo=" + img_path +"&ticketId=ETC \" alt=\"LOTTE.COM\" /> ";
										  }else{ //URL일때
											  img_url = $("#Agent_imgUrl").val();
											  message_list += "<img src=\""+ img_url +  "\" alt=\"LOTTE.COM\" /> ";
										  }	  
									  }*/
									  message_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
							        message_list += ""+sender+" 상담원</div>";
								  }
								   agent_read_flag = "";	
							  }else if(flag == 'C'){
								  message_list += "<div id='" + messageDivId + "' class=\"message me\">";
							  }
						  	  //메시지 타입에 따른 구분
						  	  if(type == 'MSG'){//일반 메시지(www도 포함)
						  		var format = new RegExp( '[\\w-]+(\\.[\\w-]+)+([\\w-.,@?^=%&:/~+#-]*[\\w@?^=%&;/~+#-])?' );					  	  
								if(format.test(msg) && link_type != 'TAG_LINK' && link_type != 'SELF_LINK' && link_type != 'URL_LINK' && link_type != 'KNW_LINK' ) {
									var msgR = "";	
									var followParam = "";
							  		if(msg.indexOf('lotte.com') > -1){
										if(msg.indexOf('?') > -1){
											followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
										}else{
											followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
										}
									}
									message_list += "<p class=\"text\">";
									//메시지 타입에 따른 구분
						  			if(msg.indexOf('<br//>') > 0){//줄바꿈이 온경우
						  				var msgSplit1 = msg.split("<br//>");
						  				for(var lyh1=0;lyh1 < msgSplit1.length;lyh1++){
						  					if(msgSplit1[lyh1].indexOf(' ') > 0){//줄바꿈안에 공백이 있는경우
							  					var msgSplit2 = msgSplit1[lyh1].split(" ");
							  					for(var lyh2=0;lyh2 < msgSplit2.length;lyh2++){
							  						if(format.test(msgSplit2[lyh2])){
							  							if(msgSplit2[lyh2].indexOf('http://') < 0 && msgSplit2[lyh2].indexOf('https://') < 0){
												  			msgR = "http://" + msgSplit2[lyh2];
											  			}else{
											  				msgR = msgSplit2[lyh2];
											  			}
							  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  								message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit2[lyh2] + "<br></a>";
														}else{
															message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit2[lyh2] + "<br></a>";
														}
							  						}else{
							  							message_list += msgSplit2[lyh2];
							  						}
							  						message_list += " ";
							  					}
							  				}else{ //줄바꿈만 있는경우
							  					if(format.test(msgSplit1[lyh1])){
							  						if(msgSplit1[lyh1].indexOf('http://') < 0 && msgSplit1[lyh1].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit1[lyh1];
										  			}else{
										  				msgR = msgSplit1[lyh1];
										  			}
							  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  							message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit1[lyh1] + "<br></a>";
													}else{
														message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit1[lyh1] + "<br></a>";
													}
							  					}else{
							  						message_list += msgSplit1[lyh1];
							  					}
							  				}
						  					message_list += "<br>";
						  				}
						  			}else{ //줄바꿈 없음
						  				if(msg.indexOf(' ') > 0){ //공백이 있음
						  					var msgSplit3 = msg.split(" ");
						  					for(var lyh3=0;lyh3 < msgSplit3.length;lyh3++){
						  						if(format.test(msgSplit3[lyh3])){
						  							if(msgSplit3[lyh3].indexOf('http://') < 0 && msgSplit3[lyh3].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit3[lyh3];
										  			}else{
										  				msgR = msgSplit3[lyh3];
										  			}
						  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  								message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit3[lyh3] + "<br></a>";
													}else{
														message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit3[lyh3] + "<br></a>";
													}
						  						}else{
						  							message_list += msgSplit3[lyh3];
						  						}
						  						message_list += " ";
						  					}
						  				}else{ //공백이 없음
						  					if(format.test(msg)){
						  						if(msg.indexOf('http://') < 0 && msg.indexOf('https://') < 0){
										  			msgR = "http://" + msg;
									  			}else{
									  				msgR = msg;
									  			}
						  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  							message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msg + "<br></a>";
												}else{
													message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msg + "<br></a>";
												}
						  					}else{
						  						message_list += msg;	
						  					}
						  				}
						  			}
									message_list += "</p>";
							  	}else{
							  		//메시지 유형이 링크메시지이면
							  		if(link_type != ""){
							  		    if(link_type == 'TAG_LINK'){
							  		    //cloud_20151028
							  		    	message_list += "<div class=\"text\">";
							  		    	message_list += "<p class=\"title\">"+link_title+"</p>";
							  		    	message_list += "<div class=\"prd_cont\">";
											var makeLinkUrl = "";
							  		    	if(link_orderNo != ""){ //주문정보
												if(makeLinkUrl == "INTERPARKTICKET"){
													message_list += "<a href=\"#\" onclick=\"alert('티켓 주문은 WEB(PC)를 통해 확인할 수 있습니다');\">";
												}else{
													makeLinkUrl = "/mylotte/purchase/purchase_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
									  		    	//message_list += "<a href=\"#\" onclick=\""+makeLinkUrl+"\">";
													if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
														message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
													}else{
														message_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
													}
												}
							  		    	}else{//장바구니 정보
							  		    		makeLinkUrl = "/product/product_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
								  		    	//message_list += "<a href=\"#\" onclick=\""+makeLinkUrl+"\">";
							  		    		if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
													message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
												}else{
													message_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
												}
							  		    	}
							  		    	message_list += "<div class=\"thumbnail\">";
							  		    	message_list += "<img src=\""+link_imgUrl+"\" alt=\"\" onError=\"this.src='http://image.lotte.com/lotte/images/common/product/no_150.gif'\" />";
											if(link_orderStatus != ""){
												message_list += "<span class=\""+link_statusColor+"\">"+link_orderStatus+"</span>";
											}
											message_list += "</div>";
											message_list += "<div class=\"detail\">";
											message_list += "<P class=\"name\">"+link_message+"</p>";
											if(typeof link_option!="undefined"){
												message_list += "<p class=\"option\">"+link_option+"</p>";
											}
											message_list += "<P>"+link_price+"</p>";
											message_list += "</div>";
											message_list += "</a>";
											message_list += "</div>";
											message_list += "</div>";
							  		    }else if(link_type == 'SELF_LINK'){
							  		    	var followParam = "";
									  		if(link_linkUrl.indexOf('lotte.com') > -1){
												if(link_linkUrl.indexOf('?') > -1){
													followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
												}else{
													followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
												}
											}
							  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  		    		message_list += "<p class=\"text no_tail\" >";
								  			}else{
								  				message_list += "<p class=\"text\" >";
								  			}
							  		    	message_list += link_message;
							  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
								  		    	message_list += "<a  href=\"#\" onClick=\"appLoad('"+ link_linkUrl+"');return false;\">" + link_title + "</a>";
								  		    }else{
								  				message_list += "<a href=\""+ talkPreUrl + link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
								  		    }
							  		    	message_list += "</p>";
							  		    }else if(link_type == 'KNW_LINK'){
							  		    //receive_list += link_message;
							  		    	//receive_list += link_icon ;
							  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
								  				message_list += "<p class=\"text no_tail\" >";
								  			}else{
								  				message_list += "<p class=\"text\" >";
								  			}
							  		    	if(link_message.indexOf('\n') > 0){
							  		    		link_message = (link_message+"").replace(/\n/gi,'<br//>');
											}
							  		    	message_list += link_message;
							  		    	var knw_link_msg = link_linkUrl.substring(link_linkUrl.indexOf('kbId=') + 5, link_linkUrl.length); //URL에서 kb_id를 가져옴
											var kb_id_url = decodeURIComponent(knw_link_msg);  // 가져온 kb_id를 디코딩
											//url은 나중에 바꿔야함...
							  		    	//message_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\"http://211.63.24.55/demo/jsp/kb/kb.jsp?kbId=" + kb_id_url +"\">" + link_title + "</a>";
							  		    	//message_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\"/chat/knowConsult.jsp?kbId=" + kb_id_url +"\">" + link_title + "</a>";
											if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
										  		message_list += "<a class=\"opp_btn allview_btn\"  href=\"#\" onClick=\"appLoad('"+ defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url+"');return false;\">" + link_title + "</a>";
											}else{
												message_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url + "&c=mlotte&udid=&v=&cn=&cdn=\">" + link_title + "</a>";
											}
							  		    	message_list += "</p>";
							  		    }else if(link_type == 'URL_LINK'){
							  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  		    		message_list += "<p class=\"text no_tail\" >";
								  			}else{
								  				message_list += "<p class=\"text\" >";
								  			}
							  		    	//receive_list += link_message;
							  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
										  		message_list += "<a class=\"opp_btn back_btn\"  href=\"#\" onClick=\"appLoad('"+ defaultDomain +link_linkUrl+"');return false;\">" + link_title + "</a>";
											}else{
												message_list += "<a target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +link_linkUrl + "c=mlotte&udid=&v=&cn=&cdn=" +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
											}
							  		    	message_list += "</p>";
							  		    }
							  		}else{
							  		//꼬리 없는 메시지
							  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  				message_list += "<p class=\"text no_tail\" >" + msg + "</p>";
							  			}else{
							  				message_list += "<p class=\"text\" >" + msg + "</p>";
							  			}
							  		}
							  	}
						  	  }else if(type == 'URL'){//첨부파일
						  		var ext = message_list[i].ext;
							    var filename = message_list[i].ext;  
							    //첨부파일 확장자 구분
							    var format01 = "\.(bmp|gif|jpg|jpeg|png|tif))$"; //이미지
							    var format02 = "\.(mov|mp4|wmv|3gp)$"; //동영상
							    var format03 = "\.(amr|mp3|m4a|ogg|3gpp)$"; //음성파일
							    var defaulImg = "http://image.lotte.com/lotte/mobile/chat_service/@temp_stop.png";  
							  	if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
							  	//var fileInfo = msg.substring(msg.indexOf("fileInfo") + 9, msg.length);
							  		message_list +="<div class=\"thumbnail\">";
							  		//receive_list +="<a href=\"#none\" onClick=\"fn_imgPop('"+ msg+"')\">";
							  		message_list +="<a href=\"#none\" onClick=\"fn_imgPop(this,'"+msg+"');return false;\">";
							  		message_list +="<img src=\""+ msg  +  "\" alt=\"\" onError=\"this.src=\'"+defaulImg+"'\" />";
							  		message_list +="</a>";
							  		message_list +="</div>";
							  	}
							  	if((new RegExp(format02, "i")).test(ext)){ //동영상 일때
							  		message_list += "<div class=\"movie\">";
							  		//---앱개발 완료 후 주석 해제 ----------------
							  		//message_list += "<a href=\""+ talkPreUrl + msg+ "\">";/*[2016.01.22 주석해지]*/
							  		message_list += "<a href=\"#\" onClick=\"go_MplayStop();return false;\">";/*[2016.01.22 주석처리]*/
							  		message_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/@temp_play.png\" alt=\"\" />";
							  		message_list += "</a>";
							  		message_list += "</div>";
							  	}
							  	if((new RegExp(format03, "i")).test(ext)){ //음성파일 일때
							  		 //아이폰 일때 
							  		message_list += "<p class=\"text\" ><a  href=\"#none\" onClick=\"fn_unLoadV()\" class=\"voice_btn\">";
							  		message_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/icon_voice_btn.png\" alt=\"\" />";
							  		message_list += "</a></p>";
							  		//receive_list += "<a target=\"_blank\" href=\'" + msg+ "'\">" + msg + "</a>";
							  	}
						  	  }else if(type == 'EMO'){//이모티콘
						  		//var fileInfo = msg.substring(msg.indexOf("fileInfo") + 9, msg.length);
						  			message_list += "<div class=\"thumbnail\">";
						  			message_list += "<img style=\"width:100px;height:100px;\" src=\""+ msg +  "\"/>"; 
						  			message_list += "</div>"; 
						  	  }else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
						  		message_list += msg + "<br>";
							  	message_list +="**************<br>";
							  	message_list += "<a href=\"#\" onclick=\"fn_getSuerveyList()\" > 상담만족도 평가 > </a>";
							  }else if(type == 'KNW'){ //지식상담
								var knw_msg = msg.substring(msg.indexOf('kbId=') + 5, msg.length); //URL에서 kb_id를 가져옴
								var kb_id = decodeURIComponent(knw_msg);  // 가져온 kb_id를 디코딩
								//fn_getBContents(kb_id); //상담지식 컨텐츠 가져오기
								var knw_title = $("#knwTitle").val();
								message_list += "======================<br>";
								if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain + msg+"');return false;\">" + knw_title + "</a>";
								}else{
									message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + defaultDomain + msg + "c=mlotte&udid=&v=&cn=&cdn=" + "'\">"+ knw_title +"</a>";
								}
							  }else{ //기타
								  message_list += "<p class=\"text\">" + msg + "</p>";
						  	  }
						  	 if(flag == 'C'){
						  		 message_list += "<div class=\"check\" style=\"display:block\"><span id=\"R"+talk_id+"_"+seq+"\" name=\"R"+talk_id+"_"+seq+"\">"+agent_read_flag + "</span>" + ctime +"</div>";
							  	}else if(flag == 'A'){
							  		message_list += "<div class=\"check\" style=\"display:block\">" + ctime +"</div>"; 
							  	}else{
							  		message_list += "<div class=\"check\" style=\"display:block\">"+ ctime +"</div>"; 
							  	}
						  	  $("#getTalkId").val(talk_id);
							  $("#getTalkSeq").val(seq);
							  $("#cdate_ch").val(cdate); 
							  $("#senderGubun").val(flag); 
								  message_list += "</div>";
						  } // --for End
						  $("#chatIng").append(message_list);
						  //$("#getTalkId").val(talk_id);
						  //$("#getTalkSeq").val(seq);
						  $("#sendBtn").html("전송");
						  $("#sendBtnSee").html("전송");
						  //$("#talkEndBtn").attr("style","display:block");
						  $("#msg").val("");
						  $("#emoticonName").val("");
						  $("#emoticonInfo").val("");
						  //$("#file_name").val("");
						  //$("#file_size").val("");
						 // $("#file_ext").val("");
						  //$("#file_path").val("");
						  loadConnection();//웹소켓 연결
						  if($("#connectionYn").val() == 'Y'){
	    					  //$("#msg").focus();
		    			  }
						  scrollBottomMove();
						  $("#chatLoading2").attr("class","attach_loading none");
						}else if(result.error_code == -49999){  //20151117_비로그인 처리_추가
							fn_goLogin();
					    }else{//그외 처리 (인입차단, 상담불가시간, 관심고객등등
		    				$("#chatLoading2").attr("class","attach_loading none");
		    				var errorMgr = result.error_message;
		    				 //상담사 인입차단
							 if(result.error_code == 1004 || result.error_code == 1011 || result.error_code == 1001)
							 {
								if(confirm(errorMgr)){
									fn_goQuestion();
								}
							 }
							// 최대대기상담수 초과 or 대체채널모드인 경우 대체채널접수 로그 쌓기
							else if(result.error_code == 1002 || result.error_code == 1012)
							{
								if(confirm(errorMgr)){
									fn_setOtherLog();   // 대체채널 로그 입력 후 1:1문의 페이지로 이동
								}
							 }else if(result.error_code == 1011 ){ //고객 개인별 동시채팅수 초과
							 } 
							 else {
								if(confirm('지금은 상담원과 연결이 불가능합니다.\n문의사항은 1:1문의하기로 접수해주시기 바랍니다.\n1:1문의하기로 이동하시겠습니까?')){
									fn_goQuestion();
								}
							 }
							 $("#sendBtn").attr("disabled",false);
							 $("#sendBtnSee").attr("disabled",false);
							 $("#head").find("> ul > li.out").attr("class","out");
		    			}
					  }
					 $("#chatLoading2").attr("class","attach_loading none");
				 },
				 error:function(result){
					 $("#chatLoading2").attr("class","attach_loading none");
			     }
				});
				request.done(function(result){
				});
				request.fail(function(jqXHR, textStatus){ // 에러 발생
					alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
				});	
			}else{ //이모티콘 & 메시지 동시전송
				isEmoAndTextEnable = true;
				var ch_cmd = "";
						ch_cmd = cmd2;
				var request = $.ajax({
					 url:url_con,
					 type:"POST",
					 data: "cmd=" + ch_cmd,
					 dataType:"json",
					 success:function(result){
					 if (result != null){
						if (result.error_code == 0) { 
							var error_message = result.error_message;
							var data_message = new Object();
								data_message = result.data;
							var talk_id = data_message.talk_id;
							var message = [];
								message = data_message.messages;
							var customer_read_flag = "";
							var type = "";
							var seq = "";
							var msg = "";
							var flag = "";
							var agent_read_flag = "";
							var cdate = "";
							var ctime = "";
							var sender = "";
							var senderGubun = ""; //발신인 구분
							//메시지 유형이 link_msg일때 처리할 변수들(장바구니, 지식상담.. 등등)
							var link_msg = new Object(); 
							var link_type = "";
							var link_icon = "";
							var link_title = "";
							var link_message = "";
							var link_titleUrl = "";
							var link_linkUrl = "";
							var link_imgUrl = "";
							//상담사 이미지
						    var img_path = "";
						    var img_url = "";
						    var downloadUrl = "";	
							var cdate_ch = ""; //상단 날짜가 중복되지 않았는지 체크
						  for(var i = 0; i < message.length; i++){
							  var messageDivId = message[i].talk_id + "_" + message[i].seq;
								// 메시지 중복 방지 처리
								if ($("#" + messageDivId).length > 0)
								{
									continue;
								}
							  cdate_ch = $("#cdate_ch").val();
							  senderGubun = $("#senderGubun").val();
							  customer_read_flag = message[i].customer_read_flag;
							  type = message[i].type;
							  seq = message[i].seq;
							  msg = message[i].msg;
							  sender = message[i].sender;
							  if(msg.indexOf('\n') > 0){
									msg = (msg+"").replace(/\n/gi,'<br//>');
								}
							//메시지 유형이 link일때	
								if((msg.indexOf('type') > -1) && (msg.indexOf('title') > -1) && (msg.indexOf('message') > -1)){
									try{
										link_msg = JSON.parse(msg);
									}catch(ex){
										alert(ex.message);
									}
									link_type = link_msg.type;
									link_icon = link_msg.icon;
									link_title = link_msg.title;
									link_message = link_msg.message;
									link_titleUrl = link_msg.titleUrl+"";
									link_linkUrl = link_msg.linkUrl;
									link_imgUrl = link_msg.imgUrl;
								}
							//xss 스크립트 문자열 방지
							  //msg = msg.replace(/\&/gi,"&amp;");
							  if(msg.indexOf('<!') > -1 || msg.indexOf('<?') > -1){
								  msg = msg.replace(/\</g, "&lt;");
								  msg = msg.replace(/\>/g, "&gt;");
							  }
							  //msg = msg.replace(/\,/gi,"&quot;");
							  //msg = msg.replace(/\(/g, "&#40;");
							  //msg = msg.replace(/\)/g, "&#41;");
							  //flag = message[i].flag;
							  flag = message[i].flag == "H"?"A":message[i].flag;
							  agent_read_flag = message[i].agent_read_flag;
							  if(agent_read_flag == 'Y' && flag == 'C'){
								  agent_read_flag = "읽음 ";
							  }else if(agent_read_flag == 'N' && flag == 'C'){
								  agent_read_flag = "1 ";
							  }else{
								  agent_read_flag = "";
							  }
							  cdate = message[i].cdate;
							  if(cdate.substring(8,10) < '12'){
								  ctime = "오전 " + cdate.substring(8,10) + ":" + cdate.substring(10,12);
							  }else{
								  if(cdate.substring(8,10) == '12'){
										ctime = "오후 " + parseInt(cdate.substring(8,10)) + ":" + cdate.substring(10,12);
									  }else{
								  		ctime = "오후 " + parseInt(cdate.substring(8,10)-12) + ":" + cdate.substring(10,12); 
									  }
							  }
							  var getDay = fu_getDay(cdate.substring(0,4), cdate.substring(4,6)-1 , cdate.substring(6,8));
							  cdate = cdate.substring(0,4) + "년 " + cdate.substring(4,6) + "월 " + cdate.substring(6,8) + "일 " + getDay;
							  if(cdate_ch != cdate){
							  	message_list += "<div class=\"date\"><p>"+ cdate + "</p></div>";
							  }
							  $("#cdate_ch").val(cdate);
							  if(flag == 'S'){
								  message_list += "<div id='" + messageDivId + "' class=\"message opp\"><div class=\"writer\">";
									//상담사 이미지
									/*
								  if($("#Agent_imgType").val() != ""){
									  if($("#Agent_imgType").val() == "FILE"){ //파일일때
										  img_path = $("#Agent_imgPath").val();
										  downloadUrl = $("#getUrl").val();
										  message_list += "<img src=\""+ downloadUrl + "?fileInfo=" + img_path +"&ticketId=ETC \" alt=\"LOTTE.COM\" /> ";
									  }else{ //URL일때
										  img_url = $("#Agent_imgUrl").val();
										  message_list += "<img src=\""+ img_url +  "\" alt=\"LOTTE.COM\" /> ";
									  }	  
								  }*/
								  message_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
								  message_list += "</div>";
								  agent_read_flag = "";
							  }else if(flag == 'A'){
								  message_list += "<div id='" + messageDivId + "' class=\"message opp\">";
								  if((senderGubun !="A" && $("#sameTimeCh_A").val() != ctime) || (senderGubun =="A" && $("#sameTimeCh_A").val() != ctime ) || (senderGubun !="A" && $("#sameTimeCh_C").val() == ctime)){
									  message_list += "<div class=\"writer\">";
							      //상담사 이미지
							      /*
									  if($("#Agent_imgType").val() != ""){
										  if($("#Agent_imgType").val() == "FILE"){ //파일일때
											  img_path = $("#Agent_imgPath").val();
											  downloadUrl = $("#getUrl").val();
											  message_list += "<img src=\""+ downloadUrl + "?fileInfo=" + img_path +"&ticketId=ETC \" alt=\"LOTTE.COM\" /> ";
										  }else{ //URL일때
											  img_url = $("#Agent_imgUrl").val();
											  message_list += "<img src=\""+ img_url +  "\" alt=\"LOTTE.COM\" /> ";
										  }	  
									  }*/
									  message_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
							        message_list += ""+sender+" 상담원</div>";
								  }
								   agent_read_flag = "";	
							  }else if(flag == 'C'){
								  message_list += "<div id='" + messageDivId + "' class=\"message me\">";
							  }
						  	  //메시지 타입에 따른 구분
						  	  if(type == 'MSG'){//일반 메시지(www도 포함)
						  		var format = new RegExp( '[\\w-]+(\\.[\\w-]+)+([\\w-.,@?^=%&:/~+#-]*[\\w@?^=%&;/~+#-])?' );						  	  
								 if(format.test(msg) && link_type != 'TAG_LINK' && link_type != 'SELF_LINK' && link_type != 'URL_LINK' && link_type != 'KNW_LINK' ) {
									var msgR = "";	
									var followParam = "";
							  		if(msg.indexOf('lotte.com') > -1){
										if(msg.indexOf('?') > -1){
											followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
										}else{
											followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
										}
									}
									message_list += "<p class=\"text\">";
									//메시지 타입에 따른 구분
						  			if(msg.indexOf('<br//>') > 0){//줄바꿈이 온경우
						  				var msgSplit1 = msg.split("<br//>");
						  				for(var lyh1=0;lyh1 < msgSplit1.length;lyh1++){
						  					if(msgSplit1[lyh1].indexOf(' ') > 0){//줄바꿈안에 공백이 있는경우
							  					var msgSplit2 = msgSplit1[lyh1].split(" ");
							  					for(var lyh2=0;lyh2 < msgSplit2.length;lyh2++){
							  						if(format.test(msgSplit2[lyh2])){
							  							if(msgSplit2[lyh2].indexOf('http://') < 0 && msgSplit2[lyh2].indexOf('https://') < 0){
												  			msgR = "http://" + msgSplit2[lyh2];
											  			}else{
											  				msgR = msgSplit2[lyh2];
											  			}
							  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  								message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit2[lyh2] + "<br></a>";
														}else{
															message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit2[lyh2] + "<br></a>";
														}
							  						}else{
							  							message_list += msgSplit2[lyh2];
							  						}
							  						message_list += " ";
							  					}
							  				}else{ //줄바꿈만 있는경우
							  					if(format.test(msgSplit1[lyh1])){
							  						if(msgSplit1[lyh1].indexOf('http://') < 0 && msgSplit1[lyh1].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit1[lyh1];
										  			}else{
										  				msgR = msgSplit1[lyh1];
										  			}
							  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  							message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit1[lyh1] + "<br></a>";
													}else{
														message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit1[lyh1] + "<br></a>";
													}
							  					}else{
							  						message_list += msgSplit1[lyh1];
							  					}
							  				}
						  					message_list += "<br>";
						  				}
						  			}else{ //줄바꿈 없음
						  				if(msg.indexOf(' ') > 0){ //공백이 있음
						  					var msgSplit3 = msg.split(" ");
						  					for(var lyh3=0;lyh3 < msgSplit3.length;lyh3++){
						  						if(format.test(msgSplit3[lyh3])){
						  							if(msgSplit3[lyh3].indexOf('http://') < 0 && msgSplit3[lyh3].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit3[lyh3];
										  			}else{
										  				msgR = msgSplit3[lyh3];
										  			}
						  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  								message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit3[lyh3] + "<br></a>";
													}else{
														message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit3[lyh3] + "<br></a>";
													}
						  						}else{
						  							message_list += msgSplit3[lyh3];
						  						}
						  						message_list += " ";
						  					}
						  				}else{ //공백이 없음
						  					if(format.test(msg)){
						  						if(msg.indexOf('http://') < 0 && msg.indexOf('https://') < 0){
										  			msgR = "http://" + msg;
									  			}else{
									  				msgR = msg;
									  			}
						  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  							message_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msg + "<br></a>";
												}else{
													message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msg + "<br></a>";
												}
						  					}else{
						  						message_list += msg;	
						  					}
						  				}
						  			}
									message_list += "</p>";
							  	}else{
							  	//메시지 유형이 링크메시지이면
							  		if(link_type != ""){
							  		    if(link_type == 'TAG_LINK'){
							  		    //cloud_20151028
						  		    	message_list += "<div class=\"text\">";
						  		    	message_list += "<p class=\"title\">"+link_title+"</p>";
						  		    	message_list += "<div class=\"prd_cont\">";
										var makeLinkUrl = "";
						  		    	if(link_orderNo != ""){ //주문정보
											if(makeLinkUrl == "INTERPARKTICKET"){
												message_list += "<a href=\"#\" onclick=\"alert('티켓 주문은 WEB(PC)를 통해 확인할 수 있습니다');\">";
											}else{
												makeLinkUrl = "/mylotte/purchase/purchase_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
								  		    	//message_list += "<a href=\"#\" onclick=\""+makeLinkUrl+"\">";
												if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
													message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
												}else{
													message_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
												}
											}
						  		    	}else{//장바구니 정보
						  		    		makeLinkUrl = "/product/product_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
							  		    	//message_list += "<a href=\"#\" onclick=\""+makeLinkUrl+"\">";
						  		    		if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
												message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
											}else{
												message_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
											}
						  		    	}
						  		    	message_list += "<div class=\"thumbnail\">";
						  		    	message_list += "<img src=\""+link_imgUrl+"\" alt=\"\" onError=\"this.src='http://image.lotte.com/lotte/images/common/product/no_150.gif'\" />";
										if(link_orderStatus != ""){
											message_list += "<span class=\""+link_statusColor+"\">"+link_orderStatus+"</span>";
										}
										message_list += "</div>";
										message_list += "<div class=\"detail\">";
										message_list += "<P class=\"name\">"+link_message+"</p>";
										if(typeof link_option!="undefined"){
											message_list += "<p class=\"option\">"+link_option+"</p>";
										}
										message_list += "<P>"+link_price+"</p>";
										message_list += "</div>";
										message_list += "</a>";
										message_list += "</div>";
										message_list += "</div>";
							  		    }else if(link_type == 'SELF_LINK'){
							  		    	var followParam = "";
									  		if(link_linkUrl.indexOf('lotte.com') > -1){
												if(link_linkUrl.indexOf('?') > -1){
													followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
												}else{
													followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
												}
											}
							  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  		    		message_list += "<p class=\"text no_tail\" >";
								  			}else{
								  				message_list += "<p class=\"text\" >";
								  			}
							  		    	message_list += link_message;
							  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		message_list += "<a class=\"opp_btn back_btn\"  href=\"#\" onClick=\"appLoad('"+ link_linkUrl+"');return false;\">" + link_title + "</a>";
								  		  }else{
								  				message_list += "<a href=\""+ talkPreUrl +link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
								  		  }
							  		    	message_list += "</p>";
							  		    }else if(link_type == 'KNW_LINK'){
							  		    	//receive_list += link_message;
							  		    	//receive_list += link_icon ;
							  		    	message_list += "<p class=\"text\">";
							  		    	if(link_message.indexOf('\n') > 0){
							  		    		link_message = (link_message+"").replace(/\n/gi,'<br//>');
											}
							  		    	message_list += link_message;
							  		    	var knw_link_msg = link_linkUrl.substring(link_linkUrl.indexOf('kbId=') + 5, link_linkUrl.length); //URL에서 kb_id를 가져옴
											var kb_id_url = decodeURIComponent(knw_link_msg);  // 가져온 kb_id를 디코딩
											//url은 나중에 바꿔야함...
							  		    	//message_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\"http://211.63.24.55/demo/jsp/kb/kb.jsp?kbId=" + kb_id_url +"\">" + link_title + "</a>";
											if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		message_list += "<a class=\"opp_btn allview_btn\"  href=\"#\" onClick=\"appLoad('"+ defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url+"');return false;\">" + link_title + "</a>";
								  		    }else{
								  		    	message_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url + "&c=mlotte&udid=&v=&cn=&cdn=\">" + link_title + "</a>";
								  		    }
							  		    	message_list += "</p>";
							  		    }else if(link_type == 'URL_LINK'){
							  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  		    		message_list += "<p class=\"text no_tail\" >";
								  			}else{
								  				message_list += "<p class=\"text\" >";
								  			}
							  		    	//receive_list += link_message;
							  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		message_list += "<a class=\"opp_btn back_btn\"  href=\"#\" onClick=\"appLoad('"+ defaultDomain+link_linkUrl+"');return false;\">" + link_title + "</a>";
								  		  }else{
								  				message_list += "<a target=\"_blank\" href=\""+ talkPreUrl + defaultDomain+link_linkUrl + "c=mlotte&udid=&v=&cn=&cdn=" +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
								  		  }
							  		    	message_list += "</p>";
							  		    }
							  		}else{
							  		//꼬리 없는 메시지
							  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  				message_list += "<p class=\"text no_tail\" >" + msg + "</p>";
							  			}else{
							  				message_list += "<p class=\"text\" >" + msg + "</p>";
							  			}
							  		}
							  	}
						  	  }else if(type == 'URL'){//첨부파일
						  		var ext = message_list[i].ext;
							    var filename = message_list[i].ext;  
							    //첨부파일 확장자 구분
							    var format01 = "\.(bmp|gif|jpg|jpeg|png|tif)$"; //이미지
							    var format02 = "\.(mov|mp4|wmv|3gp)$"; //동영상
							    var format03 = "\.(amr|mp3|m4a|ogg|3gpp)$"; //음성파일
							    var defaulImg = "http://image.lotte.com/lotte/mobile/chat_service/@temp_stop.png";  
							  	if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
							  	//var fileInfo = msg.substring(msg.indexOf("fileInfo") + 9, msg.length);
							  		message_list +="<div class=\"thumbnail\">";
							  		//receive_list +="<a href=\"#none\" onClick=\"fn_imgPop('"+ msg+"')\">";
							  		message_list +="<a href=\"#none\" onClick=\"fn_imgPop(this,'"+msg+"');return false;\">";
							  		message_list +="<img src=\""+ msg  +  "\" alt=\"\" onError=\"this.src=\'"+defaulImg+"'\" />";
							  		message_list +="</a>";
							  		message_list +="</div>";
							  	}
							  	if((new RegExp(format02, "i")).test(ext)){ //동영상 일때
							  		message_list += "<div class=\"movie\">";
							  	//-------------------앱개발 완료 후 주석 해제 ----------------
							  		//message_list += "<a href=\""+ talkPreUrl + msg+ "\">";/*[2016.01.22 주석해지]*/
							  		message_list += "<a href=\"#\" onClick=\"go_MplayStop();return false;\">";/*[2016.01.22 주석처리]*/
							  		message_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/@temp_play.png\" alt=\"\" />";
							  		message_list += "</a>";
							  		message_list += "</div>";
							  	}
							  	if((new RegExp(format03, "i")).test(ext)){ //음성파일 일때
							  		 //아이폰 일때 
							  		message_list += "<p class=\"text\" ><a  href=\"#none\" onClick=\"fn_unLoadV()\" class=\"voice_btn\">";
							  		message_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/icon_voice_btn.png\" alt=\"\" />";
							  		message_list += "</a></p>";
							  		//receive_list += "<a target=\"_blank\" href=\'" + msg+ "'\">" + msg + "</a>";
							  	}
						  	  }else if(type == 'EMO'){//이모티콘
						  		//var fileInfo = msg.substring(msg.indexOf("fileInfo") + 9, msg.length);
						  			message_list += "<div class=\"thumbnail\">";
						  			message_list += "<img style=\"width:100px;height:100px;\" src=\""+ msg +  "\"/>"; 
						  			message_list += "</div>"; 
						  	  }else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
						  		message_list += msg + "<br>";
							  	message_list +="**************<br>";
							  	message_list += "<a href=\"#\" onclick=\"fn_getSuerveyList()\" > 상담만족도 평가 > </a>";
							  }else if(type == 'KNW'){ //지식상담
								var knw_msg = msg.substring(msg.indexOf('kbId=') + 5, msg.length); //URL에서 kb_id를 가져옴
								var kb_id = decodeURIComponent(knw_msg);  // 가져온 kb_id를 디코딩
								//fn_getBContents(kb_id); //상담지식 컨텐츠 가져오기
								var knw_title = $("#knwTitle").val();
								message_list += "======================<br>";
								if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		message_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain + msg+"');return false;\">" + knw_title + "</a>";
								}else{
									message_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + defaultDomain + msg + "c=mlotte&udid=&v=&cn=&cdn=" + "'\">"+ knw_title +"</a>";
								}
							  }else{ //기타
								  message_list += "<p class=\"text\">" + msg + "</p>";
						  	  }
						  	if(flag == 'C'){
						  		message_list += "<div class=\"check\" style=\"display:block\"><span id=\"R"+talk_id+"_"+seq+"\" name=\"R"+talk_id+"_"+seq+"\">"+agent_read_flag + "</span>" + ctime +"</div>";
						  	}else if(flag == 'A'){
						  		message_list += "<div class=\"check\" style=\"display:block\">" + ctime +"</div>"; 
						  	}else{
						  		message_list += "<div class=\"check\" style=\"display:block\">" + ctime +"</div>"; 
						  	}
						  	  $("#getTalkId").val(talk_id);
							  $("#getTalkSeq").val(seq);
							  $("#cdate_ch").val(cdate); 
							  $("#senderGubun").val(flag); 
								  message_list += "</div>";
						  } // --for End
						  $("#chatIng").append(message_list);
						  //$("#getTalkId").val(talk_id);
						  //$("#getTalkSeq").val(seq);
						  $("#sendBtn").html("전송");
						  $("#sendBtnSee").html("전송");
						  //$("#talkEndBtn").attr("style","display:block");
						  $("#msg").val("");
						  //$("#emoticonName").val("");
						  //$("#emoticonInfo").val("");
						  //$("#file_name").val("");
						  //$("#file_size").val("");
						  //$("#file_ext").val("");
						  //$("#file_path").val("");
						//아직 웹소켓 연결이 안되었으면 연결
	    				  if($("#connectionYn").val() == 'N'){
	    					  loadConnection();//웹소켓 연결 
	    				  }
	    				  if($("#connectionYn").val() == 'Y'){
	    					  //$("#msg").focus();
		    			  }	    				  
	    				  scrollBottomMove();
	    				  //$("#chatLoading2").attr("class","attach_loading none");
	    				  $("#sendBtn").html("전송");
						  $("#sendBtnSee").html("전송");
						  fn_send();
						  //fn_getMessage2();
						}else if(result.error_code == -49999){  //20151117_비로그인 처리_추가
							fn_goLogin();
					    }else{//그외 처리 (인입차단, 상담불가시간, 관심고객등등
		    				//$("#chatLoading2").attr("class","attach_loading none");
		    				var errorMgr = result.error_message;
		    				 //상담사 인입차단
							 if(result.error_code == 1004 || result.error_code == 1011 || result.error_code == 1001)
							{
								if(confirm(errorMgr)){
									fn_goQuestion();
								}
							}
							// 최대대기상담수 초과 or 대체채널모드인 경우 대체채널접수 로그 쌓기
							else if(result.error_code == 1002 || result.error_code == 1012)
							{
								if(confirm(errorMgr)){
									fn_setOtherLog();   // 대체채널 로그 입력 후 1:1문의 페이지로 이동
								}
							 }else if(result.error_code == 1011 ){ //고객 개인별 동시채팅수 초과
									alert(errorMgr);
							 } 
							 else {
								if(confirm('지금은 상담원과 연결이 불가능합니다.\n문의사항은 1:1문의하기로 접수해주시기 바랍니다.\n1:1문의하기로 이동하시겠습니까?')){
									fn_goQuestion();
								}
							 }
							 $("#sendBtn").attr("disabled",false);
							 $("#sendBtnSee").attr("disabled",false);
							 $("#head").find("> ul > li.out").attr("class","out");
		    			}
					   }
					   $("#chatLoading2").attr("class","attach_loading none");
				     },
			         error:function(result){
				    	 $("#chatLoading2").attr("class","attach_loading none");
				     }
					});
					request.done(function(result){
					});
					request.fail(function(jqXHR, textStatus){ // 에러 발생
						$("#chatLoading2").attr("class","attach_loading none");
						alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
					});	
			}
			if ($(".now_message").css("display") == "block" ){
				$(".now_message").css( "top" , "" );
			}
			if($("#emoticonInfo").val() == ""){
				$(".emoticon_message").hide();
				$(".emoticon_message").find("> a.view").empty();
			}
			//$(".emoticon").hide();
			//$(".emoticon").attr("style","display:none");
			//전송버튼 불가능하도록 처리
			$("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",true);
	}
		fn_writingEnd();
		$("#head").find("> h1 > a").removeClass("on");
		$("#head").find("> .layer_info").hide();
		$(".attach_btn").removeClass("on");
		$(".attach").attr("style","display:none");
		textareaInputInit();
		if(!isEmoOnlyEnable){
			$("#msg").focus();
		}else{
			isEmoOnlyEnable = false;
		}
		if(isEmoAndTextEnable){//이모티콘 & 텍스트 전송시
			isEmoAndTextEnable = false;
			$("#msg").focus();
		}
	}else{ //메시지 전송(상담신청 메시지 아님) ★
	    //alert('send'); 
		var mForm = document.frm; 
		var obj = new Object(); //기본적인 오브젝트
		var obj2 = new Object(); //이모티콘하고 문자 같이 전송시 쓰일 오브젝트
		var url_con = "";
		command = "TalkSend";
		var message = msg;
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.service_type = service_type;
		obj.customer_id = customer_id;
		obj.talk_id = $("#getTalkId").val();
		obj.seq = $("#getTalkSeq").val();
		obj.message = message;
		//이모티콘하고 메시지 전송시 쓰임
		obj2.command = command; 
		obj2.domain_id = domain_id;
		obj2.service_type = service_type;
		obj2.customer_id = customer_id;
		obj2.talk_id = $("#getTalkId").val();
		obj2.seq = $("#getTalkSeq").val();
		obj2.message = message;
		//이모티콘 포함해서 전송할 때
		var emoticonYn = "";
		var emoticonName = $("#emoticonName").val();
		var emoticonInfo = $("#emoticonInfo").val();
		console.log(emoticonInfo);
		var message2 = "";
		if(emoticonInfo != null && emoticonInfo != ""){
			isEmoOnlyEnable = true;
			obj.emoticon_flag = 'Y';
			//emoticonInfo = emoticonInfo.replace(/\>/g, '');
			//emoticonInfo = emoticonInfo.replace(/\</g, '');
			//emoticonInfo = emoticonInfo.replace(/\n/g, '');
			//emoticonInfo = emoticonInfo.replace(/\%0A/g, '');
			//emoticonInfo = emoticonInfo.replace('%0A', '');
			//emoticonInfo = emoticonInfo.replace('<br>', '');
			if($("#msg").val() != ""){
				//message2 = $("#msg").val();
				message2 = msg;
				obj2.message = message2;
			}
				obj.message = "?fileInfo=" + emoticonInfo;
		}
		//첨부파일 있을 때
		var fileAttach = $("#" + fileType).val();
		var attach_flag = "";
		if(fileType != "" && fileAttach !="" ){
			//alert('파일있음');
			obj.attach_flag = 'Y';
			attach_flag = 'Y';
			obj.message = "";
		}
		console.log(obj);
		var cmd = JSON.stringify(obj);
		console.log("cmd:"+cmd); 
		//alert("cmd:"+cmd);
		/*
		if(cmd.length > 800){
			alert('전송할 메시지는 800자를 넘을 수 없습니다.');
			return;
		}*/
		//이모티콘하고 메시지 동시 전송시 사용
		var cmd2 = JSON.stringify(obj2); 
		/*
		if(cmd2.length > 800){
			alert('전송할 메시지는 800자를 넘을 수 없습니다.');
			return;
		}*/
		mForm.cmd2.value = cmd;
		$("#cmd").val(cmd);
		var frm = $("#frm");
		var result_list = "";
		//$("#chatIng").text();
		if(attach_flag == 'Y'){
			url_con = url + "?domain_id=" + domain_id +"&service_type="+service_type + "&customer_id="+customer_id +"&cmd=" + cmd;
		}else{
			url_con = url;
		}
		if(attach_flag == 'Y'){ //첨부파일이 있을 때 
			$("#frm").attr("action",url_con);
			$("#frm").ajaxSubmit({
				 dataType:'json',
				  success: function(result) { 
	             if (result != null){
	    			if (result.error_code == 0) { 
	    				//$("#msg").val("");
	    				 $("#emoticonName").val("");
	    				  $("#emoticonInfo").val("");
	    				  //$("#file_name").val("");
	    				  //$("#file_size").val("");
	    				  //$("#file_ext").val("");
	    				  //$("#file_path").val("");
	    				  $("#file_type").val("");
	    				//첨부된 파일 초기화
	  					//if ($.browser.msie) {
	  						// ie 일때 input[type=file] init.
	  					//$("#fileAttach").replaceWith( $("#fileAttach").clone(true) );
	  						//$("#" + fileType).replaceWith($("#" + fileType).clone(true) );
	  					//} else {
	  						// other browser 일때 input[type=file] init.
	  					    //$("#fileAttach").val("");
	  						$("#" + fileType).val("");
	  					//}
	    				  $("#inputIng").val('N'); //고객입력상태 전송
	    				  //아직 웹소켓 연결이 안되었으면 연결
	    				  if($("#connectionYn").val() == 'N'){
	    					  loadConnection();//웹소켓 연결 
	    				  }
	    				  //if($("#connectionYn").val() == 'Y'){
							  fn_getMessage3(result);
		    				  //$("#msg").focus();  
	    				  //}
	    				  //$("#msg").focus();	    				  
	  	    		}else if(result.error_code == -49999){  //20151117_비로그인 처리_추가
	    				fn_goLogin();
	    		    }else if(result.error_code == -1006 || result.error_code == -1007){ // 파일첨부 불가일 때 에러
	    		    	$("#fileAttach").val("");
						$("#fileAttach2").val("");
						$("#fileAttach3").val("");
						$("#fileAttach4").val("");
						$("#file_type").val("");
						$("#chatLoading2").attr("class","attach_loading none");
						alert(result.error_message);
	    		    }else if(result.error_code == -2006){//티켓 상태가 유효하지 않음.
	    		    	fn_getMessage2();
	    		    }else if(result.error_code == -1001 
	    		    			|| result.error_code == -2003 
	    		    			|| result.error_code == -2004 
	    		    			|| result.error_code == -2008 
	    		    			|| result.error_code == -2015){//기타오류
	    		    	alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
	    		     }else{
						$("#fileAttach").val("");
						$("#fileAttach2").val("");
						$("#fileAttach3").val("");
						$("#fileAttach4").val("");
						$("#file_type").val("");
						$("#chatLoading2").attr("class","attach_loading none");
						alert(result.error_message);
	    			}
	    		  }
	            }
	        }); 
		}else{ //일반 메시지, 이모티콘 일때
			//alert("message2:"+message2);
			//alert(cmd);
			if(message2 == ""){
				  $.ajax({
				 url:url,	
				 type:"POST",
				 //data: "cmd=" + cmd,
				 data: {cmd: cmd},
				 dataType:"json",
				 success : function(result) {
					//alert(result);
					 if (result != null){
							if (result.error_code == 0) {
								//if($("#connectionYn").val() == 'Y'){
			    					  fn_getMessage3(result);  
			    				  //}
								$("#msg").val("");
								$("#emoticonName").val("");
								  $("#emoticonInfo").val("");
								  //$("#file_name").val("");
								  //$("#file_size").val("");
								  //$("#file_ext").val("");
								  //$("#file_path").val("");
								  $("#inputIng").val('N'); //고객입력상태 전송
								//아직 웹소켓 연결이 안되었으면 연결
			    				  if($("#connectionYn").val() == 'N'){
			    					  loadConnection();//웹소켓 연결 
			    				  }
			    				  //if($("#connectionYn").val() == 'Y'){
			    					  //$("#msg").focus();
				    			  //}
							}else if(result.error_code == -49999){  //20151117_비로그인 처리_추가
								fn_goLogin();
							}else if(result.error_code == -2006){//티켓 상태가 유효하지 않음.
			    		    	fn_getMessage2();
			    		    }else if(result.error_code == -1001 
			    		    			|| result.error_code == -2003 
			    		    			|| result.error_code == -2004 
			    		    			|| result.error_code == -2008 
			    		    			|| result.error_code == -2015){//기타오류
			    		    	alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
						    }else{
							}
				 	}
					 $("#chatLoading2").attr("class","attach_loading none"); 	
				 } ,error : function(request, status, error) {
					    //alert("에러발생!!");
			 		}
				}); 
			}else{ //이모티콘 & 메시지 동시전송
				isEmoAndTextEnable = true;
				//alert("이모티콘 & 메시지 동시전송");
				//이모티콘정보를 먼저 보내고 완료되면 완료시점에 메시지정보를 보내 (1이모티콘) (2메시지) 순서를 맞춘다.
				var request = $.ajax({
				url:url,	
				type:"POST",
				//data: "cmd=" + cmd,
				data: {cmd: cmd},
				dataType:"json",
				success:function(result){
					if (result != null){
						if(result.error_code == -49999){  //20151117_비로그인 처리_추가
							fn_goLogin();
					 	}
						//이모티콘 전송 끝나면 메세지전송
						var request2 = $.ajax({
							url:url,	
							type:"POST",
							data: "cmd=" + cmd2,
							dataType:"json",
							success:function(result){
								if (result != null){
									if (result.error_code == 0) { 
										$("#msg").val("");
										$("#emoticonName").val("");
										$("#emoticonInfo").val("");
										//$("#file_name").val("");
										//$("#file_size").val("");
										//$("#file_ext").val("");
										//$("#file_path").val("");
										$("#inputIng").val('N'); //고객입력상태 전송
										//아직 웹소켓 연결이 안되었으면 연결
				    					if($("#connectionYn").val() == 'N'){
				    						loadConnection();//웹소켓 연결 
				    					}
				    					//$("#msg").focus();
				    					fn_getMessage3(result);
									}else if(result.error_code == -49999){  //20151117_비로그인 처리_추가
										fn_goLogin();
									}else if(result.error_code == -2006){//티켓 상태가 유효하지 않음.
				    		    		fn_getMessage2();
				    		    	}else if(result.error_code == -1001 
				    		    			|| result.error_code == -2003 
				    		    			|| result.error_code == -2004 
				    		    			|| result.error_code == -2008 
				    		    			|| result.error_code == -2015){//기타오류
				    		    		alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
							    	}else{
									}
								}
							 //if($("#connectionYn").val() == 'Y'){
								//if(j == 1){
								//}
		    				 //}
							 //$("#msg").focus();
							 //$("#chatLoading2").attr("class","attach_loading none");
							},
							error:function(result){
								$("#chatLoading2").attr("class","attach_loading none");
							}
						}); 
						request2.done(function(result){
						});
						request2.fail(function(jqXHR, textStatus){ // 에러 발생
							$("#chatLoading2").attr("class","attach_loading none");
							alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
						});	
						request2.complete(function(jqXHR, textStatus){
						});	
						//$("#chatLoading2").attr("class","attach_loading none");
					}
			     },
			     error:function(result){
			    	 $("#chatLoading2").attr("class","attach_loading none");
			     }
				}); 
				request.done(function(result){ 
				});
				request.fail(function(jqXHR, textStatus){ // 에러 발생
					$("#chatLoading2").attr("class","attach_loading none");
					alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
				});	
				request.complete(function(jqXHR, textStatus){
				});	
			}
		} // --else END
		fn_writingEnd();
	}
	if ($(".now_message").css("display") == "block" ){
		$(".now_message").css( "top" , "" );
	}
	$(".emoticon_message").hide();
	$(".emoticon_message").find("> a.view").empty();
	//$(".emoticon").hide();
	//$(".emoticon").attr("style","display:none");
	//전송버튼 가능하도록 처리
	if ($("#msg").val().trim() != "" ) {
		$("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);	
	}else{
		$("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",true);
	}
	$(".attach_btn").removeClass("on");
	$(".attach").attr("style","display:none");
	//$("#head").find("> ul > li.out").attr("class","out on02");
	if(!isEmoOnlyEnable){
		$(".emoticon").hide();
		$(".emoticon").attr("style","display:none");
		if (set_focus){
			$("#msg").focus();
		}
	}else{
		isEmoOnlyEnable = false;
	}
	if(isEmoAndTextEnable){//이모티콘 & 텍스트 전송시 
		isEmoAndTextEnable = false;
		if (set_focus){
			$("#msg").focus();
		}
	}
}
/* ******************************************
고객이 상담글 입력중twinsrira
******************************************* */
function fn_writing(){
	if($("#sendBtn").html() != "전송"){
		if (( $("#chatInput").find("> .keypad_input").find("> .keypad > textarea").val().trim() && $("#chatInput").find("> .keypad_input").find("> .keypad > textarea").val().trim() != "" ) ||  $("#chatInput").find("> .emoticon_message").find("> a.view").find("> img").length > 0 ) {
			$('#sendBtnSee').html("전송");
		} else {
			$('#sendBtnSee').html("상담<br/>신청");
		}
	}else{
		if (( $("#chatInput").find("> .keypad_input").find("> .keypad > textarea").val().trim() && $("#chatInput").find("> .keypad_input").find("> .keypad > textarea").val().trim() != "" ) ||  $("#chatInput").find("> .emoticon_message").find("> a.view").find("> img").length > 0 ) {
			$('#sendBtnSee').html("전송");
		} else {
			$('#sendBtnSee').html("전송");
		}
	}
	//입력중일때 공지사항 안보이게 처리
	$("#head").find("> h1 > a").removeClass("on"); 
	$("#head").find("> .layer_info").hide(); 
	var inputIng = $("#inputIng").val();
	var message = $("#msg").val();
	if($("#sendBtn").html() == "전송" && inputIng == 'N' && message.length > 0){
		//alert('writing.....');
		var mForm = document.frm; 
		var obj = new Object(); 
		command = "TalkWritingStatus";
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.service_type = service_type;
		obj.talk_id = $("#getTalkId").val();
		obj.input_status = "WRITING";
		var cmd = JSON.stringify(obj); 
		mForm.cmd2.value = cmd;
		var param = "cmd=" + cmd;
		var result_list = "";
		var request = $.ajax({
		 url:url,
		 type:"POST",
		 data: param,
		 dataType:"json"
		});
		request.done(function(result){ 
		 if (result != null){
			  //정상적으로 고객의 메시지 입력상태를 전송
			  if (result.error_code == 0) { 
				  //alert("입력상태를 전송완료!");
			  }else{ 
				 // alert("입력상태를 전송실패");
			  }
		 }
		});
		request.fail(function(jqXHR, textStatus){ // 에러 발생
			//alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
		});	
		$("#inputIng").val('Y');
	}
	if($("#sendBtn").html() == "전송" && inputIng == 'Y' && message.length == 0){
		fn_writingEnd();
	}
}
/* ******************************************
고객이 상담글 입력 중지
******************************************* */
function fn_writingEnd(){
	var inputIng = $("#inputIng").val();
	var message = $("#msg").val();
		var mForm = document.frm; 
		var obj = new Object(); 
		command = "TalkWritingStatus";
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.service_type = service_type;
		obj.talk_id = $("#getTalkId").val();
		obj.input_status = "END";
		var cmd = JSON.stringify(obj); 
		var param = "cmd=" + cmd;
		var result_list = "";
		var request = $.ajax({
		 url:url,
		 type:"POST",
		 data: param,
		 dataType:"json"
		});
		request.done(function(result){ 
		 if (result != null){
			  //정상적으로 고객의 메시지 입력상태를 전송
			  if (result.error_code == 0) { 
				  //alert("입력상태를 전송완료!");
			  }else{ 
				 // alert("입력상태를 전송실패");
			  }
		 }
		});
		request.fail(function(jqXHR, textStatus){ // 에러 발생
			//alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
		});	
		$("#inputIng").val('N');
}
var emoticon_data = [];
function getOriginalEmoticon(thumbnailName)
{
	var emoticon;
	for (var i=0; i< emoticon_data.length; i++)
	{
		var emoticonName = thumbnailName + ".emotion.gif"; 
		if ( emoticon_data[i].attachName == emoticonName)
		{
			emoticon = emoticon_data[i];
			break;
		}
	}
	return emoticon;
}
/* ******************************************
이모티콘 가져오기
******************************************* */
function fn_loadEmoticon(){
	var mForm = document.frm; 
	var obj = new Object(); 
	command = "TalkEmoticon";
	obj.command = command; 
	obj.domain_id = domain_id;
	obj.service_type = service_type;
	var cmd = JSON.stringify(obj); 
	mForm.cmd2.value = cmd;
	var param = "cmd=" + cmd;
	var emoticon_list = ""; //이모티콘 리스트
	var page_list = ""; //롤링할 페이지 리스트
	$("#emoticonSlider").text("");
	//$(".page").text("");
	var request = $.ajax({
	 url:"/proxy", // url:url,
	 type:"POST",
	 data: param,
	 dataType:"json",
	 	success : function(result) {
	 		 if (result != null){
	 			  if (result.error_code == 0) { 
	 				  var data_message = new Object();
	 					  data_message = result.data;
	 				  var emoticon_use_flag = data_message.emoticon_use_flag;
	 					  emoticon_data = data_message.data;
	 				  var processSeq = ""; 
	 				  var attachSeq = "";
	 				  var attachName = "";
	 				  var attachPath = "";
	 				  var emoticonFlag = "";
	 			      var thumbnailFlag = "";
	 			      var fileInfo = "";
	 			      var emoticon_cnt = 0;
	 				  //alert(emoticon_data.length);
	 				  for(var i = 0; i < emoticon_data.length; i++){
	 						processSeq = emoticon_data[i].processSeq;
	 						attachSeq = emoticon_data[i].attachSeq;
	 						//국내 : kor_lotte_01.png, kor_lotte_01.png.emotion.gif
	 						//중국 : chn_lotte_01.png, chn_lotte_01.png.emotion.gif
	 						//엘롯데 : ellotte_01.png, ellotte_01.png.emotion.gif
	 						attachName = emoticon_data[i].attachName;	
	 						attachPath = emoticon_data[i].attachPath;
	 						emoticonFlag = emoticon_data[i].emoticonFlag;
	 						thumbnailFlag = emoticon_data[i].thumbnailFlag;
	 						fileInfo = emoticon_data[i].fileInfo;
	 						//alert(attachName);
	 						//if(emoticonFlag == 'Y' && thumbnailFlag == 'N'){ //썸네일 이미지
							if(emoticonFlag == 'Y' && thumbnailFlag == 'N' && attachName.indexOf("kor") > -1){ //썸네일 이미지
		 						//alert(111);
	 							emoticon_cnt++;
	 							if(emoticon_cnt == 1 || emoticon_cnt % 8 == 1){
	 								emoticon_list +="<ul>";
	 							}
	 							emoticon_list +="<li><a href=\"#none\" onclick=\"fn_bigEmoticon('"+ emoticon_data[i].fileInfo +"', '"+emoticon_data[i].attachName+"');\">";
	 							//emoticon_list +="<img src=\""+url +"?ticketId=EMO&fileInfo="+ fileInfo +  "\"  alt=\"\" /></a></li>";
	 							//20151103 수정_ISY
	 							emoticon_list +="<img src=\""+url +"?fileInfo="+ fileInfo +  "&ticketId=EMO\"  alt=\"\" /></a></li>";
	 							if(emoticon_cnt !=0 && emoticon_cnt % 8 == 0){
	 								emoticon_list +="</ul>";
	 								page_list +="<span class=\"page_list\">이모티콘"+(emoticon_cnt / 8)+"</span>";
	 							}	
	 						}else{
	 							continue;
	 						}
	 				  }
	 				  //console.log(emoticon_list);
	 				  //alert(emoticon_cnt);
	 				  $("#emoticonSlider").append(emoticon_list);
	 				  //$(".page").append(page_list);
	 			  }else{ 
	 				//alert('조회된 이모티콘 없음');
	 			  }
	 			}	
		},error : function(request, status, error) {
				//alert('오류가 발생하였습니다.');
 		}, 
 		complete : function(request, status) {
 			//$("#emoticonSlider ul").css("width" , $("#emoticonSlider").width() );
 			$bannerSlide = setEGSlide("#emoticonSlider", function(index){
	 		   $("#emoticonSlider").parent().find("> .page span").removeClass("on").eq(index).addClass("on");  
	 		}, false);
 		}
	});
}
/* ******************************************
큰 이모티콘 보여주기
******************************************* */
function fn_bigEmoticon(fileInfo , attachName){
	//더블클릭일 때
	//if($("#emoticonInfo").val() == fileInfo){
	if($("#emoticonName").val() == attachName){
		//fn_timeCheck2();
		fn_send();
		return false;
	}
	//이모티콘 상세 레이어 노출 처리
	if ($(".now_message").css("display") == "block" ){
		$(".now_message").css( "top" , $(".now_message").height());
	}
	$(".emoticon_message").show();
	$(".emoticon_message").find("> a.view").empty();
	$(this).find("img").clone().appendTo( $(".emoticon_message").find("> a.view"));
	$("#sendBtn").attr("disabled",false);
	$("#sendBtnSee").attr("disabled",false);
	var emoticon_big = "";
	$(".emoticon_message").text("");
	//emoticon_big +="<input type=\"hidden\" id=\"attachNameBig\" name=\"attachNameBig\" value=\'"+ attachName +"'\"/>";
	//emoticon_big +="<input type=\"button\" id=\"closeBtn\" name=\"closeBtn\" value=\"X\" onclick=\"fn_emoticonClose()\"/>";
	//emoticon_big +="<a href=\"#\" onclick=\"fn_selectEmoticon('"+ fileInfo +"', '"+attachName+"');\">";
	//emoticon_big +="<a class=\"view\" href=\"#none\" onclick=\"fn_selectEmoticon('"+ fileInfo +"', '"+attachName+"');\">";
	emoticon_big +="<a class=\"view\" href=\"#none\" >";
	//emoticon_big +="<img src=\"http://211.63.24.55/proxy?fileInfo="+ fileInfo +  "\"/></a>";
	//emoticon_big +="<img src=\""+url +"?ticketId=EMO&fileInfo="+ fileInfo +  "\" alt=\"\"/></a>";
	//20151103
	emoticon_big +="<img src=\""+url +"?fileInfo="+ fileInfo +"&ticketId=EMO\" alt=\"\"/></a>"; 
	emoticon_big +="<a class=\"close\" href=\"#none\" onClick=\"closeBtn();\">닫기</a>";
	//emoticon_big +="<img src=\"http://211.63.24.55:443/enomix/common/DownloadAttach.ee?fileInfo="+ fileInfo +  "\"/></a>";
	//$("#emoticon_big").append(emoticon_big);
	$(".emoticon_message").append(emoticon_big);
	var emoticonInfoValue = fileInfo;
	var emoticon = getOriginalEmoticon(attachName);
	if (emoticon != undefined)
	{
		emoticonInfoValue = emoticon.fileInfo;
	}
	//이모티콘 값 셋팅
	$("#emoticonName").val(attachName);
	$("#emoticonInfo").val(emoticonInfoValue);
}
/* ******************************************
이모티콘 선택 (메시지에 추가)
******************************************* */
function fn_selectEmoticon(fileInfo,attachName){
	$("#emoticonName").val(attachName);
	$("#emoticonInfo").val(fileInfo);
	if ($(".now_message").css("display") == "block" ){
		$(".now_message").css( "top" , "" );
	}
	$(".emoticon_message").hide();
	$(".emoticon_message").find("> a.view").empty();
	//전송버튼 가능하도록 처리
	$("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
	//attachLayerOff();
	//emoticonLayerOff();
	/*
    if ( ( $("#msg").val().trim() && $("#msg").val().trim() != "" ) ||  $(".emoticon_message").find("> a.view").find("> img").length > 0 ) {
		$("#sendBtn").attr("disabled",false);
    } else {
		$("#sendBtn").attr("disabled",true);
    }
	*/
	//$("#emoticon_big").attr("style" ,"display:none");
	//$("#emoticon_view").attr("style" ,"display:none");
}
/* ******************************************
이모티콘 선택취소 (하단의 선택박스도 닫기)
******************************************* */
function closeBtn(){
	if($("#chatInput").find("> .now_message").css("display") == "block" ){
		$("#chatInput").find("> .now_message").css( "top" , "" );
	}
	$("#chatInput").find("> .emoticon_message").hide();
    $("#chatInput").find("> .emoticon_message").find("> a.view").empty();
    //이모티콘 값 초기화
    $("#emoticonName").val("");
	$("#emoticonInfo").val("");
	if($("#sendBtn").html() != "상담<br>신청"){
		sendBtnActive2();
    }
}
/* ******************************************
채팅안내 창 닫기
******************************************* */
function layerClose(){
	$("#head").find("> h1 > a").removeClass("on");
	$("#head").find("> .layer_info").hide();
}
/* ******************************************
//키패드 입력에 따른 전송버튼 활성화
******************************************* */
function sendBtnActive2(){
	if ( ( $("#chatInput").find("> .keypad_input").find("> .keypad > textarea").val().trim() 
			&& $("#chatInput").find("> .keypad_input").find("> .keypad > textarea").val().trim() != "" ) 
			||  $("#chatInput").find("> .emoticon_message").find("> a.view").find("> img").length > 0 ) {
			$("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
			} else {
				$("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",true);
			}
}
/* ******************************************
파일미리보기 취소
******************************************* */
function fn_fileClose(){
	$("#file_view").attr("style" ,"display:none");
}
/* ******************************************
메시지 받아오기
******************************************* */
function fn_getMessage2(actTp){
	//상담사 메시지와 고객전송 메시지가 있을때 동일내용을 가져오지않기 위한 처리
	var tkCh = 'C'+ $("#getTalkId").val() + '_' + eval(' +$("#getTalkSeq").val() + 1 ');
    if($("#" + tkCh).val() != undefined){
        return;
    }
    // ---end 
		var mForm = document.frm; 
		var obj = new Object(); 
		command = "TalkReceive";
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.service_type = service_type;
		obj.customer_id = customer_id;
		obj.talk_id = $("#getTalkId").val();
		obj.seq = $("#getTalkSeq").val();
		var cmd = JSON.stringify(obj); 
		mForm.cmd2.value = cmd;
		var param = "cmd=" + cmd;
		var receive_list = "";
		//동일시간 일때 div id를 담을 변수
		var sameTime_C = []; //고객
		var sameTime_A = []; //상담사
		var sameTimeCnt_C = 0;
		var sameTimeCnt_A = 0;
		var request = $.ajax({
		 url:url,
		 type:"POST",
		 data: param,
		 dataType:"json",
		 success : function(result) {
			 if(isGetMessage3Ing){
				return; 
			 }
			 if (result != null){
				 if (result.error_code == 0) {
				var data_message = new Object();
					data_message = result.data;
				var message_list = [];
					message_list = data_message.messages;
				var type = ""; 
				var seq = "";
				var sender = "";
				var msg = "";
				var flag = "";
			    var agent_read_flag = "";
			    var customer_read_flag = "";
			    var account_id = "";
			    var cdate = "";
			    var talk_id = "";
			    var ctime = "";
			    var cdate_ch = ""; //상단 날짜가 중복되지 않았는지 체크
			    var senderGubun = ""; //발신인 구분
	            //상담사 이미지
			    var img_path = "";
			    var img_url = "";
			    var downloadUrl = "";
			    //첨부파일 있을때
			    var ext = "";
			    var filename = "";
			    //메시지 유형이 link_msg일때 처리할 변수들(장바구니, 지식상담.. 등등)
				var link_msg = new Object(); 
				var link_type = "";
				var link_icon = "";
				var link_title = "";
				var link_message = "";
				var link_titleUrl = "";
				var link_linkUrl = "";
				var link_imgUrl = "";
				//TAG_LINK 추가사용 cloud_20151028
				var link_option = "";
				var link_price = "";
				var link_orderStatus = "";
				var link_iconText = "";
				var link_priceColor = "";
				var link_statusColor = "";
				var link_orderNo = "";
				var link_productNo = "";
				var link_goods_list = null; // 추천상품 json data
				  for(var i = 0; i < message_list.length; i++){
						var messageDivId = message_list[i].talk_id + "_" + message_list[i].seq;
						// 메시지 중복 방지 처리
						if ($("#" + messageDivId).length > 0)
						{
							continue;
						}
					    cdate_ch = $("#cdate_ch").val();
					    senderGubun = $("#senderGubun").val();
					  	type = message_list[i].type;
					  	seq = message_list[i].seq;
					  	sender = message_list[i].sender;
					  	msg = message_list[i].msg;
					  	if(msg.indexOf('\n') > 0){
							msg = (msg+"").replace(/\n/gi,'<br//>');
						}
					  	textareaInputInit();
					  	//flag = message_list[i].flag;
					  	flag = message_list[i].flag == "H"?"A":message_list[i].flag;
					  	agent_read_flag = message_list[i].agent_read_flag;
					  	customer_read_flag = message_list[i].customer_read_flag;
					  	account_id = message_list[i].account_id;
					  	cdate = message_list[i].cdate;
					  	talk_id = message_list[i].talk_id;
					  //메시지 유형이 link일때	
						if((msg.indexOf('type') > -1) && (msg.indexOf('title') > -1) && (msg.indexOf('message') > -1)){
							try{
								link_msg = JSON.parse(msg);
							}catch(ex){
								alert(ex.message);
							}
							link_type = link_msg.type;
							link_icon = link_msg.icon;
							link_title = link_msg.title;
							link_message = link_msg.message;
							link_titleUrl = link_msg.titleUrl;
							link_linkUrl = link_msg.linkUrl;
							link_imgUrl = link_msg.imgUrl;
							//cloud_20151028
							if(link_type == 'TAG_LINK'){
								link_option = link_msg.option;
								link_price = link_msg.price;
								link_orderStatus = link_msg.orderStatus;
								link_iconText = link_msg.iconText;
								link_priceColor = link_msg.priceColor;
								link_statusColor = link_msg.statusColor;
								link_orderNo = link_msg.orderNo;
								link_productNo = link_msg.productNo;
							}else if(link_type == 'GOODS_LINK'){
								link_goods_list = link_msg.goods_list;
							}else{
								link_option = "";
								link_price = "";
								link_orderStatus = "";
								link_iconText = "";
								link_priceColor = "";
								link_statusColor = "";
								link_orderNo = "";
								link_productNo = "";
							}
						}else{
							link_type = "";
							link_icon = "";
							link_title = "";
							link_message = "";
							link_titleUrl = "";
							link_linkUrl = "";
							link_imgUrl = "";
							//cloud_20151028
							link_option = "";
							link_price = "";
							link_orderStatus = "";
							link_iconText = "";
							link_priceColor = "";
							link_statusColor = "";
							link_orderNo = "";
							link_productNo = "";
						}
					  	 if(agent_read_flag == 'Y' && flag == 'C'){
							  agent_read_flag = "읽음 ";
						  }else if(agent_read_flag == 'N' && flag == 'C'){
							  agent_read_flag = "1 ";
						  }else{
							  agent_read_flag = "";
						  }
					  	if(cdate.substring(8,10) < '12'){
							  ctime = "오전 " + cdate.substring(8,10) + ":" + cdate.substring(10,12);
						  }else{
							  if(cdate.substring(8,10) == '12'){
									ctime = "오후 " + parseInt(cdate.substring(8,10)) + ":" + cdate.substring(10,12);
								  }else{
							  		ctime = "오후 " + parseInt(cdate.substring(8,10)-12) + ":" + cdate.substring(10,12); 
								  }
						  }
					  	var getDay = fu_getDay(cdate.substring(0,4), cdate.substring(4,6)-1 , cdate.substring(6,8));
					  	cdate = cdate.substring(0,4) + "년 " + cdate.substring(4,6) + "월 " + cdate.substring(6,8) + "일 " + getDay;
					  	if(cdate_ch != cdate){
					  		receive_list += "<div class=\"date\"><p>"+ cdate + "</p></div>";
						  }
					  	if(flag == 'S'){
						  receive_list += "<div id='" + messageDivId + "' class=\"message opp\"><div class=\"writer\">";
							//상담사 이미지 twinsrira5
					      /*
						  if($("#Agent_imgType").val() != ""){
							  if($("#Agent_imgType").val() == "FILE"){ //파일일때
								  img_path = $("#Agent_imgPath").val();
								  downloadUrl = $("#getUrl").val();
								  receive_list += "<img src=\""+ downloadUrl + "?fileInfo=" + img_path +"&ticketId=ETC \" alt=\"LOTTE.COM\" /> ";
							  }else{ //URL일때
								  img_url = $("#Agent_imgUrl").val();
								  receive_list += "<img src=\""+ img_url +  "\" alt=\"LOTTE.COM\" /> ";
							  }	  
						  }*/
						  receive_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
						  receive_list += "</div>";
						  agent_read_flag = "";
						}else if(flag == 'A'){
							 receive_list += "<div id='" + messageDivId + "' class=\"message opp\">";
							  if((senderGubun !="A" && $("#sameTimeCh_A").val() != ctime) || (senderGubun =="A" && $("#sameTimeCh_A").val() != ctime ) || (senderGubun !="A" && $("#sameTimeCh_C").val() == ctime)){
						        receive_list += "<div class=\"writer\">";
						      //상담사 이미지
						      /*
								  if($("#Agent_imgType").val() != ""){
									  if($("#Agent_imgType").val() == "FILE"){ //파일일때
										  img_path = $("#Agent_imgPath").val();
										  downloadUrl = $("#getUrl").val();
										  receive_list += "<img src=\""+ downloadUrl + "?fileInfo=" + img_path +"&ticketId=ETC \" alt=\"LOTTE.COM\" /> ";
									  }else{ //URL일때
										  img_url = $("#Agent_imgUrl").val();
										  receive_list += "<img src=\""+ img_url +  "\" alt=\"LOTTE.COM\" /> ";
									  }	  
								  } */
						        receive_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
						        receive_list += ""+sender+" 상담원</div>";
							  }
							   agent_read_flag = "";
						}else if(flag == 'C'){
							  	receive_list += "<div id='" + messageDivId + "' class=\"message me\">";
						}
				  	  //메시지 타입에 따른 구분
				  	  if(type == 'MSG'){//일반 메시지(www도 포함)
				  		var format = new RegExp( '[\\w-]+(\\.[\\w-]+)+([\\w-.,@?^=%&:/~+#-]*[\\w@?^=%&;/~+#-])?' );
				  		if(format.test(msg) && link_type != 'TAG_LINK' && link_type != 'SELF_LINK' && link_type != 'URL_LINK' && link_type != 'KNW_LINK' && link_type != 'GOODS_LINK' ) {
				  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
				  				receive_list += "<p class=\"text no_tail\" >";
				  			}else{
				  				receive_list += "<p class=\"text\" >";
				  			}
				  			var msgR = "";	
				  			var followParam = "";
					  		if(msg.indexOf('lotte.com') > -1){
								if(msg.indexOf('?') > -1){
									followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
								}else{
									followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
								}
							}
				  		//메시지 타입에 따른 구분
				  			if(msg.indexOf('<br//>') > 0){//줄바꿈이 온경우
				  				var msgSplit1 = msg.split("<br//>");
				  				for(var lyh1=0;lyh1 < msgSplit1.length;lyh1++){
				  					if(msgSplit1[lyh1].indexOf(' ') > 0){//줄바꿈안에 공백이 있는경우
					  					var msgSplit2 = msgSplit1[lyh1].split(" ");
					  					for(var lyh2=0;lyh2 < msgSplit2.length;lyh2++){
					  						if(format.test(msgSplit2[lyh2])){
					  							if(msgSplit2[lyh2].indexOf('http://') < 0 && msgSplit2[lyh2].indexOf('https://') < 0){
										  			msgR = "http://" + msgSplit2[lyh2];
									  			}else{
									  				msgR = msgSplit2[lyh2];
									  			}
					  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit2[lyh2] + "<br></a>";
												}else{
													receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam  + "'\">" + msgSplit2[lyh2] + "<br></a>";
												}
					  						}else{
					  							receive_list += msgSplit2[lyh2];
					  						}
					  						receive_list += " ";
					  					}
					  				}else{ //줄바꿈만 있는경우
					  					if(format.test(msgSplit1[lyh1])){
					  						if(msgSplit1[lyh1].indexOf('http://') < 0 && msgSplit1[lyh1].indexOf('https://') < 0){
									  			msgR = "http://" + msgSplit1[lyh1];
								  			}else{
								  				msgR = msgSplit1[lyh1];
								  			}
					  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit1[lyh1] + "<br></a>";
											}else{
												receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit1[lyh1] + "<br></a>";
											}
					  					}else{
					  						receive_list += msgSplit1[lyh1];
					  					}
					  				}
				  					receive_list += "<br>";
				  				}
				  			}else{ //줄바꿈 없음
				  				if(msg.indexOf(' ') > 0){ //공백이 있음
				  					var msgSplit3 = msg.split(" ");
				  					for(var lyh3=0;lyh3 < msgSplit3.length;lyh3++){
				  						if(format.test(msgSplit3[lyh3])){
				  							if(msgSplit3[lyh3].indexOf('http://') < 0 && msgSplit3[lyh3].indexOf('https://') < 0){
									  			msgR = "http://" + msgSplit3[lyh3];
								  			}else{
								  				msgR = msgSplit3[lyh3];
								  			}
				  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
				  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit3[lyh3] + "<br></a>";
											}else{
												receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit3[lyh3] + "<br></a>";
											}
				  						}else{
				  							receive_list += msgSplit3[lyh3];
				  						}
				  						receive_list += " ";
				  					}
				  				}else{ //공백이 없음
				  					if(format.test(msg)){
				  						if(msg.indexOf('http://') < 0 && msg.indexOf('https://') < 0){
								  			msgR = "http://" + msg;
							  			}else{
							  				msgR = msg;
							  			}
				  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
				  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msg + "<br></a>";
										}else{
											receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msg + "<br></a>";
										}
				  					}else{
				  						receive_list += msg;	
				  					}
				  				}
				  			}
					  		receive_list += "</p>";
					  	}else{
					  	//메시지 유형이 링크메시지이면
					  		if(link_type != ""){
					  		    if(link_type == 'TAG_LINK'){
					  		    //cloud_20151028
				  		    	receive_list += "<div class=\"text\">";
				  		    	receive_list += "<p class=\"title\">"+link_title+"</p>";
				  		    	receive_list += "<div class=\"prd_cont\">";
								var makeLinkUrl = "";
				  		    	if(link_orderNo != ""){ //주문정보
									if(makeLinkUrl == "INTERPARKTICKET"){
										receive_list += "<a href=\"#\" onclick=\"alert('티켓 주문은 WEB(PC)를 통해 확인할 수 있습니다');\">";
									}else{
										makeLinkUrl = "/mylotte/purchase/purchase_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
										//receive_list += "<a href=\"#\" onclick=\""+makeLinkUrl+"\">";
										if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
				  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
										}else{
											receive_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
										}
									}
				  		    	}else{//장바구니 정보
				  		    		makeLinkUrl = "/product/product_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
				  		    		//receive_list += "<a href=\"#\" onclick=\""+makeLinkUrl+"\">";
				  		    		if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
			  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
									}else{
										receive_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
									}
				  		    	}
				  		    	receive_list += "<div class=\"thumbnail\">";
				  		    	receive_list += "<img src=\""+link_imgUrl+"\" alt=\"\" onError=\"this.src='http://image.lotte.com/lotte/images/common/product/no_150.gif'\" />";
								if(link_orderStatus != ""){
									receive_list += "<span class=\""+link_statusColor+"\">"+link_orderStatus+"</span>";
								}
								receive_list += "</div>";
								receive_list += "<div class=\"detail\">";
								receive_list += "<P class=\"name\">"+link_message+"</p>";
								if(typeof link_option!="undefined"){
									receive_list += "<p class=\"option\">"+link_option+"</p>";
								}
								receive_list += "<P>"+link_price+"</p>";
								receive_list += "</div>";
								receive_list += "</a>";
								receive_list += "</div>";
								receive_list += "</div>";
					  		    }else if(link_type == 'SELF_LINK'){
					  		    	var followParam = "";
							  		if(link_linkUrl.indexOf('lotte.com') > -1){
										if(link_linkUrl.indexOf('?') > -1){
											followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
										}else{
											followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
										}
									}
					  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
						  				receive_list += "<p class=\"text no_tail\" >";
						  			}else{
						  				receive_list += "<p class=\"text\" >";
						  			}
					  		    	receive_list += link_message;
					  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ link_linkUrl+"');return false;\" class=\"opp_btn back_btn\">" + link_title + "</a>";
							  		}else{
							  			receive_list += "<a target=\"_blank\" href=\""+ talkPreUrl +link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
							  		}
					  		    	receive_list += "</p>";
					  		    }else if(link_type == 'KNW_LINK'){
					  		    //receive_list += link_message;
					  		    	//receive_list += link_icon ;
					  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
						  				receive_list += "<p class=\"text no_tail\" >";
						  			}else{
						  				receive_list += "<p class=\"text\" >";
						  			}
					  		    	if(link_message.indexOf('\n') > 0){
					  		    		link_message = (link_message+"").replace(/\n/gi,'<br//>');
									}
					  		    	receive_list += link_message;
					  		    	var knw_link_msg = link_linkUrl.substring(link_linkUrl.indexOf('kbId=') + 5, link_linkUrl.length); //URL에서 kb_id를 가져옴
									var kb_id_url = decodeURIComponent(knw_link_msg);  // 가져온 kb_id를 디코딩
					  		    	//receive_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\"/chat/knowConsult.jsp?kbId=" + kb_id_url +"\">" + link_title + "</a>";
					  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url +"');return false;\" class=\"opp_btn allview_btn\">" + link_title + "</a>";
							  		}else{
							  			receive_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url + "&c=mlotte&udid=&v=&cn=&cdn=\">" + link_title + "</a>";
							  		}
					  		    	receive_list += "</p>";
					  		    }else if(link_type == 'URL_LINK'){
					  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
						  				receive_list += "<p class=\"text no_tail\" >";
						  			}else{
						  				receive_list += "<p class=\"text\" >";
						  			}
					  		    	//receive_list += link_message;
					  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +link_linkUrl+"');return false;\" class=\"opp_btn back_btn\">" + link_title + "</a>";
									}else{
										var followParam = "";
								  		if(link_linkUrl.indexOf('lotte.com') > -1){
											if(link_linkUrl.indexOf('?') > -1){
												followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
											}else{
												followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
											}
										}
								  		receive_list += "<a target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
									}
					  		    	receive_list += "</p>";
					  		    }
					  		}else{
					  		//꼬리 없는 메시지
						  	    if(msg.indexOf('<!') > -1 || msg.indexOf('<?') > -1){
						  	    	msg = msg.replace(/\</g, "&lt;");
									msg = msg.replace(/\>/g, "&gt;");
						  	    }
					  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
					  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
					  			}else{
					  				receive_list += "<p class=\"text\" >" + msg + "</p>";
					  			}
					  		}
					  	}
				  	  }else if(type == 'URL'){//첨부파일
				  		ext = message_list[i].ext;
					    filename = message_list[i].ext;
					    var defaulImg = "http://image.lotte.com/lotte/mobile/chat_service/@temp_stop.png";  
					    //첨부파일 확장자 구분
					    var format01 = "\.(bmp|gif|jpg|jpeg|png|tif)$"; //이미지
					    var format02 = "\.(mov|mp4|wmv|3gp)$"; //동영상
					    var format03 = "\.(amr|mp3|m4a|ogg|3gpp)$"; //음성파일
					  	if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
					  	//var fileInfo = msg.substring(msg.indexOf("fileInfo") + 9, msg.length);
					  		receive_list +="<div class=\"thumbnail\">";
					  		//receive_list +="<a href=\"#none\" onClick=\"fn_imgPop('"+ msg+"')\">";
					  		receive_list +="<a href=\"#none\" onClick=\"fn_imgPop(this,'"+msg+"');return false;\">";
					  		receive_list +="<img src=\""+ msg  +  "\" alt=\"\" onError=\"this.src=\'"+defaulImg+"'\" />";
					  		receive_list +="</a>";
					  		receive_list +="</div>";
					  		//receive_list +="<img src=\"http://211.63.24.55:443/enomix/common/DownloadAttach.ee?fileInfo="+ fileInfo +  "\"/></a>";
					  	}
					  	if((new RegExp(format02, "i")).test(ext)){ //동영상 일때
					  		receive_list += "<div class=\"movie\">";
					  	//-------------------앱개발 완료 후 주석 해제 ----------------
					  		//receive_list += "<a href=\""+ talkPreUrl + msg+ "\">";/*[2016.01.22 주석해지]*/
					  		receive_list += "<a href=\"#\" onClick=\"go_MplayStop();return false;\">";/*[2016.01.22 주석처리]*/
					  		receive_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/@temp_play.png\" alt=\"\" />";
					  		receive_list += "</a>";
					  		receive_list += "</div>";
					  	}
					  	if((new RegExp(format03, "i")).test(ext)){ //음성파일 일때
					  		 //아이폰 일때 
					  		  receive_list += "<p class=\"text\" ><a  href=\"#none\" onClick=\"fn_unLoadV()\" class=\"voice_btn\">";
					  		  receive_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/icon_voice_btn.png\" alt=\"\" />";
					  		  receive_list += "</a></p>";
					  		//receive_list += "<a target=\"_blank\" href=\'" + msg+ "'\">" + msg + "</a>";
					  	}
				  	  }else if(type == 'EMO'){//이모티콘
				  		//var fileInfo = msg.substring(msg.indexOf("fileInfo") + 9, msg.length);
					  		receive_list += "<div class=\"thumbnail\">";
					  		receive_list += "<img style=\"width:100px;height:100px;\" src=\""+ msg +  "\"/>"; 
					  		receive_list += "</div>"; 
				  	  }else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
				  		//꼬리 없는 메시지
				  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
				  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
				  			}else{
				  				receive_list += "<p class=\"text\" >" + msg + "</p>";
				  			}
				  		//receive_list +="**************<br>";
				  		//receive_list += "<a href=\"#\" onclick=\"fn_getSuerveyList()\">상담만족도 평가 > </a>";
				  		receive_list += "<p class=\"text\">상담 후 불편사항을 작성해 주시면 서비스 개선에 적극 반영하겠습니다.<a href=\"#none\" onclick=\"fn_surveyDivShow('"+talk_id+"')\" class=\"opp_btn satisfaction_btn\">상담만족도 평가</a></p>";
				  	     //상담이 종료되었기때문에 상태를 변경
						 $("#sendBtn").html("상담<br/>신청");
						 $("#sendBtnSee").html("상담<br/>신청");
						 //$("#connectionYn").val("N");
						 $("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
						 //$("#talkEndBtn").attr("style","display:none");
				  	  }else if(type == 'WEN'){ //5분이상 대답없을시 종료
				  		//꼬리 없는 메시지
				  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
				  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
				  			}else{
				  				receive_list += "<p class=\"text\" >" + msg + "</p>";
				  			} 
				  		//상담이 종료되었기때문에 상태를 변경
					    $("#sendBtn").html("상담<br/>신청");
					    $("#sendBtnSee").html("상담<br/>신청");
					    $("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
						//$("#talkEndBtn").attr("style","display:none");
						//$("#connectionYn").val("N");
				  	  }else if(type == 'CEN'){ //고객이 종료
					  		//꼬리 없는 메시지
				  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
				  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
				  			}else{
				  				receive_list += "<p class=\"text\" >" + msg + "</p>";
				  			} 
				  		//상담이 종료되었기때문에 상태를 변경
					    $("#sendBtn").html("상담<br/>신청");
					    $("#sendBtnSee").html("상담<br/>신청");
					    $("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
						//$("#talkEndBtn").attr("style","display:none");
						//$("#connectionYn").val("N");
				  	  }else if(type == 'KNW'){ //지식상담
						var knw_msg = msg.substring(msg.indexOf('kbId=') + 5, msg.length); //URL에서 kb_id를 가져옴
						var kb_id = decodeURIComponent(knw_msg);  // 가져온 kb_id를 디코딩
						//fn_getBContents(kb_id); //상담지식 컨텐츠 가져오기
						var knw_title = $("#knwTitle").val();
						receive_list += "======================<br>";
						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
		  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +msg+"');return false;\">" + knw_title + "</a>";
						}else{
							var followParam = "";
					  		if(msg.indexOf('lotte.com') > -1){
								if(msg.indexOf('?') > -1){
									followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
								}else{
									followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
								}
							}
							receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + defaultDomain + msg + followParam + "'\">"+ knw_title +"</a>";
						}
					 }else{ //기타
						//꼬리 없는 메시지
				  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
				  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
				  			}else{
				  				receive_list += "<p class=\"text\" >" + msg + "</p>";
				  			}
				  	  }
				  	if(flag == 'C'){
				  		receive_list += "<div id=\"C"+talk_id+"_"+seq+"\" name=\"C"+talk_id+"_"+seq+"\" class=\"check\" style=\"display:block\"><span id=\"R"+talk_id+"_"+seq+"\" name=\"R"+talk_id+"_"+seq+"\">"+agent_read_flag + "</span>" + ctime +"</div>";
				  	}else if(flag == 'A'){
					  	 receive_list += "<div id=\"A"+talk_id+"_"+seq+"\" name=\"A"+talk_id+"_"+seq+"\" class=\"check\" style=\"display:block\">" + ctime +"</div>";  
					  	 //새로운 메시지를 받았기 때문에 이전 메시지는 상담사 읽음처리
					  	//$("#R"+talk_id+"_"+eval(seq-1)).text("읽음  ");
					  	fn_agentRead(talk_id,'seq','service');
				  	}else{
					  	receive_list += "<div class=\"check\" style=\"display:block\">"+agent_read_flag + "" + ctime +"</div>"; 
					  	 //새로운 메시지를 받았기 때문에 이전 메시지는 상담사 읽음처리
					  	//$("#R"+talk_id+"_"+eval(seq-1)).text("읽음  ");
					  	//fn_agentRead(talk_id,'seq','service');
				  	}
				  	 //동일시간 비교
				  	if(flag == 'C' && $("#sameTimeCh_C").val() == ctime){
						  var C_check = "C"+talk_id+"_"+eval(seq-1);
						  sameTime_C[sameTimeCnt_C] = C_check;
						  sameTimeCnt_C++;
					  }
				  	if(flag == 'A' && $("#sameTimeCh_A").val() == ctime){
						  var A_check = "A"+talk_id+"_"+eval(seq-1);
						  sameTime_A[sameTimeCnt_A] = A_check;
						  sameTimeCnt_A++;
					 }
				  	  if(flag == 'C'){
				  		$("#sameTimeCh_C").val(ctime);
				  	  }else if(flag == 'A'){
				  		$("#sameTimeCh_A").val(ctime);  
				  	  }
				  	  $("#senderGubun").val(flag);  
				  	  $("#getTalkId").val(talk_id);
					  $("#getTalkSeq").val(seq);
					  $("#cdate_ch").val(cdate);
					  receive_list +="</div>";
				  }				  
				 // $("#chatIng").append(receive_list);
				//-- cloud 추가 스크롤  이동[S] 글작성시 아래로 이동 히스토리 불러올때는  스크롤 높이 맞춤
				  //var divdiv = document.getElementById("view");
				  var scrollBottomYn = true;
				  if(flag == "C"){
					  if(holdScroll){
						  $("#chatIng").append(receive_list);
						  if(actTp == ""){
							  scrollBottomMove();  
						  }
					  }else{
						  $("#chatIng").prepend(receive_list);
						  /* diffScrollHeight = $(document).height() - prevScrollHeight;
						  $(window).scrollTop(diffScrollHeight); */
						  if(actTp == ""){
							  scrollBottomMove();  
						  }
					  }
				  }else{ //A,S
				       if($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
				    	   scrollBottomYn = true;
						   scrollBottomMove();  
					  }else{
						  scrollBottomYn = false;
					  }
				      $("#chatIng").append(receive_list);
				  }
				//고객 같은시간 체크해서 같은시간 최종메시지만 읽음 및 시간 표시
				  for(var m = 0; m < sameTime_C.length; m ++){
					$("#"+sameTime_C[m]).attr("style","display:none");
				  }
				//상담원 같은시간 체크해서 같은시간 최종메시지만 읽음 및 시간 표시
				  for(var n = 0; n < sameTime_A.length; n ++){
					$("#"+sameTime_A[n]).attr("style","display:none");
					$("#I"+sameTime_A[n]).attr("style","display:none");
				  }
			      //-- cloud 추가 스크롤  이동[E]
				//---cloud[S] 이전상담이력조회중 새글 왓을때 새글Div띄우기
				  if(flag == 'A' || flag == 'S'){ //상담사
					  //msg = (msg+"").replace('<br//>','');
					  if(!scrollBottomYn) {
						  if(link_title.indexOf('<br//>') > 0){
								link_title = (link_title+"").replace(/<br\/\/>/gi,'');
							}
							if(msg.indexOf('<br//>') > 0){
								msg = (msg+"").replace(/<br\/\/>/gi,'');
							}
						$("#nowMsgDiv").html("");
						if(type == 'MSG'){//일반메세지
							//CLOUD20151019
							if(link_type != ""){
								$("#nowMsgDiv").html("<p>"+ link_title +"</p>");
							}else{
								$("#nowMsgDiv").html("<p>"+msg+"</p>");
							}
						}else if(type == 'URL'){//첨부파일
							if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
								$("#nowMsgDiv").html("<p>"+"이미지"+"</p>");
							}else if((new RegExp(format02, "i")).test(msg)){ //동영상 일때
								$("#nowMsgDiv").html("<p>"+"동영상"+"</p>");
							}else if((new RegExp(format03, "i")).test(msg)){ //음성파일 일때
								$("#nowMsgDiv").html("<p>"+"음성파일"+"</p>");
							}
						}else if(type == 'EMO'){//이모티콘
							$("#nowMsgDiv").html("<p>"+"이모티콘"+"</p>");
						}else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
							$("#nowMsgDiv").html("<p>"+msg+"</p>");
						}else if(type == 'WEN'){ //5분이상 대답없을시 종료
							$("#nowMsgDiv").html("<p>"+msg+"</p>");
						}else if(type == 'KNW'){ //지식상담
							$("#nowMsgDiv").html("<p>"+"지식상담"+"</p>");
						}else{ //기타
							$("#nowMsgDiv").html("<p>"+msg+"</p>");
						}
						 if ( $('#emoticonInfo').val() != "" )
						{
							$("#chatInput").find("> .now_message").css( "top" , $("#chatInput").find("> .now_message").height() );
						} else {
							$("#chatInput").find("> .now_message").css( "top" , "" );
						}
						$("#nowMsgDiv").show();
					}else{
							scrollBottomMove();  
					}
				  }
				  //---cloud[E] 이전상담이력조회중 새글 왓을때 새글Div띄우기
				/*
				//아직 웹소켓 연결이 안되었으면 연결
				  if($("#connectionYn").val() == 'N'){
					  loadConnection();//웹소켓 연결 
				  }
					*/
					if($("#connectionYn").val() == "Y"){
						if(actTp == ""){
							$("#msg").focus();
						}
					}
					//$("#chatLoading2").attr("class","attach_loading none");	
			  }else if(result.error_code == -1006 || result.error_code == -1007){ // 파일첨부 불가일 때 에러
					alert(result.error_message);
			  } else{ 
				  if($("#getTalkId").val() !=""){
				  	alert(result.error_message);
				  }
				  //$("#chatLoading2").attr("class","attach_loading none");
			  }
			 }
			 //$("#chatLoading2").attr("class","attach_loading none");
		 },
 		 error : function(request, status, error) {
			 //$("#chatLoading2").attr("class","attach_loading none");
			//alert('오류가 발생하였습니다.');
		 }
		});
		request.done(function(result){
		});
		request.fail(function(jqXHR, textStatus){ // 에러 발생
			//alert("서비스 연결이 원활하지 않습니다.\r잠시후 다시 이용해 주세요.");
		});	
}
/* ******************************************
메시지 그리기 fn_send에서만 사용
******************************************* */
var isGetMessage3Ing = false;
function fn_getMessage3(result){
	isGetMessage3Ing = true;
	//상담사 메시지와 고객전송 메시지가 있을때 동일내용을 가져오지않기 위한 처리
	var tkCh = 'C'+ $("#getTalkId").val() + '_' + eval(' +$("#getTalkSeq").val() + 1 ');
    if($("#" + tkCh).val() != undefined){
        return;
    }
    // ---end 
		var mForm = document.frm; 
		var obj = new Object(); 
		command = "TalkReceive";
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.service_type = service_type;
		obj.customer_id = customer_id;
		obj.talk_id = $("#getTalkId").val();
		obj.seq = $("#getTalkSeq").val();
		var cmd = JSON.stringify(obj); 
		mForm.cmd2.value = cmd;
		var param = "cmd=" + cmd;
		var receive_list = "";
		//동일시간 일때 div id를 담을 변수
		var sameTime_C = []; //고객
		var sameTime_A = []; //상담사
		var sameTimeCnt_C = 0;
		var sameTimeCnt_A = 0;
	 if (result != null){
		 if (result.error_code == 0) {
		var data_message = new Object();
			data_message = result.data;
		var message_list = [];
			message_list = data_message.messages;
		var type = ""; 
		var seq = "";
		var sender = "";
		var msg = "";
		var flag = "";
	    var agent_read_flag = "";
	    var customer_read_flag = "";
	    var account_id = "";
	    var cdate = "";
	    var talk_id = "";
	    var ctime = "";
	    var cdate_ch = ""; //상단 날짜가 중복되지 않았는지 체크
	    var senderGubun = ""; //발신인 구분
           //상담사 이미지
	    var img_path = "";
	    var img_url = "";
	    var downloadUrl = "";
	    //첨부파일 있을때
	    var ext = "";
	    var filename = "";
	    //메시지 유형이 link_msg일때 처리할 변수들(장바구니, 지식상담.. 등등)
		var link_msg = new Object(); 
		var link_type = "";
		var link_icon = "";
		var link_title = "";
		var link_message = "";
		var link_titleUrl = "";
		var link_linkUrl = "";
		var link_imgUrl = "";
		//TAG_LINK 추가사용 cloud_20151028
		var link_option = "";
		var link_price = "";
		var link_orderStatus = "";
		var link_iconText = "";
		var link_priceColor = "";
		var link_statusColor = "";
		var link_orderNo = "";
		var link_productNo = "";
		var link_goods_list = null; // 추천상품
		  for(var i = 0; i < message_list.length; i++){
			    var messageDivId = message_list[i].talk_id + "_" + message_list[i].seq;
				// 메시지 중복 방지 처리
				if ($("#" + messageDivId).length > 0)
				{
					continue;
				}
			    cdate_ch = $("#cdate_ch").val();
			    senderGubun = $("#senderGubun").val();
			  	type = message_list[i].type;
			  	seq = message_list[i].seq;
			  	sender = message_list[i].sender;
			  	msg = message_list[i].msg;
			  	if(msg.indexOf('\n') > 0){
					msg = (msg+"").replace(/\n/gi,'<br//>');
				}
			  	textareaInputInit();
			  	//flag = message_list[i].flag;
			  	flag = message_list[i].flag == "H"?"A":message_list[i].flag;
			  	agent_read_flag = message_list[i].agent_read_flag;
			  	customer_read_flag = message_list[i].customer_read_flag;
			  	account_id = message_list[i].account_id;
			  	cdate = message_list[i].cdate;
			  	talk_id = message_list[i].talk_id;
			  //메시지 유형이 link일때	
				if((msg.indexOf('type') > -1) && (msg.indexOf('title') > -1) && (msg.indexOf('message') > -1)){
					try{
						link_msg = JSON.parse(msg);
					}catch(ex){
						alert(ex.message);
					}
					link_type = link_msg.type;
					link_icon = link_msg.icon;
					link_title = link_msg.title;
					link_message = link_msg.message;
					link_titleUrl = link_msg.titleUrl;
					link_linkUrl = link_msg.linkUrl;
					link_imgUrl = link_msg.imgUrl;
					//cloud_20151028
					if(link_type == 'TAG_LINK'){
						link_option = link_msg.option;
						link_price = link_msg.price;
						link_orderStatus = link_msg.orderStatus;
						link_iconText = link_msg.iconText;
						link_priceColor = link_msg.priceColor;
						link_statusColor = link_msg.statusColor;
						link_orderNo = link_msg.orderNo;
						link_productNo = link_msg.productNo;
					}else if(link_type == 'GOODS_LINK'){
						link_goods_list = link_msg.goods_list;
					}else{
						link_option = "";
						link_price = "";
						link_orderStatus = "";
						link_iconText = "";
						link_priceColor = "";
						link_statusColor = "";
						link_orderNo = "";
						link_productNo = "";
					}
				}else{
					link_type = "";
					link_icon = "";
					link_title = "";
					link_message = "";
					link_titleUrl = "";
					link_linkUrl = "";
					link_imgUrl = "";
					//cloud_20151028
					link_option = "";
					link_price = "";
					link_orderStatus = "";
					link_iconText = "";
					link_priceColor = "";
					link_statusColor = "";
					link_orderNo = "";
					link_productNo = "";
				}
			  	 if(agent_read_flag == 'Y' && flag == 'C'){
					  agent_read_flag = "읽음 ";
				  }else if(agent_read_flag == 'N' && flag == 'C'){
					  agent_read_flag = "1 ";
				  }else{
					  agent_read_flag = "";
				  }
			  	if(cdate.substring(8,10) < '12'){
					  ctime = "오전 " + cdate.substring(8,10) + ":" + cdate.substring(10,12);
				  }else{
					  if(cdate.substring(8,10) == '12'){
							ctime = "오후 " + parseInt(cdate.substring(8,10)) + ":" + cdate.substring(10,12);
						  }else{
					  		ctime = "오후 " + parseInt(cdate.substring(8,10)-12) + ":" + cdate.substring(10,12); 
						  }
				  }
			  	var getDay = fu_getDay(cdate.substring(0,4), cdate.substring(4,6)-1 , cdate.substring(6,8));
			  	cdate = cdate.substring(0,4) + "년 " + cdate.substring(4,6) + "월 " + cdate.substring(6,8) + "일 " + getDay;
			  	if(cdate_ch != cdate){
			  		receive_list += "<div class=\"date\"><p>"+ cdate + "</p></div>";
				  }
			  	if(flag == 'S'){
				  receive_list += "<div id='" + messageDivId + "' class=\"message opp\"><div class=\"writer\">";
				  receive_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
				  receive_list += "</div>";
				  agent_read_flag = "";
				}else if(flag == 'A'){
					 receive_list += "<div id='" + messageDivId + "' class=\"message opp\">";
					  if((senderGubun !="A" && $("#sameTimeCh_A").val() != ctime) || (senderGubun =="A" && $("#sameTimeCh_A").val() != ctime ) || (senderGubun !="A" && $("#sameTimeCh_C").val() == ctime)){
				        receive_list += "<div class=\"writer\">";
				        receive_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
				        receive_list += ""+sender+" 상담원</div>";
					  }
					   agent_read_flag = "";
				}else if(flag == 'C'){
					  	receive_list += "<div id='" + messageDivId + "' class=\"message me\">";
				}
		  	  //메시지 타입에 따른 구분
		  	  if(type == 'MSG'){//일반 메시지(www도 포함)
		  		var format = new RegExp( '[\\w-]+(\\.[\\w-]+)+([\\w-.,@?^=%&:/~+#-]*[\\w@?^=%&;/~+#-])?' );
		  		if(format.test(msg) && link_type != 'TAG_LINK' && link_type != 'SELF_LINK' && link_type != 'URL_LINK' && link_type != 'KNW_LINK' && link_type != 'GOODS_LINK' ) {
		  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
		  				receive_list += "<p class=\"text no_tail\" >";
		  			}else{
		  				receive_list += "<p class=\"text\" >";
		  			}
		  			var msgR = "";	
		  			var followParam = "";
			  		if(msg.indexOf('lotte.com') > -1){
						if(msg.indexOf('?') > -1){
							followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
						}else{
							followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
						}
					}
					//메시지 타입에 따른 구분
		  			if(msg.indexOf('<br//>') > 0){//줄바꿈이 온경우
		  				var msgSplit1 = msg.split("<br//>");
		  				for(var lyh1=0;lyh1 < msgSplit1.length;lyh1++){
		  					if(msgSplit1[lyh1].indexOf(' ') > 0){//줄바꿈안에 공백이 있는경우
			  					var msgSplit2 = msgSplit1[lyh1].split(" ");
			  					for(var lyh2=0;lyh2 < msgSplit2.length;lyh2++){
			  						if(format.test(msgSplit2[lyh2])){
			  							if(msgSplit2[lyh2].indexOf('http://') < 0 && msgSplit2[lyh2].indexOf('https://') < 0){
								  			msgR = "http://" + msgSplit2[lyh2];
							  			}else{
							  				msgR = msgSplit2[lyh2];
							  			}
			  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
			  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit2[lyh2] + "<br></a>";
										}else{
											receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam  + "'\">" + msgSplit2[lyh2] + "<br></a>";
										}
			  						}else{
			  							receive_list += msgSplit2[lyh2];
			  						}
			  						receive_list += " ";
			  					}
			  				}else{ //줄바꿈만 있는경우
			  					if(format.test(msgSplit1[lyh1])){
			  						if(msgSplit1[lyh1].indexOf('http://') < 0 && msgSplit1[lyh1].indexOf('https://') < 0){
							  			msgR = "http://" + msgSplit1[lyh1];
						  			}else{
						  				msgR = msgSplit1[lyh1];
						  			}
			  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
		  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit1[lyh1] + "<br></a>";
									}else{
										receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit1[lyh1] + "<br></a>";
									}
			  					}else{
			  						receive_list += msgSplit1[lyh1];
			  					}
			  				}
			  				receive_list += "<br>";
		  				}
		  			}else{ //줄바꿈 없음
		  				if(msg.indexOf(' ') > 0){ //공백이 있음
		  					var msgSplit3 = msg.split(" ");
		  					for(var lyh3=0;lyh3 < msgSplit3.length;lyh3++){
		  						if(format.test(msgSplit3[lyh3])){
		  							if(msgSplit3[lyh3].indexOf('http://') < 0 && msgSplit3[lyh3].indexOf('https://') < 0){
							  			msgR = "http://" + msgSplit3[lyh3];
						  			}else{
						  				msgR = msgSplit3[lyh3];
						  			}
		  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
		  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit3[lyh3] + "<br></a>";
									}else{
										receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit3[lyh3] + "<br></a>";
									}
		  						}else{
		  							receive_list += msgSplit3[lyh3];
		  						}
		  						receive_list += " ";
		  					}
		  				}else{ //공백이 없음
		  					if(format.test(msg)){
		  						if(msg.indexOf('http://') < 0 && msg.indexOf('https://') < 0){
						  			msgR = "http://" + msg;
					  			}else{
					  				msgR = msg;
					  			}
		  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
	  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msg + "<br></a>";
								}else{
									receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msg + "<br></a>";
								}
		  					}else{
		  						receive_list += msg;	
		  					}
		  				}
		  			}
			  		receive_list += "</p>";
			  	}else{
			  	//메시지 유형이 링크메시지이면
			  		if(link_type != ""){
			  		    if(link_type == 'TAG_LINK'){
			  		    //cloud_20151028
		  		    	receive_list += "<div class=\"text\">";
		  		    	receive_list += "<p class=\"title\">"+link_title+"</p>";
		  		    	receive_list += "<div class=\"prd_cont\">";
						var makeLinkUrl = "";
		  		    	if(link_orderNo != ""){ //주문정보
							if(makeLinkUrl == "INTERPARKTICKET"){
								receive_list += "<a href=\"#\" onclick=\"alert('티켓 주문은 WEB(PC)를 통해 확인할 수 있습니다');\">";
							}else{
								makeLinkUrl = "/mylotte/purchase/purchase_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
								if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
		  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
								}else{
									receive_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
								}
							}
		  		    	}else{//장바구니 정보
		  		    		makeLinkUrl = "/product/product_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
		  		    		if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
	  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
							}else{
								receive_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
							}
		  		    	}
		  		    	receive_list += "<div class=\"thumbnail\">";
		  		    	receive_list += "<img src=\""+link_imgUrl+"\" alt=\"\" onError=\"this.src='http://image.lotte.com/lotte/images/common/product/no_150.gif'\" />";
						if(link_orderStatus != ""){
							receive_list += "<span class=\""+link_statusColor+"\">"+link_orderStatus+"</span>";
						}
						receive_list += "</div>";
						receive_list += "<div class=\"detail\">";
						receive_list += "<P class=\"name\">"+link_message+"</p>";
						if(typeof link_option!="undefined"){
							receive_list += "<p class=\"option\">"+link_option+"</p>";
						}
						receive_list += "<P>"+link_price+"</p>";
						receive_list += "</div>";
						receive_list += "</a>";
						receive_list += "</div>";
						receive_list += "</div>";
			  		    }else if(link_type == 'SELF_LINK'){
			  		    	var followParam = "";
					  		if(link_linkUrl.indexOf('lotte.com') > -1){
								if(link_linkUrl.indexOf('?') > -1){
									followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
								}else{
									followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
								}
							}
			  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
				  				receive_list += "<p class=\"text no_tail\" >";
				  			}else{
				  				receive_list += "<p class=\"text\" >";
				  			}
			  		    	receive_list += link_message;
			  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
			  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ link_linkUrl+"');return false;\" class=\"opp_btn back_btn\">" + link_title + "</a>";
					  		}else{
					  			receive_list += "<a target=\"_blank\" href=\""+ talkPreUrl +link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
					  		}
			  		    	receive_list += "</p>";
			  		    }else if(link_type == 'KNW_LINK'){
			  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
				  				receive_list += "<p class=\"text no_tail\" >";
				  			}else{
				  				receive_list += "<p class=\"text\" >";
				  			}
			  		    	if(link_message.indexOf('\n') > 0){
			  		    		link_message = (link_message+"").replace(/\n/gi,'<br//>');
							}
			  		    	receive_list += link_message;
			  		    	var knw_link_msg = link_linkUrl.substring(link_linkUrl.indexOf('kbId=') + 5, link_linkUrl.length); //URL에서 kb_id를 가져옴
							var kb_id_url = decodeURIComponent(knw_link_msg);  // 가져온 kb_id를 디코딩
							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
			  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url +"');return false;\" class=\"opp_btn allview_btn\">" + link_title + "</a>";
					  		}else{
					  			receive_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url + "&c=mlotte&udid=&v=&cn=&cdn=\">" + link_title + "</a>";
					  		}
			  		    	receive_list += "</p>";
			  		    }else if(link_type == 'URL_LINK'){
			  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
				  				receive_list += "<p class=\"text no_tail\" >";
				  			}else{
				  				receive_list += "<p class=\"text\" >";
							}
			  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){
			  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +link_linkUrl +"');return false;\" class=\"opp_btn back_btn\">" + link_title + "</a>";
			  		    	}else{
			  		    		var followParam = "";
						  		if(link_linkUrl.indexOf('lotte.com') > -1){
									if(link_linkUrl.indexOf('?') > -1){
										followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
									}else{
										followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
									}
								}
						  		receive_list += "<a target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";	
			  		    	}
			  		    	receive_list += "</p>";
			  		    }
			  		}else{
			  		//꼬리 없는 메시지
				  	    if(msg.indexOf('<!') > -1 || msg.indexOf('<?') > -1){
				  	    	msg = msg.replace(/\</g, "&lt;");
							msg = msg.replace(/\>/g, "&gt;");
				  	    }
			  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
			  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
			  			}else{
			  				receive_list += "<p class=\"text\" >" + msg + "</p>";
			  			}
			  		}
			  	}
		  	  }else if(type == 'URL'){//첨부파일
		  		ext = message_list[i].ext;
			    filename = message_list[i].ext;
			    var defaulImg = "http://image.lotte.com/lotte/mobile/chat_service/@temp_stop.png";  
			    //첨부파일 확장자 구분
			    var format01 = "\.(bmp|gif|jpg|jpeg|png|tif)$"; //이미지
			    var format02 = "\.(mov|mp4|wmv|3gp)$"; //동영상
			    var format03 = "\.(amr|mp3|m4a|ogg|3gpp)$"; //음성파일
			  	if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
			  		receive_list +="<div class=\"thumbnail\">";
			  		receive_list +="<a href=\"#none\" onClick=\"fn_imgPop(this,'"+msg+"');return false;\">";
			  		receive_list +="<img src=\""+ msg  +  "\" alt=\"\" onError=\"this.src=\'"+defaulImg+"'\" />";
			  		receive_list +="</a>";
			  		receive_list +="</div>";
			  	}
			  	if((new RegExp(format02, "i")).test(ext)){ //동영상 일때
			  		receive_list += "<div class=\"movie\">";
			  	//-------------------앱개발 완료 후 주석 해제 ----------------
			  		//receive_list += "<a href=\""+ talkPreUrl + msg+ "\">";/*[2016.01.22 주석해지]*/
			  		receive_list += "<a href=\"#\" onClick=\"go_MplayStop();return false;\">";/*[2016.01.22 주석처리]*/
			  		receive_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/@temp_play.png\" alt=\"\" />";
			  		receive_list += "</a>";
			  		receive_list += "</div>";
			  	}
			  	if((new RegExp(format03, "i")).test(ext)){ //음성파일 일때
			  		 //아이폰 일때 
			  		  receive_list += "<p class=\"text\" ><a  href=\"#none\" onClick=\"fn_unLoadV()\" class=\"voice_btn\">";
			  		  receive_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/icon_voice_btn.png\" alt=\"\" />";
			  		  receive_list += "</a></p>";
			  	}
		  	  }else if(type == 'EMO'){//이모티콘
			  		receive_list += "<div class=\"thumbnail\">";
			  		receive_list += "<img style=\"width:100px;height:100px;\" src=\""+ msg +  "\"/>"; 
			  		receive_list += "</div>"; 
		  	  }else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
		  		//꼬리 없는 메시지
		  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
		  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
		  			}else{
		  				receive_list += "<p class=\"text\" >" + msg + "</p>";
		  			}
		  		receive_list += "<p class=\"text\">상담 후 불편사항을 작성해 주시면 서비스 개선에 적극 반영하겠습니다.<a href=\"#none\" onclick=\"fn_surveyDivShow('"+talk_id+"')\" class=\"opp_btn satisfaction_btn\">상담만족도 평가</a></p>";
		  	     //상담이 종료되었기때문에 상태를 변경
				 $("#sendBtn").html("상담<br/>신청");
				 $("#sendBtnSee").html("상담<br/>신청");
				 $("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
		  	  }else if(type == 'WEN'){ //5분이상 대답없을시 종료
		  		//꼬리 없는 메시지
		  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
		  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
		  			}else{
		  				receive_list += "<p class=\"text\" >" + msg + "</p>";
		  			} 
		  		//상담이 종료되었기때문에 상태를 변경
			    $("#sendBtn").html("상담<br/>신청");
			    $("#sendBtnSee").html("상담<br/>신청");
			    $("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
		  	  }else if(type == 'CEN'){ //고객이 종료
			  		//꼬리 없는 메시지
		  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
		  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
		  			}else{
		  				receive_list += "<p class=\"text\" >" + msg + "</p>";
		  			} 
		  		//상담이 종료되었기때문에 상태를 변경
			    $("#sendBtn").html("상담<br/>신청");
			    $("#sendBtnSee").html("상담<br/>신청");
			    $("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
		  	  }else if(type == 'KNW'){ //지식상담
				var knw_msg = msg.substring(msg.indexOf('kbId=') + 5, msg.length); //URL에서 kb_id를 가져옴
				var kb_id = decodeURIComponent(knw_msg);  // 가져온 kb_id를 디코딩
				var knw_title = $("#knwTitle").val();
				receive_list += "======================<br>";
				if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +msg+"');return false;\">" + knw_title + "</a>";
				}else{
					var followParam = "";
			  		if(msg.indexOf('lotte.com') > -1){
						if(msg.indexOf('?') > -1){
							followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
						}else{
							followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
						}
					}
					receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + defaultDomain + msg + followParam + "'\">"+ knw_title +"</a>";
				}
			 }else{ //기타
				//꼬리 없는 메시지
		  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
		  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
		  			}else{
		  				receive_list += "<p class=\"text\" >" + msg + "</p>";
		  			}
		  	  }
		  	if(flag == 'C'){
		  		receive_list += "<div id=\"C"+talk_id+"_"+seq+"\" name=\"C"+talk_id+"_"+seq+"\" class=\"check\" style=\"display:block\"><span id=\"R"+talk_id+"_"+seq+"\" name=\"R"+talk_id+"_"+seq+"\">"+agent_read_flag + "</span>" + ctime +"</div>";
		  	}else if(flag == 'A'){
			  	 receive_list += "<div id=\"A"+talk_id+"_"+seq+"\" name=\"A"+talk_id+"_"+seq+"\" class=\"check\" style=\"display:block\">" + ctime +"</div>";  
			  	fn_agentRead(talk_id,'seq','service');
		  	}else{
			  	receive_list += "<div class=\"check\" style=\"display:block\">"+agent_read_flag + "" + ctime +"</div>"; 
		  	}
		  	 //동일시간 비교
		  	if(flag == 'C' && $("#sameTimeCh_C").val() == ctime){
				  var C_check = "C"+talk_id+"_"+eval(seq-1);
				  sameTime_C[sameTimeCnt_C] = C_check;
				  sameTimeCnt_C++;
			  }
		  	if(flag == 'A' && $("#sameTimeCh_A").val() == ctime){
				  var A_check = "A"+talk_id+"_"+eval(seq-1);
				  sameTime_A[sameTimeCnt_A] = A_check;
				  sameTimeCnt_A++;
			 }
		  	  if(flag == 'C'){
		  		$("#sameTimeCh_C").val(ctime);
		  	  }else if(flag == 'A'){
		  		$("#sameTimeCh_A").val(ctime);  
		  	  }
		  	  $("#senderGubun").val(flag);  
		  	  $("#getTalkId").val(talk_id);
			  $("#getTalkSeq").val(seq);
			  $("#cdate_ch").val(cdate);
			  receive_list +="</div>";
		  }
		//-- cloud 추가 스크롤  이동[S] 글작성시 아래로 이동 히스토리 불러올때는  스크롤 높이 맞춤
		  //var divdiv = document.getElementById("view");
		  var scrollBottomYn = true;
		  if(flag == "C"){
			  if(holdScroll){
				  $("#chatIng").append(receive_list);
				  scrollBottomMove();
			  }else{
				  $("#chatIng").prepend(receive_list);
				  scrollBottomMove();
			  }
		  }else{ //A,S
		       if($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
		    	   scrollBottomYn = true;
					  scrollBottomMove();
			  }else{
				  scrollBottomYn = false;
			  }
		      $("#chatIng").append(receive_list);
		  }
		//고객 같은시간 체크해서 같은시간 최종메시지만 읽음 및 시간 표시
		  for(var m = 0; m < sameTime_C.length; m ++){
			$("#"+sameTime_C[m]).attr("style","display:none");
		  }
		//상담원 같은시간 체크해서 같은시간 최종메시지만 읽음 및 시간 표시
		  for(var n = 0; n < sameTime_A.length; n ++){
			$("#"+sameTime_A[n]).attr("style","display:none");
			$("#I"+sameTime_A[n]).attr("style","display:none");
		  }
	      //-- cloud 추가 스크롤  이동[E]
		//---cloud[S] 이전상담이력조회중 새글 왓을때 새글Div띄우기
		  if(flag == 'A' || flag == 'S'){ //상담사
			if(!scrollBottomYn) {
				 if(link_title.indexOf('<br//>') > 0){
						link_title = (link_title+"").replace(/<br\/\/>/gi,'');
					}
					if(msg.indexOf('<br//>') > 0){
						msg = (msg+"").replace(/<br\/\/>/gi,'');
					}
				$("#nowMsgDiv").html("");
				if(type == 'MSG'){//일반메세지
					//CLOUD20151019
					if(link_type != ""){
						$("#nowMsgDiv").html("<p>"+ link_title +"</p>");
					}else{
						$("#nowMsgDiv").html("<p>"+msg+"</p>");
					}
				}else if(type == 'URL'){//첨부파일
					if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
						$("#nowMsgDiv").html("<p>"+"이미지"+"</p>");
					}else if((new RegExp(format02, "i")).test(msg)){ //동영상 일때
						$("#nowMsgDiv").html("<p>"+"동영상"+"</p>");
					}else if((new RegExp(format03, "i")).test(msg)){ //음성파일 일때
						$("#nowMsgDiv").html("<p>"+"음성파일"+"</p>");
					}
				}else if(type == 'EMO'){//이모티콘
					$("#nowMsgDiv").html("<p>"+"이모티콘"+"</p>");
				}else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
					$("#nowMsgDiv").html("<p>"+msg+"</p>");
				}else if(type == 'WEN'){ //5분이상 대답없을시 종료
					$("#nowMsgDiv").html("<p>"+msg+"</p>");
				}else if(type == 'KNW'){ //지식상담
					$("#nowMsgDiv").html("<p>"+"지식상담"+"</p>");
				}else{ //기타
					$("#nowMsgDiv").html("<p>"+msg+"</p>");
				}
				 if ( $('#emoticonInfo').val() != "" )
					{
						$("#chatInput").find("> .now_message").css( "top" , $("#chatInput").find("> .now_message").height() );
					} else {
						$("#chatInput").find("> .now_message").css( "top" , "" );
					}
				$("#nowMsgDiv").show();
			}else{
				scrollBottomMove();
			}
		  }
		  //---cloud[E] 이전상담이력조회중 새글 왓을때 새글Div띄우기
			if($("#connectionYn").val() == "Y"){
				$("#msg").focus();
			}
			isGetMessage3Ing = false;
	  }else if(result.error_code == -1006 || result.error_code == -1007){ // 파일첨부 불가일 때 에러
		  isGetMessage3Ing = false;
		  alert(result.error_message);
	  } else{ 
		  isGetMessage3Ing = false;
		  if($("#getTalkId").val() !=""){
		  	alert(result.error_message);
		  }
	  }
	 }
	 $("#chatLoading2").attr("class","attach_loading none");
}
/* ******************************************
첨부된 파일 불러오기
******************************************* */
function fn_loadFile(){
	$("#file_add").attr("style" ,"display:block");
}
/* ******************************************
첨부된 파일 체크(확장자 및 사이즈) 
******************************************* */
var fileType = "";
function checkExt(type , target){
	var file_ext = target.substring(target.indexOf('.')+1,target.length);
	$("#chat").css( "bottom" ,  "" );
	fileType = type;
    var FORMAT = ""; //확장자
    var maxSize  = 10*1024*1000;   //파일사이즈
    FORMAT = "\.(bmp|gif|jpg|jpeg|png|tif|mov|mp4|amr|mp3|m4a|ogg|wmv|3gp|3gpp)$"; //통합처리
	$("#file_type").val("ATTACH");
	maxSize = 20*1024*1000;
	//확장자 체크
    if(!(new RegExp(FORMAT, "i")).test(target)){
		alert("첨부가 불가능한 파일입니다.");
		$("#" + type).val("");
		return false;
	}
	//파일 사이즈 체크
	var fSize = $("#" + type)[0].files[0].size; 
	var fileSize = Math.round(fSize); 
	if(fileSize > maxSize) {
        if(maxSize == 10*1024*1000){
        	alert("첨부파일 사이즈는 10MB 이내로 등록 가능합니다.");
        }else{
        	alert("첨부파일 사이즈는 20MB 이내로 등록 가능합니다.");
        }
		$("#" + type).val("");
        return false;
  }
	fn_send();
}
/* ******************************************
고객 상담 종료
******************************************* */
function fn_talkEnd(other_tf){
		other_tf = (typeof other_tf=="undefined"?false:other_tf); // 다른 톡 종료
		//상담진행중이 아닐때 종료
		if($("#sendBtn").html() == "상담<br>신청" && !other_tf){
			var conf = confirm("채팅방을 나가시겠습니까? \n 확인 버튼을 클릭 시 마이롯데로 이동합니다.");
			if(conf){
				//goChatOut();
				goChartOutMylotte();
			}
		}else{	
			if(isPossibleTp == false && !other_tf){
				var conf = confirm("채팅방을 나가시겠습니까? \n 확인 버튼을 클릭 시 마이롯데로 이동합니다.");
				if(conf){
					//goChatOut();
					goChartOutMylotte();
				}
				return;
			}
			var conf = other_tf;
			if (!other_tf) {
				conf = confirm("진행중인 톡 상담을 종료하고 채팅방을  나가시겠습니까? \n 확인 버튼을 클릭 시 마이롯데로 이동합니다.");
			}
			if(conf){
				var mForm = document.frm; 
				var obj = new Object(); 
				command = "TalkEnd";
				obj.command = command; 
				obj.domain_id = domain_id;
				obj.service_type = service_type;
				obj.customer_id = customer_id;
				obj.talk_id = $("#getTalkId").val();
				obj.seq = $("#getTalkSeq").val();
				var cmd = JSON.stringify(obj); 
				mForm.cmd2.value = cmd;
				var param = "cmd=" + cmd;
				var receive_list = "";
				var request = $.ajax({
				 url:url,
				 type:"POST",
				 data: param,
				 dataType:"json"
				});
				request.done(function(result){ 
				 if (result != null){
					if (result.error_code == 0) { 
						//$("#connectionYn").val('N');
						 $("#sendBtn").html("상담<br/>신청");
							$("#chatInput").find("> .keypad_input").find("> .send > button").attr("disabled",false);
						 $("#sendBtnSee").html("상담<br/>신청");
						 fn_getMessage2();
						 $("#head").find("> ul > li.out").attr("class","out");
				  }else{ 
				  } 
				 }
				if (other_tf){ // 다른 톡 닫기
					sessionStorage.setItem("rop_referrer", document.referrer);
					location.reload();
				}else{
					//goChatOut();
					goChartOutMylotte();
				}
				});
				request.fail(function(jqXHR, textStatus){ // 에러 발생
					//goChatOut();
					goChartOutMylotte();
				});	
			}
		}
}
/* ******************************************
읽지않은 메시지 건수
******************************************* */
function fn_talkBadgd(){
	var mForm = document.frm; 
	var obj = new Object(); 
	command = "TalkBadge";
	obj.command = command; 
	obj.domain_id = domain_id;
	obj.service_type = service_type;
	obj.customer_id = customer_id;
	var cmd = JSON.stringify(obj); 
	mForm.cmd2.value = cmd;
	var param = "cmd=" + cmd;
	var request = $.ajax({
	 url:url,
	 type:"POST",
	 data: param,
	 dataType:"json"
	});
	request.done(function(result){ 
	 if (result != null){
		  if (result.error_code == 0) { 
			  var data_message = new Object();
				  data_message = result.data;
			  var not_read_message = data_message.not_read_message;
			  var in_progress_talk_count = data_message.in_progress_talk_count;
			  $("#not_read_message").append(not_read_message);
		  }
	 }
	});
	request.fail(function(jqXHR, textStatus){ // 에러 발생
	});	
}
/* ******************************************
기존 상담한 메시지 가져오기 (talk_id가져오기)
******************************************* */
function fn_getTalkHistory(){
		//상담 목록가져오기 (talk_id가져오기위함)
		var mForm = document.frm; 
		var obj = new Object(); 
		command = "TalkList";
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.service_type = service_type;
		obj.node_id = node_id;
		obj.customer_id = customer_id;
		obj.status = "END";
		obj.include_count = "Y";
		obj.rows_per_page = "999";
		obj.page_no = "1";
		var cmd = JSON.stringify(obj); 
		mForm.cmd2.value = cmd;
		var param = "cmd=" + cmd;
		$("#chatIng").text("");
		var request = $.ajax({
			 url:"/proxy", // url: url,
			 type:"POST",
			 data: param,
			 dataType:"json",
			 success : function(result) {
				 if (result != null){
					if (result.error_code == 0) {						
						var data_message = new Object();
							data_message = result.data;
						var end_count = data_message.end_count;
						var all_count = data_message.all_count;
						var ing_count = data_message.ing_count;
						var rows_per_page = data_message.rows_per_page;
						if(end_count > 0){ //기존 상담건수 있음
							var talk_list = [];
								talk_list = data_message.talk_list;
							var title = "";	 
							var type = ""; 
							var msg = "";
							var status = "";
							var talk_id = "";
							var cdate = "";
							var node_id = "";
							var talkId_list = [];
							var status_list = [];
							  for(var i = 0 ; i < talk_list.length ; i++){
								  	type = talk_list[i].type;
								  	msg = talk_list[i].msg;
								  	cdate = talk_list[i].cdate;
								  	talk_id = talk_list[i].talk_id;
								  	node_id = talk_list[i].node_id;
								  	status = talk_list[i].status;
								  	status_list[i] = status;
								  	talkId_list[i] = talk_id;
							  }
							  $("#historyTalkId").val(talkId_list);
							  $("#historyStatus").val(status_list);
							  fn_getHistoryGet();
						}else{//기존 상담건수 없음
							fn_getTicket();
							onceAction = false;
						}  
						scrollBottomMove();
						onceAction2 = false;
				  }else{ 
				  }
				}
			 },
		 		error : function(request, status, error) {
		 		}
			});
}
/* ******************************************
기존 상담한 메시지 가져오기 (talk_id에 따른 message가져오기)
******************************************* */
function fn_getTalkContents(talk_list , status_list , endYn){
	//상담내역 톡 아이디 리스트 시작 
	var historyTalkId= [];
	var check = $("#historyTalkId").val().split(",");   
	for(var  j = 0; j < check.length ; j ++){
		historyTalkId[j] = check[j];
	}
	var historyStatus= [];
	var check2 = $("#historyStatus").val().split(",");  
	for(var  j = 0; j < check.length ; j ++){
		historyStatus[j] = check2[j];
	}
	//----상담내역 톡 아이디 리스트 종료
	var talkId_list = talk_list;
	var receive_list = "";
	//동일시간 일때 div id를 담을 변수
	var sameTime_C = []; //고객
	var sameTime_A = []; //상담사
	var sameTimeCnt_C = 0;
	var sameTimeCnt_A = 0;
	var cmd = "";
		var mForm = document.frm; 
		var obj = new Object(); 
		command = "TalkContents";
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.talk_id = talkId_list;
		obj.service_type = service_type;
		obj.customer_id = customer_id;
		obj.start_seq = "0";
		obj.end_seq = "999";
		var status = status_list;
		cmd = JSON.stringify(obj); 
		mForm.cmd2.value = cmd;
		var param = "cmd=" + cmd;
		var request = $.ajax({
		 url:url,
		 type:"POST",
		 data: param,
		 dataType:"json",
		 beforeSend : function(response){
			//중복호출 제외
			 dubCallProc = true;
		 },
		 success : function(result) {
			 if (result != null){
				if (result.error_code == 0) {
					var data_message = new Object();
					data_message = result.data;
					var message_list = [];
					message_list = data_message.message_list;
					var type = ""; 
					var msg = "";
					var seq = "";
					var talk_id = "";
					var flag = "";
					var cdate = "";
					var agent_read_flag = "";
					var ctime = "";
					var sender = "";
					var cdate_ch = ""; //상단 날짜가 중복되지 않았는지 체크
					var senderGubun = ""; //발신인 구분
					//메시지 유형이 link_msg일때 처리할 변수들(장바구니, 지식상담.. 등등)
					var link_msg = new Object(); 
					var link_type = "";
					var link_icon = "";
					var link_title = "";
					var link_message = "";
					var link_titleUrl = "";
					var link_linkUrl = "";
					var link_imgUrl = "";
					//상담사 이미지
				    var img_path = "";
				    var img_url = "";
				    var downloadUrl = "";
				   //TAG_LINK 추가사용 cloud_20151028
					var link_option = "";
					var link_price = "";
					var link_orderStatus = "";
					var link_iconText = "";
					var link_priceColor = "";
					var link_statusColor = "";
					var link_orderNo = "";
					var link_productNo = "";
					var link_goods_list = null; // 추천상품 json data
					  for(var j = 0; j < message_list.length ; j++){
						  var messageDivId = message_list[j].talk_id + "_" + message_list[j].seq;
							// 메시지 중복 방지 처리
							if ($("#" + messageDivId).length > 0)
							{
								continue;
							}
						    cdate_ch = $("#Hcdate_ch").val();
						    senderGubun = $("#HsenderGubun").val(); //twinsrira4
						  	type = message_list[j].type;
						  	msg = message_list[j].msg;
						  	agent_read_flag = message_list[j].agent_read_flag;
						  	if(msg.indexOf('\n') > 0){
								msg = (msg+"").replace(/\n/gi,'<br//>');
							}
						  //xss 스크립트 문자열 방지
							//msg = msg.replace(/\&/gi,"&amp;");
							if(msg.indexOf('<!') > -1 || msg.indexOf('<?') > -1){
								msg = msg.replace(/\</g, "&lt;");
								msg = msg.replace(/\>/g, "&gt;");
							}
						   sender = message_list[j].sender;
						   //메시지 유형이 link일때	
							if((msg.indexOf('type') > -1) && (msg.indexOf('title') > -1) && (msg.indexOf('message') > -1)){
								try{
									link_msg = JSON.parse(msg);
								}catch(ex){
									alert(ex.message);
								}
								link_type = link_msg.type;
								link_icon = link_msg.icon;
								link_title = link_msg.title;
								link_message = link_msg.message;
								link_titleUrl = link_msg.titleUrl+"";
								link_linkUrl = link_msg.linkUrl;
								link_imgUrl = link_msg.imgUrl;
								if(link_type == 'TAG_LINK'){
									link_option = link_msg.option;
									link_price = link_msg.price;
									link_orderStatus = link_msg.orderStatus;
									link_iconText = link_msg.iconText;
									link_priceColor = link_msg.priceColor;
									link_statusColor = link_msg.statusColor;
									link_orderNo = link_msg.orderNo;
									link_productNo = link_msg.productNo;
								}else if(link_type == 'GOODS_LINK'){
									link_goods_list = link_msg.goods_list;
								}else{
									link_option = "";
									link_price = "";
									link_orderStatus = "";
									link_iconText = "";
									link_priceColor = "";
									link_statusColor = "";
									link_orderNo = "";
									link_productNo = "";
								}
							}else{
								link_type = "";
								link_icon = "";
								link_title = "";
								link_message = "";
								link_titleUrl = "";
								link_linkUrl = "";
								link_imgUrl = "";
								link_option = "";
								link_price = "";
								link_orderStatus = "";
								link_iconText = "";
								link_priceColor = "";
								link_statusColor = "";
								link_orderNo = "";
								link_productNo = "";
							}
						  	seq = message_list[j].seq;
						  	talk_id = message_list[j].talk_id;
						  	flag = message_list[j].flag == "H"?"A":message_list[j].flag;
						  	cdate = message_list[j].cdate;
						  	if(agent_read_flag == 'Y' && flag == 'C'){
								  agent_read_flag = "읽음 ";
							  }else if(agent_read_flag == 'N' && flag == 'C'){
								  agent_read_flag = "1 ";
							  }else{
								  agent_read_flag = "";
							  }
						    receive_list +="<div id=\"history_before\" name=\"history_before\" style=\"display:none\" class=\"history_before\"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div>";
						  	if(cdate.substring(8,10) < '12'){
								  ctime = "오전 " + cdate.substring(8,10) + ":" + cdate.substring(10,12);
							  }else{
								  if(cdate.substring(8,10) == '12'){
									ctime = "오후 " + parseInt(cdate.substring(8,10)) + ":" + cdate.substring(10,12);
								  }else{
								  	ctime = "오후 " + parseInt(cdate.substring(8,10)-12) + ":" + cdate.substring(10,12);
								  }
							  }	
						  	var getDay = fu_getDay(cdate.substring(0,4), cdate.substring(4,6)-1 , cdate.substring(6,8));
							  cdate = cdate.substring(0,4) + "년 " + cdate.substring(4,6) + "월 " + cdate.substring(6,8) + "일 " + getDay;
							  if(cdate_ch != cdate || j == 0){
								  receive_list += "<div class=\"date\"><p>"+ cdate + "</p></div>";
							  }
							  $("#Hcdate_ch").val(cdate);
							  if(flag == 'S'){
								  receive_list += "<div id='" + messageDivId + "' class=\"message opp\"><div class=\"writer\">";
								  receive_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
								  receive_list += "</div>";
								  agent_read_flag = "";
							  }else if(flag == 'A'){
 								  receive_list += "<div id='" + messageDivId + "' class=\"message opp\">";
								  if((senderGubun !="A" && $("#HsameTimeCh_A").val() != ctime) || (senderGubun =="A" && $("#HsameTimeCh_A").val() != ctime ) || (senderGubun !="A" && $("#HsameTimeCh_C").val() == ctime)){
							        receive_list += "<div class=\"writer\">";
							        receive_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
									  receive_list += ""+sender+" 상담원</div>";
								  }
									   agent_read_flag = "";
							  }else if(flag == 'C'){
									  	receive_list += "<div id='" + messageDivId + "' class=\"message me\">";
							  }
							  //메시지 타입에 따른 구분
						  	  if(type == 'MSG'){//일반 메시지(www도 포함)
						  		var format = new RegExp( '[\\w-]+(\\.[\\w-]+)+([\\w-.,@?^=%&:/~+#-]*[\\w@?^=%&;/~+#-])?' );						  	  
								  if(format.test(msg) && link_type != 'TAG_LINK' && link_type != 'SELF_LINK' && link_type != 'URL_LINK' && link_type != 'KNW_LINK' && link_type != 'GOODS_LINK' ) {
							  		if(senderGubun == flag && ($("#HsameTimeCh_C").val() == ctime || $("#HsameTimeCh_A").val() == ctime)){
							  			receive_list += "<p class=\"text no_tail\">";
							  		}else{
							  			receive_list += "<p class=\"text\">";
							  		}
							  		var msgR = "";	
							  		var followParam = "";
							  		if(msg.indexOf('lotte.com') > -1){
										if(msg.indexOf('?') > -1){
											followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
										}else{
											followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
										}
									}
							  	//메시지 타입에 따른 구분
						  			if(msg.indexOf('<br//>') > 0){//줄바꿈이 온경우
						  				var msgSplit1 = msg.split("<br//>");
						  				for(var lyh1=0;lyh1 < msgSplit1.length;lyh1++){
						  					if(msgSplit1[lyh1].indexOf(' ') > 0){//줄바꿈안에 공백이 있는경우
							  					var msgSplit2 = msgSplit1[lyh1].split(" ");
							  					for(var lyh2=0;lyh2 < msgSplit2.length;lyh2++){
							  						if(format.test(msgSplit2[lyh2])){
							  							if(msgSplit2[lyh2].indexOf('http://') < 0 && msgSplit2[lyh2].indexOf('https://') < 0){
												  			msgR = "http://" + msgSplit2[lyh2];
											  			}else{
											  				msgR = msgSplit2[lyh2];
											  			}
							  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit2[lyh2] + "<br></a>";
														}else{
															receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit2[lyh2] + "<br></a>";
														}
							  						}else{
							  							receive_list += msgSplit2[lyh2];
							  						}
							  						receive_list += " ";
							  					}
							  				}else{ //줄바꿈만 있는경우
							  					if(format.test(msgSplit1[lyh1])){
							  						if(msgSplit1[lyh1].indexOf('http://') < 0 && msgSplit1[lyh1].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit1[lyh1];
										  			}else{
										  				msgR = msgSplit1[lyh1];
										  			}
							  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit1[lyh1] + "<br></a>";
													}else{
														receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit1[lyh1] + "<br></a>";
													}
							  					}else{
							  						receive_list += msgSplit1[lyh1];
							  					}
							  				}
						  					receive_list += "<br>";
						  				}
						  			}else{ //줄바꿈 없음
						  				if(msg.indexOf(' ') > 0){ //공백이 있음
						  					var msgSplit3 = msg.split(" ");
						  					for(var lyh3=0;lyh3 < msgSplit3.length;lyh3++){
						  						if(format.test(msgSplit3[lyh3])){
						  							if(msgSplit3[lyh3].indexOf('http://') < 0 && msgSplit3[lyh3].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit3[lyh3];
										  			}else{
										  				msgR = msgSplit3[lyh3];
										  			}
						  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit3[lyh3] + "<br></a>";
													}else{
														receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit3[lyh3] + "<br></a>";
													}
						  						}else{
						  							receive_list += msgSplit3[lyh3];
						  						}
						  						receive_list += " ";
						  					}
						  				}else{ //공백이 없음
						  					if(format.test(msg)){
						  						if(msg.indexOf('http://') < 0 && msg.indexOf('https://') < 0){
										  			msgR = "http://" + msg;
									  			}else{
									  				msgR = msg;
									  			}
						  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msg + "<br></a>";
												}else{
													receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msg + "<br></a>";
												}
						  					}else{
						  						receive_list += msg;	
						  					}
						  				}
						  			}
							  		receive_list += "</p>";
							  	}else{
							  		//메시지 유형이 링크메시지이면
							  		if(link_type != ""){
							  		    if(link_type == 'TAG_LINK'){
						  		    	receive_list += "<div class=\"text\">";
						  		    	receive_list += "<p class=\"title\">"+link_title+"</p>";
						  		    	receive_list += "<div class=\"prd_cont\">";
										var makeLinkUrl = "";
										var replaceLinkUrl = link_linkUrl.replace(/\@/gi,"&");
						  		    	if(link_orderNo != ""){ //주문정보
											if(makeLinkUrl == "INTERPARKTICKET"){
												receive_list += "<a href=\"#\" onclick=\"alert('티켓 주문은 WEB(PC)를 통해 확인할 수 있습니다');\">";
											}else{
												makeLinkUrl = "/mylotte/purchase/purchase_view.do?c=mlotte&udid=&v=&cn=&cdn=" + replaceLinkUrl;
												if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
												}else{
													receive_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
												}
											}
						  		    	}else{//장바구니 정보
						  		    		makeLinkUrl = "/product/product_view.do?c=mlotte&udid=&v=&cn=&cdn=" + replaceLinkUrl;
						  		    		if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
											}else{
												receive_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
											}
						  		    	}
						  		    	receive_list += "<div class=\"thumbnail\">";
						  		    	receive_list += "<img src=\""+link_imgUrl+"\" alt=\"\" onError=\"this.src='http://image.lotte.com/lotte/images/common/product/no_150.gif'\" />";
										if(link_orderStatus != ""){
											receive_list += "<span class=\""+link_statusColor+"\">"+link_orderStatus+"</span>";
										}
										receive_list += "</div>";
										receive_list += "<div class=\"detail\">";
										receive_list += "<P class=\"name\">"+link_message+"</p>";
										if(typeof link_option!="undefined"){
											receive_list += "<p class=\"option\">"+link_option+"</p>";
										}
										receive_list += "<P>"+link_price+"</p>";
										receive_list += "</div>";
										receive_list += "</a>";
										receive_list += "</div>";
										receive_list += "</div>";
							  		    }else if(link_type == 'SELF_LINK'){
							  		    	if(senderGubun == flag && ($("#HsameTimeCh_C").val() == ctime || $("#HsameTimeCh_A").val() == ctime)){
									  			receive_list += "<p class=\"text no_tail\">";
									  		}else{
									  			receive_list += "<p class=\"text\">";
									  		}
							  		    	receive_list += link_message;
							  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ talkPreUrl +link_linkUrl+"');return false;\" class=\"opp_btn back_btn\">" + link_title + "</a>";
											}else{
												var followParam = "";
										  		if(link_linkUrl.indexOf('lotte.com') > -1){
													if(link_linkUrl.indexOf('?') > -1){
														followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
													}else{
														followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
													}
												}
												receive_list += "<a target=\"_blank\" href=\""+ talkPreUrl + link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
											}
							  		    	receive_list += "</p>";
							  		    }else if(link_type == 'KNW_LINK'){
							  		    	if(senderGubun == flag && ($("#HsameTimeCh_C").val() == ctime || $("#HsameTimeCh_A").val() == ctime)){
									  			receive_list += "<p class=\"text no_tail\">";
									  		}else{
									  			receive_list += "<p class=\"text\">";
									  		}
							  		    	if(link_message.indexOf('\n') > 0){
							  		    		link_message = (link_message+"").replace(/\n/gi,'<br//>');
											}
							  		    	receive_list += link_message;
							  		    	var knw_link_msg = link_linkUrl.substring(link_linkUrl.indexOf('kbId=') + 5, link_linkUrl.length); //URL에서 kb_id를 가져옴
											var kb_id_url = decodeURIComponent(knw_link_msg);  // 가져온 kb_id를 디코딩
											//url은 나중에 바꿔야함...
											if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url +"');return false;\" class=\"opp_btn allview_btn\">" + link_title + "</a>";
									  		}else{
									  			receive_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url + "&c=mlotte&udid=&v=&cn=&cdn=\">" + link_title + "</a>";
									  		}
							  		    	receive_list += "</p>";
							  		    }else if(link_type == 'URL_LINK'){
							  		    	if(senderGubun == flag && ($("#HsameTimeCh_C").val() == ctime || $("#HsameTimeCh_A").val() == ctime)){
								  				receive_list += "<p class=\"text no_tail\" >";
								  			}else{
								  				receive_list += "<p class=\"text\" >";
								  			}
							  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +link_linkUrl +"');return false;\" class=\"opp_btn back_btn\">" + link_title + "</a>";
									  		}else{
									  			var followParam = "";
										  		if(link_linkUrl.indexOf('lotte.com') > -1){
													if(link_linkUrl.indexOf('?') > -1){
														followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
													}else{
														followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
													}
												}
										  		receive_list += "<a target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
									  		}
							  		    	receive_list += "</p>";
							  		    }
							  		}else{
							  			if(senderGubun == flag && ($("#HsameTimeCh_C").val() == ctime || $("#HsameTimeCh_A").val() == ctime)){
							  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
							  			}else{
							  				receive_list += "<p class=\"text\" >" + msg + "</p>";
							  			}
							  		}
							  	}
						  	  }else if(type == 'URL'){//첨부파일
						  		ext = message_list[j].ext;
							    filename = message_list[j].ext;  
							    //첨부파일 확장자 구분
							    var format01 = "\.(bmp|gif|jpg|jpeg|png|tif)$"; //이미지
							    var format02 = "\.(mov|mp4|wmv|3gp)$"; //동영상
							    var format03 = "\.(amr|mp3|m4a|ogg|3gpp)$"; //음성파일
							    var defaulImg = "http://image.lotte.com/lotte/mobile/chat_service/@temp_stop.png";    
							  	if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
							  		receive_list +="<div class=\"thumbnail\">";
							  		receive_list +="<a href=\"#none\" onClick=\"fn_imgPop(this,'"+msg+"');return false;\">";
							  		receive_list +="<img src=\""+ msg  +  "\" alt=\"\" onError=\"this.src=\'"+defaulImg+"'\" />";
							  		receive_list +="</a>";
							  		receive_list +="</div>";
							  	}
							  	if((new RegExp(format02, "i")).test(ext)){ //동영상 일때
							  		receive_list += "<div class=\"movie\">";
							  	//-------------------앱개발 완료 후 주석 해제 ----------------
							  		//receive_list += "<a href=\""+ talkPreUrl + msg+ "\">";/*[2016.01.22 주석해지]*/
							  		receive_list += "<a href=\"#\" onClick=\"go_MplayStop();return false;\">";/*[2016.01.22 주석처리]*/
							  		receive_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/@temp_play.png\" alt=\"\" />";
							  		receive_list += "</a>";
							  		receive_list += "</div>";
							  	}
							  	if((new RegExp(format03, "i")).test(ext)){ //음성파일 일때
							  		 //아이폰 일때 
							  		receive_list += "<p class=\"text\" ><a  href=\"#none\" onClick=\"fn_unLoadV()\" class=\"voice_btn\">";
							  		receive_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/icon_voice_btn.png\" alt=\"\" />";
							  		receive_list += "</a></p>";
							  	}
						  	  }else if(type == 'EMO'){//이모티콘
							  		receive_list += "<div class=\"thumbnail\">";
							  		receive_list += "<img style=\"width:100px;height:100px;\" src=\""+ msg +  "\"/>"; 
							  		receive_list += "</div>";
						  	  }else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
						  		if(senderGubun == flag && ($("#HsameTimeCh_C").val() == ctime || $("#HsameTimeCh_A").val() == ctime)){
						  			receive_list += "<p class=\"text no_tail\">" + msg + "</p>";
						  		}else{
						  			receive_list += "<p class=\"text\">" + msg + "</p>";
						  		}
						  		receive_list += "<p class=\"text\">상담 후 불편사항을 작성해 주시면 서비스 개선에 적극 반영하겠습니다.<a href=\"#none\" onclick=\"fn_surveyDivShow('"+talk_id+"')\" class=\"opp_btn satisfaction_btn\">상담만족도 평가</a></p>";
							  }else if(type == 'CEN'){ //고객이 상담을 종료했을때 메시지이면
							  		if(senderGubun == flag && ($("#HsameTimeCh_C").val() == ctime || $("#HsameTimeCh_A").val() == ctime)){
							  			receive_list += "<p class=\"text no_tail\">" + msg + "</p>";
							  		}else{
							  			receive_list += "<p class=\"text\">" + msg + "</p>";
							  		}   
							}else if(type == 'KNW'){ //지식상담
								var knw_msg = msg.substring(msg.indexOf('kbId=') + 5, msg.length); //URL에서 kb_id를 가져옴
								var kb_id = decodeURIComponent(knw_msg);  // 가져온 kb_id를 디코딩
									var knw_title = $("#knwTitle").val();
									if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +msg+"');return false;\">" + knw_title + "</a>";
									}else{
										var followParam = "";
								  		if(msg.indexOf('lotte.com') > -1){
											if(msg.indexOf('?') > -1){
												followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
											}else{
												followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
											}
										}
										receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + defaultDomain + msg + followParam + "'\">"+ knw_title +"</a>";
									}
							  }else{ //기타
								  if(senderGubun == flag && ($("#HsameTimeCh_C").val() == ctime || $("#HsameTimeCh_A").val() == ctime)){
						  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
						  			}else{
						  				receive_list += "<p class=\"text\" >" + msg + "</p>";
						  			}
						  	  }
						  	if(flag == 'C'){
						  		receive_list += "<div id=\"C"+talk_id+"_"+seq+"\" name=\"C"+talk_id+"_"+seq+"\" class=\"check\" style=\"display:block\"><span id=\"R"+talk_id+"_"+seq+"\" name=\"R"+talk_id+"_"+seq+"\">"+agent_read_flag + "</span>" + ctime +"</div>";
						  	}else if(flag == 'A'){
							  	 receive_list += "<div id=\"A"+talk_id+"_"+seq+"\" name=\"A"+talk_id+"_"+seq+"\" class=\"check\" style=\"display:block\">" + ctime +"</div>"; 
						  	}else if(flag == 'S'){
							  	 receive_list += "<div class=\"check\" style=\"display:block\">"+agent_read_flag + "" + ctime +"</div>";
							  	 receive_list += "</div>";
						  	}
						  	 //동일시간 비교  
						  	  if(flag == 'C' && $("#HsameTimeCh_C").val() == ctime){
								  var C_check = "C"+talk_id+"_"+eval(seq-1);
								  sameTime_C[sameTimeCnt_C] = C_check;
								  sameTimeCnt_C++;
							  }
						  	if(flag == 'A' && $("#HsameTimeCh_A").val() == ctime){
								  var A_check = "A"+talk_id+"_"+eval(seq-1);
								  sameTime_A[sameTimeCnt_A] = A_check;
								  sameTimeCnt_A++;
							 }
						  	  if(flag == 'C'){
						  		$("#HsameTimeCh_C").val(ctime);
						  	  }else if(flag == 'A'){
							  		$("#HsameTimeCh_A").val(ctime);  
						  	  }
						  	$("#HsenderGubun").val(flag);
						  	receive_list += "</div>";
					  } // --for END
					  	$("#getStatus").val(status);
						$("#chatIng").prepend(receive_list);
					//고객 같은시간 체크해서 같은시간 최종메시지만 읽음 및 시간 표시
					  for(var m = 0; m < sameTime_C.length; m ++){
						$("#"+sameTime_C[m]).attr("style","display:none");
					  }
					//상담원 같은시간 체크해서 같은시간 최종메시지만 읽음 및 시간 표시
					  for(var n = 0; n < sameTime_A.length; n ++){
						$("#"+sameTime_A[n]).attr("style","display:none");
					  }					  
			  }else{ 
				$("#chatLoading").attr("class","loading none");
			  }
			 }
			 dubCallProc = false;
			 diffScrollHeight = $(document).height() - prevScrollHeight;
			$("#chatLoading").attr("class","loading none");
			//마지막 상담 이력
			if(endYn == 'Y'){
	 			$("#history_before").attr("style","display:block");
			}
		  prevHistoryCnt++;
		  if(prevHistoryCnt <= check.length){
	       if($("#loadOk").val() != 'Y'){
				if(prevHistoryCnt % 4 == 0 ){
					$("#loadOk").val('Y');
				}else{
					if(prevHistoryCnt == check.length){
						fn_getTalkContents(historyTalkId[prevHistoryCnt] , historyStatus[prevHistoryCnt],"Y");
					}else{
						fn_getTalkContents(historyTalkId[prevHistoryCnt] , historyStatus[prevHistoryCnt],"");
					}
				}	
	       }
		  }
	      if(onceAction){
		    $("#cdate_ch").val($("#Hcdate_ch").val());
			fn_getTicket(); //기존 상담중인지 체크
			scrollBottomMove();
		  }
		   if(!onceAction2){
			   if(prevHistoryCnt % 4 == 0 ){
					$("html, body").animate({scrollTop: diffScrollHeight}, 0 );
				}
		   }
		 },error : function(request, status, error) {
			 $("#chatLoading").attr("class","loading none");
			 dubCallProc = false;
	 	}, 
 		complete : function(request, status) {
 		}
		});
}
/* ******************************************
상담중인 메시지 내용 가져오기 (talk_id에 따른 message가져오기)  twinsrira3
******************************************* */
function fn_getTalkContentsIng(talk_list , status_list){
	var talkId_list = talk_list;
	var receive_list = "";
	//동일시간 일때 div id를 담을 변수
	var sameTime_C = []; //고객
	var sameTime_A = []; //상담사
	var sameTimeCnt_C = 0;
	var sameTimeCnt_A = 0;
	var cmd = "";
		var mForm = document.frm; 
		var obj = new Object(); 
		command = "TalkContents";
		obj.command = command; 
		obj.domain_id = domain_id;
		obj.talk_id = talkId_list;
		obj.service_type = service_type;
		obj.customer_id = customer_id;
		obj.start_seq = "0";
		obj.end_seq = "999";
		var status = status_list;
		cmd = JSON.stringify(obj); 
		mForm.cmd2.value = cmd;
		var param = "cmd=" + cmd;
		var request = $.ajax({
		 url:url,
		 type:"POST",
		 data: param,
		 dataType:"json",
		 success : function(result) {
			 if (result != null){
				if (result.error_code == 0) {
					var data_message = new Object();
						data_message = result.data;
					var message_list = [];
						message_list = data_message.message_list;
					var type = ""; 
					var msg = "";
					var seq = "";
					var talk_id = "";
					var flag = "";
					var cdate = "";
					var agent_read_flag = "";
					var ctime = "";
					var sender = "";
					var cdate_ch = ""; //상단 날짜가 중복되지 않았는지 체크
					var senderGubun = ""; //발신인 구분
					//메시지 유형이 link_msg일때 처리할 변수들(장바구니, 지식상담.. 등등)
					var link_msg = new Object(); 
					var link_type = "";
					var link_title = "";
					var link_message = "";
					var link_imgUrl = "";
					var link_linkUrl = "";
					var link_icon = "";
					var link_titleUrl = "";
					//상담사 이미지
				    var img_path = "";
				    var img_url = "";
				    var downloadUrl = "";
					var link_option = "";
					var link_price = "";
					var link_orderStatus = "";
					var link_iconText = "";
					var link_priceColor = "";
					var link_statusColor = "";
					var link_orderNo = "";
					var link_productNo = "";
					var link_goods_list = null; // 추천상품 json data
					  for(var j = 0; j < message_list.length ; j++){
						  var messageDivId = message_list[j].talk_id + "_" + message_list[j].seq;
							// 메시지 중복 방지 처리
							if ($("#" + messageDivId).length > 0)
							{
								continue;
							}
						    cdate_ch = $("#cdate_ch").val();
						    senderGubun = $("#senderGubun").val();
						    agent_read_flag = message_list[j].agent_read_flag;
						  	type = message_list[j].type;
						  	msg = message_list[j].msg;
						  	if(msg.indexOf('\n') > 0){
								msg = (msg+"").replace(/\n/gi,'<br//>');
							}
						  //xss 스크립트 문자열 방지
							if(msg.indexOf('<!') > -1 || msg.indexOf('<?') > -1){
								msg = msg.replace(/\</g, "&lt;");
								msg = msg.replace(/\>/g, "&gt;");
							}
						   sender = message_list[j].sender;
						   //메시지 유형이 link일때	
							if((msg.indexOf('type') > -1) && (msg.indexOf('title') > -1) && (msg.indexOf('message') > -1)){
								try{
									link_msg = JSON.parse(msg);
								}catch(ex){
									alert(ex.message);
								}
								link_type = link_msg.type;
								link_icon = link_msg.icon;
								link_title = link_msg.title;
								link_message = link_msg.message;
								link_titleUrl = link_msg.titleUrl+"";
								link_linkUrl = link_msg.linkUrl;
								link_imgUrl = link_msg.imgUrl;								
								if(link_type == 'TAG_LINK'){
									link_option = link_msg.option;
									link_price = link_msg.price;
									link_orderStatus = link_msg.orderStatus;
									link_iconText = link_msg.iconText;
									link_priceColor = link_msg.priceColor;
									link_statusColor = link_msg.statusColor;
									link_orderNo = link_msg.orderNo;
									link_productNo = link_msg.productNo;
								}else if(link_type == 'GOODS_LINK'){
									link_goods_list = link_msg.goods_list;
								}else{
									link_option = "";
									link_price = "";
									link_orderStatus = "";
									link_iconText = "";
									link_priceColor = "";
									link_statusColor = "";
									link_orderNo = "";
									link_productNo = "";
								}
							}else{
								link_type = "";
								link_icon = "";
								link_title = "";
								link_message = "";
								link_titleUrl = "";
								link_linkUrl = "";
								link_imgUrl = "";
								link_option = "";
								link_price = "";
								link_orderStatus = "";
								link_iconText = "";
								link_priceColor = "";
								link_statusColor = "";
								link_orderNo = "";
								link_productNo = "";
							}
						  	seq = message_list[j].seq;
						  	talk_id = message_list[j].talk_id;
						  	flag = message_list[j].flag == "H"?"A":message_list[j].flag;
						  	cdate = message_list[j].cdate;
						  	if(agent_read_flag == 'Y' && flag == 'C'){
								  agent_read_flag = "읽음 ";
							  }else if(agent_read_flag == 'N' && flag == 'C'){
								  agent_read_flag = "1 ";
							  }else{
								  agent_read_flag = "";
							  }
						  	if(cdate.substring(8,10) < '12'){
								  ctime = "오전 " + cdate.substring(8,10) + ":" + cdate.substring(10,12);
							  }else{
								  if(cdate.substring(8,10) == '12'){
									ctime = "오후 " + parseInt(cdate.substring(8,10)) + ":" + cdate.substring(10,12);
								  }else{
								  	ctime = "오후 " + parseInt(cdate.substring(8,10)-12) + ":" + cdate.substring(10,12);
								  }
							  }
						  	var getDay = fu_getDay(cdate.substring(0,4), cdate.substring(4,6)-1 , cdate.substring(6,8));
							  cdate = cdate.substring(0,4) + "년 " + cdate.substring(4,6) + "월 " + cdate.substring(6,8) + "일 " + getDay;
							  if(cdate_ch != cdate){
								  receive_list += "<div class=\"date\"><p>"+ cdate + "</p></div>";
							  }
							  $("#cdate_ch").val(cdate);
							  if(flag == 'S'){
								  receive_list += "<div id='" + messageDivId + "' class=\"message opp\"><div class=\"writer\">";
								  receive_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
								  receive_list += "</div>";
								  agent_read_flag = "";
							}else if(flag == 'A'){
								   receive_list += "<div id='" + messageDivId + "' class=\"message opp\">";
									  if((senderGubun !="A" && $("#sameTimeCh_A").val() != ctime) || (senderGubun =="A" && $("#sameTimeCh_A").val() != ctime ) || (senderGubun !="A" && $("#sameTimeCh_C").val() == ctime)){
								        receive_list += "<div class=\"writer\">";
								        receive_list += "<img src='http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png' alt='LOTTE.COM' />"; 
								        receive_list += ""+sender+" 상담원</div>";
									  }
									   agent_read_flag = "";
							  }else if(flag == 'C'){
								  	receive_list += "<div id='" + messageDivId + "' class=\"message me\">";
							  }
						  	  if(type == 'MSG'){//일반 메시지(www도 포함)
						  		var format = new RegExp( '[\\w-]+(\\.[\\w-]+)+([\\w-.,@?^=%&:/~+#-]*[\\w@?^=%&;/~+#-])?' );						  	  
								  if(format.test(msg) && link_type != 'TAG_LINK' && link_type != 'SELF_LINK' && link_type != 'URL_LINK' && link_type != 'KNW_LINK' && link_type != 'GOODS_LINK' ) {
							  		if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  			receive_list += "<p class=\"text no_tail\">";
							  		}else{
							  			receive_list += "<p class=\"text\">";
							  		}
							  		var msgR = "";	
							  		var followParam = "";
							  		if(msg.indexOf('lotte.com') > -1){
										if(msg.indexOf('?') > -1){
											followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
										}else{
											followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
										}
									}
							  	//메시지 타입에 따른 구분
						  			if(msg.indexOf('<br//>') > 0){//줄바꿈이 온경우
						  				var msgSplit1 = msg.split("<br//>");
						  				for(var lyh1=0;lyh1 < msgSplit1.length;lyh1++){
						  					if(msgSplit1[lyh1].indexOf(' ') > 0){//줄바꿈안에 공백이 있는경우
							  					var msgSplit2 = msgSplit1[lyh1].split(" ");
							  					for(var lyh2=0;lyh2 < msgSplit2.length;lyh2++){
							  						if(format.test(msgSplit2[lyh2])){
							  							if(msgSplit2[lyh2].indexOf('http://') < 0 && msgSplit2[lyh2].indexOf('https://') < 0){
												  			msgR = "http://" + msgSplit2[lyh2];
											  			}else{
											  				msgR = msgSplit2[lyh2];
											  			}
							  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit2[lyh2] + "<br></a>";
														}else{
															receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit2[lyh2] + "<br></a>";
														}
							  						}else{
							  							receive_list += msgSplit2[lyh2];
							  						}
							  						receive_list += " ";
							  					}
							  				}else{ //줄바꿈만 있는경우
							  					if(format.test(msgSplit1[lyh1])){
							  						if(msgSplit1[lyh1].indexOf('http://') < 0 && msgSplit1[lyh1].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit1[lyh1];
										  			}else{
										  				msgR = msgSplit1[lyh1];
										  			}
							  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit1[lyh1] + "<br></a>";
													}else{
														receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit1[lyh1] + "<br></a>";
													}
							  					}else{
							  						receive_list += msgSplit1[lyh1];
							  					}
							  				}
						  					receive_list += "<br>";
						  				}
						  			}else{ //줄바꿈 없음
						  				if(msg.indexOf(' ') > 0){ //공백이 있음
						  					var msgSplit3 = msg.split(" ");
						  					for(var lyh3=0;lyh3 < msgSplit3.length;lyh3++){
						  						if(format.test(msgSplit3[lyh3])){
						  							if(msgSplit3[lyh3].indexOf('http://') < 0 && msgSplit3[lyh3].indexOf('https://') < 0){
											  			msgR = "http://" + msgSplit3[lyh3];
										  			}else{
										  				msgR = msgSplit3[lyh3];
										  			}
						  							if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  								receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msgSplit3[lyh3] + "<br></a>";
													}else{
														receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msgSplit3[lyh3] + "<br></a>";
													}
						  						}else{
						  							receive_list += msgSplit3[lyh3];
						  						}
						  						receive_list += " ";
						  					}
						  				}else{ //공백이 없음
						  					if(format.test(msg)){
						  						if(msg.indexOf('http://') < 0 && msg.indexOf('https://') < 0){
										  			msgR = "http://" + msg;
									  			}else{
									  				msgR = msg;
									  			}
						  						if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ msgR+"');return false;\">" + msg + "<br></a>";
												}else{
													receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + msgR + followParam + "'\">" + msg + "<br></a>";
												}
						  					}else{
						  						receive_list += msg;	
						  					}
						  				}
						  			}
							  		receive_list += "</p>";
							  	}else{
							  		//메시지 유형이 링크메시지이면
							  		if(link_type != ""){
							  		    if(link_type == 'TAG_LINK'){
						  		    	receive_list += "<div class=\"text\">";
						  		    	receive_list += "<p class=\"title\">"+link_title+"</p>";
						  		    	receive_list += "<div class=\"prd_cont\">";
										var makeLinkUrl = "";
						  		    	if(link_orderNo != ""){ //주문정보
											if(makeLinkUrl == "INTERPARKTICKET"){
												receive_list += "<a href=\"#\" onclick=\"alert('티켓 주문은 WEB(PC)를 통해 확인할 수 있습니다');\">";
											}else{
												makeLinkUrl = "/mylotte/purchase/purchase_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
												if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
						  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
												}else{
													receive_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
												}
											}
						  		    	}else{//장바구니 정보
						  		    		makeLinkUrl = "/product/product_view.do?c=mlotte&udid=&v=&cn=&cdn=" + link_linkUrl.replace(/\@/gi,"&");
						  		    		if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  							receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +makeLinkUrl+"');return false;\">";
											}else{
												receive_list += "<a href=\""+ talkPreUrl + defaultDomain +makeLinkUrl+"\" target=\"_blank\" >";
											}
						  		    	}
						  		    	receive_list += "<div class=\"thumbnail\">";
						  		    	receive_list += "<img src=\""+link_imgUrl+"\" alt=\"\" onError=\"this.src='http://image.lotte.com/lotte/images/common/product/no_150.gif'\" />";
										if(link_orderStatus != ""){
											receive_list += "<span class=\""+link_statusColor+"\">"+link_orderStatus+"</span>";
										}
										receive_list += "</div>";
										receive_list += "<div class=\"detail\">";
										receive_list += "<P class=\"name\">"+link_message+"</p>";
										if(typeof link_option!="undefined"){
											receive_list += "<p class=\"option\">"+link_option+"</p>";
										}
										receive_list += "<P>"+link_price+"</p>";
										receive_list += "</div>";
										receive_list += "</a>";
										receive_list += "</div>";
										receive_list += "</div>";
							  		    }else if(link_type == 'SELF_LINK'){
							  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
								  				receive_list += "<p class=\"text no_tail\" >";
								  			}else{
								  				receive_list += "<p class=\"text\" >";
								  			}
							  		    	receive_list += link_message;
							  		    	if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ talkPreUrl +link_linkUrl+"');return false;\" class=\"opp_btn back_btn\">" + link_title + "</a>";
											}else{
												var followParam = "";
										  		if(link_linkUrl.indexOf('lotte.com') > -1){
													if(link_linkUrl.indexOf('?') > -1){
														followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
													}else{
														followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
													}
												}
												receive_list += "<a target=\"_blank\" href=\""+ talkPreUrl + link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
											}
							  		    	receive_list += "</p>";
							  		    }else if(link_type == 'KNW_LINK'){
							  		    	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
									  			receive_list += "<p class=\"text no_tail\">";
									  		}else{
									  			receive_list += "<p class=\"text\">";
									  		}
							  		    	if(link_message.indexOf('\n') > 0){
							  		    		link_message = (link_message+"").replace(/\n/gi,'<br//>');
											}
							  		    	receive_list += link_message;
							  		    	var knw_link_msg = link_linkUrl.substring(link_linkUrl.indexOf('kbId=') + 5, link_linkUrl.length); //URL에서 kb_id를 가져옴
											var kb_id_url = decodeURIComponent(knw_link_msg);  // 가져온 kb_id를 디코딩
											if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url +"');return false;\" class=\"opp_btn allview_btn\">" + link_title + "</a>";
									  		}else{
									  			receive_list += "<a class=\"opp_btn allview_btn\" target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +"/talk/main/knowConsult.do?kbId=" + kb_id_url + "&c=mlotte&udid=&v=&cn=&cdn=\">" + link_title + "</a>";
									  		}
							  		    	receive_list += "</p>";
							  		    }else if(link_type == 'URL_LINK'){
								  		  	if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
								  				receive_list += "<p class=\"text no_tail\" >";
								  			}else{
								  				receive_list += "<p class=\"text\" >";
								  			}
								  		  if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
							  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +link_linkUrl +"');return false;\" class=\"opp_btn back_btn\">" + link_title + "</a>";
									  		}else{
									  			var followParam = "";
										  		if(link_linkUrl.indexOf('lotte.com') > -1){
													if(link_linkUrl.indexOf('?') > -1){
														followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
													}else{
														followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
													}
												}
										  		receive_list += "<a target=\"_blank\" href=\""+ talkPreUrl + defaultDomain +link_linkUrl + followParam +"\" class=\"opp_btn back_btn\">" + link_title + "</a>";
									  		}
							  		    	receive_list += "</p>";
								  		    }
							  		}else{
							  			//꼬리 없는 메시지
							  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
							  			}else{
							  				receive_list += "<p class=\"text\" >" + msg + "</p>";
							  			}
							  		}
							  	}
						  	  }else if(type == 'URL'){//첨부파일
						  		ext = message_list[j].ext;
							    filename = message_list[j].ext;  
							    //첨부파일 확장자 구분
							    var format01 = "\.(bmp|gif|jpg|jpeg|png|tif)$"; //이미지
							    var format02 = "\.(mov|mp4|wmv|3gp)$"; //동영상
							    var format03 = "\.(amr|mp3|m4a|ogg|3gpp)$"; //음성파일
							    var defaulImg = "http://image.lotte.com/lotte/mobile/chat_service/@temp_stop.png";  
							  	if((new RegExp(format01, "i")).test(ext)){ //이미지 일때
							  		receive_list +="<div class=\"thumbnail\">";
							  		receive_list +="<a href=\"#none\" onClick=\"fn_imgPop(this,'"+msg+"');return false;\">";
							  		receive_list +="<img src=\""+ msg  +  "\" alt=\"\"  />";
							  		receive_list +="</a>";
							  		receive_list +="</div>";
							  	}
							  	if((new RegExp(format02, "i")).test(ext)){ //동영상 일때
							  		receive_list += "<div class=\"movie\">";
							  	//-------------------앱개발 완료 후 주석 해제 ----------------
							  		receive_list += "<a href=\""+ talkPreUrl + msg+ "\">";/*[2016.01.22 주석해지]*/
								  	receive_list += "<a href=\"#\" onClick=\"go_MplayStop();return false;\">";/*[2016.01.22 주석처리]*/
							  		receive_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/@temp_play.png\" alt=\"\" />";
							  		receive_list += "</a>";
							  		receive_list += "</div>";
							  	}
							  	if((new RegExp(format03, "i")).test(ext)){ //음성파일 일때
							  		 //아이폰 일때 
							  		receive_list += "<p class=\"text\" ><a  href=\"#none\" onClick=\"fn_unLoadV()\" class=\"voice_btn\">";
							  		receive_list += "<img src=\"http://image.lotte.com/lotte/mobile/chat_service/icon_voice_btn.png\" alt=\"\" />";
							  		receive_list += "</a></p>";
							  	}
						  	  }else if(type == 'EMO'){//이모티콘
						  		receive_list += "<div class=\"thumbnail\">";
						  		receive_list += "<img style=\"width:100px;height:100px;\" src=\""+ msg +  "\"/>"; 
						  		receive_list += "</div>"; 
						  	  }else if(type == 'AEN'){ //상담원이 상담을 종료했을때 메시지이면
						  		//꼬리 없는 메시지
						  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
						  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
						  			}else{
						  				receive_list += "<p class=\"text\" >" + msg + "</p>";
						  			}
						  			receive_list += "<p class=\"text\">상담 후 불편사항을 작성해 주시면 서비스 개선에 적극 반영하겠습니다.<a href=\"#none\" onclick=\"fn_surveyDivShow('"+talk_id+"')\" class=\"opp_btn satisfaction_btn\">상담만족도 평가</a></p>";
							  }else if(type == 'CEN'){ //고객이 상담을 종료했을때 메시지이면
							  		if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
							  			receive_list += "<p class=\"text no_tail\">" + msg + "</p>";
							  		}else{
							  			receive_list += "<p class=\"text\">" + msg + "</p>";
							  		}   
							}else if(type == 'KNW'){ //지식상담
								var knw_msg = msg.substring(msg.indexOf('kbId=') + 5, msg.length); //URL에서 kb_id를 가져옴
								var kb_id = decodeURIComponent(knw_msg);  // 가져온 kb_id를 디코딩
									var knw_title = $("#knwTitle").val();
									if((isAppForTalk_script > -1 || isAppForTalk2_script > -1) && isMostVerForTalk_script < 0 ){ //최신버젼 앱이 아닐 때 
					  		    		receive_list += "<a  href=\"#\" onClick=\"appLoad('"+ defaultDomain +msg+"');return false;\">" + knw_title + "</a>";
									}else{
										var followParam = "";
								  		if(msg.indexOf('lotte.com') > -1){
											if(msg.indexOf('?') > -1){
												followParam = "&c=mlotte&udid=&v=&cn=&cdn=";
											}else{
												followParam =  "?c=mlotte&udid=&v=&cn=&cdn=";
											}
										}
										receive_list += "<a target=\"_blank\" href=\'"+ talkPreUrl + defaultDomain + msg + followParam + "'\">"+ knw_title +"</a>";
									}
							  }else{ //기타
								//꼬리 없는 메시지
						  			if(senderGubun == flag && ($("#sameTimeCh_C").val() == ctime || $("#sameTimeCh_A").val() == ctime)){
						  				receive_list += "<p class=\"text no_tail\" >" + msg + "</p>";
						  			}else{
						  				receive_list += "<p class=\"text\" >" + msg + "</p>";
						  			}
						  	  }
						  	    if(flag == 'C'){
							  		receive_list += "<div id=\"C"+talk_id+"_"+seq+"\" name=\"C"+talk_id+"_"+seq+"\" class=\"check\" style=\"display:block\"><span id=\"R"+talk_id+"_"+seq+"\" name=\"R"+talk_id+"_"+seq+"\">"+agent_read_flag + "</span>" + ctime +"</div>";
							  	}else if(flag == 'A'){
								  	 receive_list += "<div id=\"A"+talk_id+"_"+seq+"\" name=\"A"+talk_id+"_"+seq+"\" class=\"check\" style=\"display:block\">" + ctime +"</div>"; 
							  	}else{
								  	 receive_list += "<div class=\"check\" style=\"display:block\">"+agent_read_flag + "" + ctime +"</div>"; 
							  	}
						  	 //동일시간 비교  
						  	  if(flag == 'C' && $("#sameTimeCh_C").val() == ctime){
								  var C_check = "C"+talk_id+"_"+eval(seq-1);
								  sameTime_C[sameTimeCnt_C] = C_check;
								  sameTimeCnt_C++;
							  }
						  	if(flag == 'A' && $("#sameTimeCh_A").val() == ctime){
								  var A_check = "A"+talk_id+"_"+eval(seq-1);
								  sameTime_A[sameTimeCnt_A] = A_check;
								  sameTimeCnt_A++;
							 }
						  	  if(flag == 'C'){
						  		$("#sameTimeCh_C").val(ctime);
						  	  }else if(flag == 'A'){
							  		$("#sameTimeCh_A").val(ctime);  
						  	  }
						  	$("#senderGubun").val(flag); 
						  	receive_list += "</div>";
					  } // --for END
					  	  $("#getStatus").val(status);
						  $("#getTalkSeq").val(seq);
						  $("#getTalkId").val(talk_id);
						  $("#sendBtnSee").html("전송");
						  $("#chatIng").append(receive_list);
					//고객 같은시간 체크해서 같은시간 최종메시지만 읽음 및 시간 표시
					  for(var m = 0; m < sameTime_C.length; m ++){
						$("#"+sameTime_C[m]).attr("style","display:none");
					  }
					//상담원 같은시간 체크해서 같은시간 최종메시지만 읽음 및 시간 표시
					  for(var n = 0; n < sameTime_A.length; n ++){
						$("#"+sameTime_A[n]).attr("style","display:none");
					  }
			  }else{ 
			  }
			 }
		 },error : function(request, status, error) {
	 	}, 
 		complete : function(request, status) {
 			$("#head").find("> ul > li.out").attr("class","out on02");
 		}
	});
}
/* ******************************************
날짜에 해당하는 요일가져오기
******************************************* */
function fu_getDay(year,month,day){
	var dt = new Date(year, month , day); 
	var getDay = "";
  	switch(dt.getDay()){
	  	case 0 : getDay = '일요일';
  		break;
  		case 1 : getDay = '월요일';
  		break;
  		case 2 : getDay = '화요일';
  		break;
  		case 3 : getDay = '수요일';
  		break;
  		case 4 : getDay = '목요일';
  		break;
  		case 5 : getDay = '금요일';
  		break;
  		case 6 : getDay = '토요일';
  		break;
  	}
  	return getDay;
}
/* ******************************************
조회해온 과거상담이력을 1건 불러오기 
******************************************* */
function fn_getHistoryGet(){
	$("#chatLoading").attr("class","loading");
	var historyTalkId= [];
	var check = $("#historyTalkId").val().split(",");   
	//alert(check.length);	
	for(var  j = 0; j < check.length ; j ++){
		historyTalkId[j] = check[j];
	}
	var historyStatus= [];
	var check2 = $("#historyStatus").val().split(",");  
	for(var  j = 0; j < check.length ; j ++){
		historyStatus[j] = check2[j];
	}
	//-- cloud[S]
	if(historyTalkId != "" &&  historyStatus != "" ){
		//alert("prevHistoryCnt :"+prevHistoryCnt);
		//alert(prevHistoryCnt);
		if(prevHistoryCnt <= check.length){
			if(prevHistoryCnt == check.length){
				fn_getTalkContents(historyTalkId[prevHistoryCnt] , historyStatus[prevHistoryCnt],"Y");
			}else{
				$("#loadOk").val('N');
				fn_getTalkContents(historyTalkId[prevHistoryCnt] , historyStatus[prevHistoryCnt],"");
			}	
		}
	}
	//-- cloud[E]
}
/* ******************************************
이미지 메시지 클릭했을때 이미지 레이어팝업 호출 twinsrira100
******************************************* */
var scrolled = "";
function fn_imgPop(fileInfo,msg){
	scrollHoldForImage = false;
	var file_contents = msg + "&downtype=download";
	$(".img_pop .thumbnail").empty();
	$(".img_pop .thumbnail").html("<img id=\"imgPopRoof\" name=\"imgPopRoof\" src=\""+file_contents+"\" alt=\"\" />");
	$("#cover, .img_pop").show();
	$(".img_pop .thumbnail").css( "max-height" , $("body").height() );
	$(".img_pop .thumbnail").animate({ scrollTop: 0 }, 0 ); 
	scrolled = $(window).scrollTop();
	$("body").css({'top':-scrolled, 'position':'fixed'});
}
//팝업 닫기
function fn_imgPopClose(){
	$("#cover, .layer_pop").hide();
	$("body").css({'position':'','top':''}); 
	$(document).scrollTop( scrolled ); 
	scrollHoldForImage = true;
}
//새글
function newMsgLink(){
	//$("html, body").animate({scrollTop: $("#chatIng").height()}, 0 );
	document.body.scrollTop = document.body.scrollHeight;  // 20151120 수정
	$("#chatInput").find("> .now_message").hide();
	//nowMsgPosition(); // 20151119 추가
	/* if ( $('#emoticonInfo').val() != "" )
	{
		$("#chatInput").find("> .now_message").css( "top" , $("#chatInput").find("> .now_message").height() );
	} else {
		$("#chatInput").find("> .now_message").css( "top" , "" );
	} */
	scrollBottomMove();
}
//별점주기 DIV CLOUD20151019
function fn_surveyDivShow(rTalkId){
	if($("#rTalkIds").val().indexOf(rTalkId) > -1){
		alert('이미 등록하셨습니다.');
		return false;
	}else{
		$("#historyRTalkId").val(rTalkId);
	}
	$("#cover, ."+sur_div_class).show();
	// 팝업 위치 조절 - 20151021 추가
	function ResponsivePopSize() {
		$("."+sur_div_class).css( "bottom",  ( $(window).height() - $("."+sur_div_class).height() ) / 2 );
	}//ResponsivePopSize();
	$(window).resize(function(){
		ResponsivePopSize();
	});
	// 별점주기
	var satisfactionStar = (function () {
		var cont = $( ".satisfaction_score" );
		cont.on( "click", "span.score a", function () {
			var idx = $(this).index(),
				target = $(this).closest( "span.score" ).find( "a" );
			target.removeClass( "on" );
			var i;
			for( i = 0; i <= idx; ++i ) {
				target.eq(i).addClass( "on" );
				fn_surveyScoreCal((i+1) * 20);
			}
			return false;
		});
	}());
}
//별점주기 값 셋팅 CLOUD20151019
function fn_surveyScoreCal(score){
	$("#selectValue").val(score);
	//alert(score);
}
//상담사 읽음 처리
function fn_agentRead(talkId , serviceType, status){
  	//$("#R"+talkId+"_"+serviceType).text("");
  	var seq = $("#getTalkSeq").val();
  	if(seq > 0){
	  	for(var i = 0; i <= seq; i++){ 
	  	 $("#R"+talkId+"_"+i).html("읽음 ");
	  	}
  	}
}
//페이지 비활성화시 처리 
function handleVisibilityChange() {
	if (!document.hidden) {
  	//fn_getMessage2();
		setTimeout("fn_getMessage2(1)",500);
	}
}
//페이지 활성화 여부 EVENT
document.addEventListener("visibilitychange", handleVisibilityChange, false);
function goCart(){
	window.location = "https://m.lotte.com/talk/cart/talk_service_cart.do?c=mlotte&udid=&v=&cn=&cdn=&schema=&tclick=m_RDC_main_Clk_Btn_Custom_gotoCounsel";
}
function goPurchase(){
	//alert("https://m.lotte.com/talk/purchase/talk_service_purchase.do");
	window.location = "https://m.lotte.com/talk/purchase/talk_service_purchase.do?c=mlotte&udid=&v=&cn=&cdn=&schema=&tclick=m_RDC_main_Clk_Btn_Custom_gotoCounsel";	
}
/* ******************************************
알림설정 클릭했을때
******************************************* */
function fn_alarm(){
	window.location = "https://m.lotte.com/talk/alarm/alarmSetting.do?c=mlotte&udid=&v=&cn=&cdn=&schema=&tclick=m_RDC_main_Clk_Btn_Custom_gotoCounsel"; 
}
function getCartSend(cartCmd){
	$("#msg").val(cartCmd);
	//alert(cartCmd);
	//return;
	fn_send();
}
//아이폰 음성파일 로드 금지
function fn_unLoadV(){
	alert("음성 메시지는 재생이 불가능합니다.");
	return;
}
/* ******************************************
관리자 통계용 로그(상담가능)
******************************************* */
function fn_setOkLog(isInsertFailLog){
	var mForm = document.frm; 
	var obj = new Object(); 
	command = "CommonInsertActionLog";
	obj.command = command; 
	obj.domain_id = domain_id;
	//obj.service_type = "SVTLK";
	obj.service_type = service_type;
	obj.in_channel_id = in_channel_id;
	obj.action_status = "REQUEST";
	obj.status_value = "0";
	var cmd = JSON.stringify(obj); 
	mForm.cmd2.value = cmd;
	var param = "cmd=" + cmd;
	var result_list = "";
	var request = $.ajax({
	 url:url,
	 type:"POST",
	 data: param,
	 dataType:"json"
	});
	request.done(function(result){ 
	 if (result != null){
	  if (result.error_code == 0) { 
		  var data_message = new Object();
			  data_message = result.data;
		  var log_client_id = data_message.log_client_id;
		  $("#log_client_id").val(log_client_id);
		   if (isInsertFailLog)
		   {
			   //상담불가능 로그 등록
				fn_setFailLog();
		   }
	  }else{ 
	   	//존재하는 데이터 없음
	  }
	 }
	});
	//alert(request);
	request.fail(function(jqXHR, textStatus){ // 에러 발생
	});	
}
/* ******************************************
관리자 통계용 로그(상담불가능)
******************************************* */
function fn_setFailLog(){
	var mForm = document.frm; 
	var obj = new Object(); 
	command = "CommonInsertActionLog";
	obj.command = command; 
	obj.domain_id = domain_id;
	//obj.service_type = "SVTLK";
	obj.service_type = service_type;
	obj.in_channel_id = in_channel_id;
	obj.action_status = "REQFAIL";
	obj.status_value = "0";
	obj.log_client_id = $("#log_client_id").val();
	var cmd = JSON.stringify(obj); 
	mForm.cmd2.value = cmd;
	var param = "cmd=" + cmd;
	var result_list = "";
	var request = $.ajax({
	 url:url,
	 type:"POST",
	 data: param,
	 dataType:"json"
	});
	request.done(function(result){ 
	 if (result != null){
	  if (result.error_code == 0) { 
		  var data_message = new Object();
			  data_message = result.data;
		  var log_client_id = data_message.log_client_id;
		  $("#log_client_id").val(log_client_id);
	  }else{ 
	   	//존재하는 데이터 없음
	  }
	 }
	});
	request.fail(function(jqXHR, textStatus){ // 에러 발생
	});	
}
// 대체채널접수 로그쌓고 1:1 문의페이지로 이동
function fn_setOtherLog()
{
    var mForm = document.frm;
    var obj = new Object();
    command = "CommonInsertActionLog";
    obj.command = command;
    obj.domain_id = domain_id;
    obj.service_type = service_type;
    obj.in_channel_id = in_channel_id;
    obj.action_status = "REQOTHER";
    obj.status_value = "1012";
    obj.log_client_id = $("#log_client_id").val();
    var cmd = JSON.stringify(obj);
    mForm.cmd2.value = cmd;
    var param = "cmd=" + cmd;
    var result_list = "";
    var request = $.ajax(
    {
        url : url,
        type : "POST",
        data : param,
        dataType : "json"
    })
    .always(function(jqXHR, textStatus)
    {
        fn_goQuestion();
    });
}
//1:1 문의 페이지로 이동
function fn_goQuestion()
{
  window.location = $("#defaultD").val() +"/custcenter/m/question.do?"+ $("#commonP").val() +"&tclick="+ $("#tclick_my_s5").val();
}
//1:1 문의하기 클릭 시
function fn_goCustomer(isInsertLog){
	if($("#sendBtn").html() == "전송"){
		var conf = confirm("진행중인 톡 상담을 종료하고\r1:1문의하기로 이동하시겠습니까?");
		if(conf){
			fn_goQuestion();
		}
	}else{
		if (isInsertLog)
		{
			fn_setOtherLog();
		}
		else
		{
			fn_goQuestion();
		}  
	}
}
function textareaInputInit(){
	$("#chatInput").find("> .keypad_input").find("> .keypad > textarea").css("height","auto");
	$("#chatInput").find("> .keypad_input").find("> .keypad > textarea").height(this.scrollHeight);
}
function divOutLayerClose(){
	$("#head").find("> ul > li.out").attr("class","out on02");
}
function goChatOut(){
	//window.location = "https://m.lotte.com/mylotte/m/mylotte.do?c=mlotte&udid=&v=&cn=&cdn=&schema=&tclick=m_RDC_main_Clk_Btn_Custom_gotoCounsel";
	history.back();; //gotoPrepage();
}
//20161209 나가기 버튼 선택시 마이 페이지로 이동
function goChartOutMylotte(){
	window.location = "https://m.lotte.com/mylotte/m/mylotte.do?c=mlotte&udid=&v=&cn=&cdn=&schema=&tclick=m_RDC_main_Clk_Btn_Custom_gotoCounsel";
}
//최신앱 아닐때 링크 클릭 시
function appLoad(msgR){ 
	var commonParam_script = "c=mlotte&udid=&v=&cn=&cdn=";
	if(msgR.indexOf('lotte.com') > -1){
		if(msgR.indexOf('?') > -1){
			msgR = msgR + "&" + commonParam_script;
		}else{
			msgR = msgR + "?" + commonParam_script;
		}
	}
	if(ua_script > -1){ //앱 최신버젼이 아니면서 안드로이드
		//alert("안드로이드");	
		if(msgR.indexOf('talk/knowConsult.jsp') > -1){
			location.href = msgR;
		}else{
			//window.GLMobile.lecsplatform(msgR); //국문
			window.lecsplatform.callAndroid(msgR); //국문
		}
		//window.GLMobile.openNewWebview(msgR); //중문
	}else{ //앱 최신버젼이 아니면서 IOS
		//alert("아이폰");
		var ios_msgR = "";
		if(msgR.indexOf('http://') > -1){
			ios_msgR = msgR.replace('http://' , '');
		}else if(msgR.indexOf('https://') > -1){
			ios_msgR = msgR.replace('https://' , '');
		}else{
			ios_msgR = msgR;
		}
		window.location.href = "lecsplatform://" + ios_msgR;
		//window.location.href = "glmobile:openNewWebview//" + ios_msgR;
	}
}
</script>
<script language="javascript" type="text/javascript">
//공지사항레이어
function chatCloseWin2ForChat(winName, expiredays) { 
	setCookieForChat( winName, "done" , expiredays);
	layerClose();
}
//나가기안내레이어
function chatCloseWinForChat(winName, expiredays) { 
	setCookieForChat( winName, "done" , expiredays);
	$("#head").find("> ul > li.out").attr("class","out on02");
}
// 쿠키 가져오기
function getCookieForChat( name ) {
   var nameOfCookie = name + "=";
   var x = 0;
   while ( x <= document.cookie.length )
   {
	   var y = (x+nameOfCookie.length);
	   if ( document.cookie.substring( x, y ) == nameOfCookie ) {
		   if ( (endOfCookie=document.cookie.indexOf( ";", y )) == -1 )
			   endOfCookie = document.cookie.length;
		   return unescape( document.cookie.substring( y, endOfCookie ) );
	   }
	   x = document.cookie.indexOf( " ", x ) + 1;
	   if ( x == 0 )
		   break;
   }
   return "";
}
// expiredays 후의 클릭한 시간까지 쿠키 설정
function setCookieForChat( name, value, expiredays ) { 
   var todayDate = new Date(); 
   todayDate.setDate( todayDate.getDate() + expiredays ); 
   document.cookie = name + "=" + escape( value ) + "; path=/; expires=" + todayDate.toGMTString() + ";" 
}
/* ******************************************
상담 중 비로그인시 로그인화면 이동_20151117 추가
******************************************* */
function fn_goLogin(){
	alert("로그인이 필요합니다. 로그인 화면으로 이동합니다.");
	self.location.href = "https://m.lotte.com/login/loginForm.do?c=mlotte&udid=&v=&cn=&cdn=&targetUrl=" + encodeURIComponent(window.location.href,'UTF-8');
}
function talkImage(){
	//alert("talkImage");
	$("#file_type").val("");
	$("#fileExt64").val("");
	window.GLMobile.talkImage();
}
function talkVideo(){
	$("#file_type").val("");
	$("#fileExt64").val("");
	window.GLMobile.talkVideo();
}
function talkCamera(){
	$("#file_type").val("");
	$("#fileExt64").val("");
	window.GLMobile.talkCamera();
}
function talkAudio(){
	$("#file_type").val("");
	$("#fileExt64").val("");
	window.GLMobile.talkAudio();
}
function setTalkImage(fileExt,imgdata){
	$("#fileAttach").val(imgdata);
	$("#fileExt64").val(fileExt);
	$("#file_type").val("ATTACH");
	fileType = "fileAttach";
	var aaa = $("#fileAttach").val();
	//checkExt('fileAttach', imgdata);
	fn_send();
}
function setTalkVideo(fileExt,imgdata){
	//alert(imgdata);
	$("#fileAttach2").val(imgdata);
	$("#fileExt64").val(fileExt);
	$("#file_type").val("ATTACH");
	fileType = "fileAttach2";
	//checkExt('fileAttach2', imgdata);
	fn_send();
}
function setTalkCamera(fileExt,imgdata){
	//alert(imgdata);
	$("#fileAttach3").val(imgdata);
	$("#fileExt64").val(fileExt);
	$("#file_type").val("ATTACH");
	fileType = "fileAttach3";
	//checkExt('fileAttach3', imgdata);
	fn_send();
}
function setTalkAudio(fileExt,imgdata){//3gpp
	//alert(imgdata);
	$("#fileAttach4").val(imgdata);
	$("#fileExt64").val(fileExt);
	$("#file_type").val("ATTACH");
	fileType = "fileAttach4";
	//checkExt('fileAttach4', imgdata);
	fn_send();
}
function go_MplayStop(){
	alert('죄송합니다. 동영상 재생은 추후 제공될 예정입니다.');
}
//음성파일 재생 막기
function go_VplayStop(){
	alert('죄송합니다. 음성 재생은 추후 제공될 예정입니다.');
}
function refreshTalk(){
	setTimeout("fn_getMessage2(1)",500);
	getNewMessageBlock = false;
}
function awayTalk(){
	getNewMessageBlock = true;
}
</script>
<script src="/common3/js/SpeedTrapInsert.js"></script>



<!-- 20180309: 스타일, 스크립트 추가 -->
<style>
#wrapper{position:relative;height:100%;background-color:#c3def3;}
#head{position:absolute !important;}
#iScrollWrap{position:absolute;left:0;right:0;top:0;bottom:0;overflow:auto;}
.iScrollCont{position:relative;padding:0;margin:0;overflow:visible;}
#chat{position:relative;padding:55px 10px 56px 10px;overflow:visible;}
#chatInput{position:absolute !important;top:initial;left:0;right:0;bottom:0;}
</style>
<script type="text/javascript" src="http://m.lotte.com/common4/js/iscroll.js"></script>
<script>
var talkIscroll;
function initIscroll(){
	var iScrollOption = {
		mouseWheel: true,
		scrollY:    true,
		scrollX:    false,
		click:      true
	};
	talkIscroll = new IScroll("#iScrollWrap", iScrollOption);
	
	setTimeout(function(){
		talkIscroll.scrollTo(0, talkIscroll.maxScrollY);
	}, 0);
	
	$(window).bind("touchmove", function(e){
		e.preventDefault();
		//e.stopPropagation();
	});
	
	/* $("#msg2").bind("focusin", function(){
		setTimeout(function(){
			$("window, body").scrollTop( $("body").get(0).scrollHeight );
		}, 300);
		setTimeout(function(){
			$("window, body").scrollTop($("window, body").scrollTop() - 45);
		}, 400);
	}); */
	
	
	/* $(window).bind("scroll", trace);
	trace(); */
}

/* var traceArr = [];
function trace(){
	var arr = [];
	arr.push(screen.height);
	arr.push($(window).height());
	arr.push($("body").get(0).scrollHeight);
	arr.push($(window).scrollTop());
	traceArr.unshift(arr.join(", "));
	if(traceArr.length > 30){
		traceArr.length = 30;
	}
	
	var dv = $("#tracer");
	if(dv.length == 0){
		dv = $('<div id="tracer" style="position:fixed;bottom:100px;left:0;right:0;height:100px;font-size:12px;color:#333;overflow:auto;background-color:white;z-index:10000;"></div>');
		$("body").append(dv);
	}
	
	dv.html(traceArr.join('<br/>'));
	//$("#msg2").val(arr.join(", "));
} */

setTimeout(initIscroll, 3000);// <<<<<<<<<<<<<<<<<<<<<<<<<<< 데이터 로드 후에 initIscroll() 실행
</script>
<!-- 20180309: 스타일, 스크립트 추가 -->




</head>
<body>
<form style="height:100%;" method="post" name="frm" id="frm" enctype="multipart/form-data">
	<input type="hidden" name="restrictedWord" id="restrictedWord" value=""/><input type="hidden" name="getStatus" id="getStatus" value=""/><input type="hidden" name="defaultD" id="defaultD" value="https://m.lotte.com"/><input type="hidden" name="commonP" id="commonP" value="c=mlotte&udid=&v=&cn=&cdn="/><input type="hidden" name="tclick_my_s5" id="tclick_my_s5" value="m_my_service5"/><input type="hidden" name="userId" id="userId" value="charisema"/><input type="hidden" id="log_client_id" name="log_client_id" value=""/>
	<input type="hidden" id="userNo" name="userNo" value="0010839244"/>
	<!-- 통계 로그용 아이디 -->
	<!-- 상담원 대표 이미지 -->
	<input type="hidden" name="Agent_imgType" id="Agent_imgType" value=""/>
	<input type="hidden" name="Agent_imgPath" id="Agent_imgPath" value=""/>
	<input type="hidden" name="Agent_imgUrl" id="Agent_imgUrl" value=""/>
	<!-- 발신인 구분 -->
	<input type="hidden" name="senderGubun" id="senderGubun" value=""/>
	<input type="hidden" name="HsenderGubun" id="HsenderGubun" value=""/>
	<!-- 동일시간 체크하는 파라미터 -->
	<input type="hidden" name="sameTimeCh_C" id="sameTimeCh_C" value=""/>
	<input type="hidden" name="sameTimeCh_A" id="sameTimeCh_A" value=""/>
	<input type="hidden" name="HsameTimeCh_C" id="HsameTimeCh_C" value=""/>
	<input type="hidden" name="HsameTimeCh_A" id="HsameTimeCh_A" value=""/>
	<!-- 스크롤 하단 위치 -->
	<input type="hidden" name="scrollY" id="scrollY" value=""/>
	<!-- 이전 상담기록 -->
	<input type="hidden" name="historyTalkId" id="historyTalkId" value=""/>
	<input type="hidden" name="historyStatus" id="historyStatus" value=""/>
	<input type="hidden" name="connectionYn" id="connectionYn" value="N"/>
	<!-- 상담가능시간 -->
	<input type="hidden" name="onFromTime" id="onFromTime" value=""/><input type="hidden" name="onEndTime" id="onEndTime" value=""/><input type="hidden" name="inputIng" id="inputIng" value="N"/><input type="hidden" name="cdate_ch" id="cdate_ch" value=""/><input type="hidden" name="Hcdate_ch" id="Hcdate_ch" value=""/><input type="text" name="getTalkId" id="getTalkId" value=""/><input type="hidden" name="getTalkSeq" id="getTalkSeq" value="0"/><input type="hidden" name="emoticonName" id="emoticonName" value=""/><input type="hidden" name="emoticonInfo" id="emoticonInfo" value=""/><input type="hidden" name="getUrl" id="getUrl" value=""/><input type="hidden" name="knwTitle" id="knwTitle" value=""/>
	<!-- 설문조사 별점 점수값 -->
	<input type="hidden" name="selectValue" id="selectValue" value="0"/>
	<!-- 초기값 0 셋팅 -->
	<!-- 설문조사 history talkId -->
	<input type="hidden" name="historyRTalkId" id="historyRTalkId" value=""/><input type="hidden" name="rTalkIds" id="rTalkIds" value=""/>
	
	
	
	
	
	<div id="wrapper">
	
		<header id="head">
			<h1>
			<a href="#none">롯데닷컴 톡</a>
			</h1>
			<ul>
				<li class="back"><a href="javascript:goBack();" id="goBack">뒤로가기</a></li>
				<li class="alarm"><a href="#" onclick="fn_alarm()">알림</a></li>
				<li class="out">
				<!-- 상담 시작시에는 클래스 on 부여 -->
				<a href="#" onclick="fn_talkEnd();return false;">나가기</a>
				<div class="decorations">
					<p>
						<strong>나가기 버튼</strong>으로 상담을<br/> 종료할 수 있습니다.
					</p>
					<a href="#none" class="close" onclick="javascript:chatCloseWinForChat('divLayChatOutPopup', 365);">닫기</a>
				</div>
				</li>
			</ul>
			<div id="output" class="layer_info">
			</div>
		</header>
		
		<!-- 20180309: iScrollWrap / iScrollCont 추가 -->
		<div id="iScrollWrap">
			<div class="iScrollCont">
				
				<!-- 채팅 영역 -->
				<section id="chat">
					<div id="chatLoading" name="chatLoading" class="loading none"></div>
					<!-- 20151030 추가 : 로딩완료후에는 <div class="loading none"> 클래스명 none 부여-->
					<section id="chatIng" style="position:relative;overflow:hidden;">
						<div id="history_before" name="history_before" style="display:block" class="history_before"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div><div class="date"><p>2017년 11월 15일 수요일</p></div><div id="TCKT0000595687_0" class="message me"><div class="movie"><a href="#" onclick="go_MplayStop();return false;"><img src="http://image.lotte.com/lotte/mobile/chat_service/@temp_play.png" alt=""></a></div><div id="CTCKT0000595687_0" name="CTCKT0000595687_0" class="check" style="display:block"><span id="RTCKT0000595687_0" name="RTCKT0000595687_0">읽음 </span>오후 2:35</div></div><div id="history_before" name="history_before" style="display:none" class="history_before"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div><div id="TCKT0000595687_1" class="message opp"><div class="writer"><img src="http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png" alt="LOTTE.COM"></div><p class="text">고객님, 톡 연결 중이에요. 잠시만 기다려주세요~ ^▽^ <br>고객님의 소중한 개인정보(이메일, 연락처 등)는 입력하시면 안 돼요~ &gt;.&lt;</p><div class="check" style="display:block">오후 2:35</div></div><div id="history_before" name="history_before" style="display:none" class="history_before"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div><div id="TCKT0000595687_2" class="message opp"><div class="writer"><img src="http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png" alt="LOTTE.COM"></div><p class="text">모든 상담원이 상담 중이라 연결이 지연되고 있어요. ㅠㅅㅠ <br>조금만 더 기다려주시면 상담이 종료되는 대로 연결해 드릴게요.</p><div class="check" style="display:block">오후 2:36</div></div><div id="history_before" name="history_before" style="display:none" class="history_before"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div><div id="TCKT0000595687_3" class="message opp"><div class="writer"><img src="http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png" alt="LOTTE.COM"></div><p class="text">고객님, 진행 중인 상담이 길어지고 있어요. <br>너무 오래 기다리게 해드려 죄송해요. ㅠㅅㅠ 조금만 더 기다려주세요.</p><div class="check" style="display:block">오후 2:39</div></div><div id="history_before" name="history_before" style="display:none" class="history_before"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div><div id="TCKT0000595687_4" class="message opp"><div class="writer"><img src="http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png" alt="LOTTE.COM">이한샘 상담원</div><p class="text">반갑습니다, 고객님. <br>빠르고 친절한 톡 상담원 이한샘 입니다. (*^_^*)</p><div id="ATCKT0000595687_4" name="ATCKT0000595687_4" class="check" style="display:none">오후 2:44</div></div><div id="history_before" name="history_before" style="display:none" class="history_before"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div><div id="TCKT0000595687_5" class="message opp"><p class="text no_tail">채팅 연결지연으로 불편을 드려 죄송합니다. ㅠ_ㅠ<br>궁금하신 내용 말씀해주시면 빠른 확인 후 안내 도움드리도록 하겠습니다┗('ㅅ ' )┓===3 </p><div id="ATCKT0000595687_5" name="ATCKT0000595687_5" class="check" style="display:block">오후 2:44</div></div><div id="history_before" name="history_before" style="display:none" class="history_before"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div><div id="TCKT0000595687_6" class="message opp"><div class="writer"><img src="http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png" alt="LOTTE.COM"></div><p class="text">고객님, 많이 바쁘신가 봐요~<br>말씀이 없으셔서 1분 후 저와 상담이 종료될 예정이에요. ㅠㅅㅠ<br>종료되기 전에 내용을 입력해주시면 상담은 지속된답니다. *^▽^*</p><div class="check" style="display:block">오후 2:46</div></div><div id="history_before" name="history_before" style="display:none" class="history_before"><p>상담이력은 최근 6개월까지만 제공합니다.</p></div><div id="TCKT0000595687_7" class="message opp"><div class="writer"><img src="http://image.lotte.com/lotte/mo2015/angular/custcenter/cs_2018_question.png" alt="LOTTE.COM"></div><p class="text">고객님, 많이 바쁘신지 상담이 종료되어 버렸네요. ㅠㅅㅠ <br>하지만 문의사항을 이어서 입력하시거나 [상담신청] 버튼을 눌러주시면 <br>다시 톡 상담 연결이 가능하니 걱정하지 마세요~ ^.^</p><div class="check" style="display:block">오후 2:47</div></div>
					</section>
					<div id="chatLoading2" name="chatLoading2" class="attach_loading none"></div>
					<!-- 20151116 추가 : 첨부파일 업로드 로딩바 / 로딩완료후에는 <div class="loading none"> 클래스명 none 부여-->
				</section>
				
			</div>
		</div>
		<!-- 20180309: iScrollWrap / iScrollCont 추가 -->
		
		<section id="chatInput">
			<div class="now_message" id="nowMsgDiv" name="nowMsgDiv" onclick="newMsgLink();" style="display: none;"></div>
			<div class="emoticon_message">
				<!--  
				<a class="view" href="#none"></a>
				<a class="close" href="#none">닫기</a>
				-->
			</div>
			<div class="keypad_input">
				<a href="#none" class="attach_btn" onclick="fn_writing();">첨부하기</a>
				<div class="keypad">
					<textarea id="msg2" name="msg2" cols="30" maxlength="800" onkeyup="test2()" placeholder="메시지를 입력하세요" rows="1"></textarea>
					<script>
						function test2(){
							console.info('test');
						};
					</script>
				</div>
				<a href="#none" class="emoticon_btn" onclick="fn_writing();">이모티콘</a>
				<div class="send">
					<button id="sendBtnSee" name="sendBtnSee" onclick="fn_send();return false;">
					상담<br/>신청 </button>
					<button id="sendBtn" name="sendBtn" style="display: none;">
					상담<br/>신청 </button>
					<!-- 상담신청
					<button>상담<br/>신청</button>		
					-->
				</div>
			</div>
			<div class="layer_input">
				<div class="attach">
					<ul>
						<li class="photo"><span>사진<input type="file" name="fileAttach" id="fileAttach" accept="image/*" onchange="checkExt('fileAttach', this.value);return false;"/></span></li>
						<li class="movie"><span>동영상<input type="file" name="fileAttach2" id="fileAttach2" accept="video/*" onchange="checkExt('fileAttach2', this.value);return false;"></span></li>
						<li class="camera"><span>카메라<input type="file" name="fileAttach3" id="fileAttach3" capture="camera" onchange="checkExt('fileAttach3', this.value);return false;"></span></li>
						<li class="cart"><a href="#" onclick="javascript:goCart();return false;">장바구니</a></li>
						<li class="order"><a href="#" onclick="javascript:goPurchase();return false;">주문상품</a></li>
					</ul>
				</div>
				<div class="emoticon">
					<div id="emoticonSlider">
					</div>
					<div class="page">
						<span class="page_list on">이모티콘</span><span class="page_list">이모티콘 2</span>
					</div>
				</div>
			</div>
		</section>
		
		<section id="cover"></section>
		<!-- 이미지 팝업 -->
		<section class="layer_pop img_pop">
			<div class="img_pop_wrap">
				<div class="thumbnail">
					<img id="imgPopRoof" name="imgPopRoof" src="" alt=""/>
				</div>
				<a href="#none" class="close" onclick="fn_imgPopClose();return false;">닫기</a>
			</div>
		</section>
		<!-- // 이미지 팝업 -->
		<!-- 상담만족도 평가 팝업 -->
		<section class="layer_pop satisfaction_pop">
			<p class="title">
				상담만족도 평가
			</p>
			<div class="satisfaction_score">
				<span class="score" id="satisfaction_pop_inner" name="satisfaction_pop_inner"><a href="#">20</a><a href="#">40</a><a href="#">60</a><a href="#">80</a><a href="#">100</a>
				</span>
				<div class="textarea">
					<textarea id="inputMessage" name="inputMessage" placeholder="상담 후 불편사항을 작성해주시면 서비스 개선에 적극 반영하겠습니다. (최대 한글 500자)"></textarea>
				</div>
			</div>
			<div class="btn">
				<a href="#none" onclick="fn_cancelSurvey();return false;" class="cancle">취소</a><a href="#" onclick="fn_bfInsertSurvey('');return false;">완료</a>
			</div>
		</section>
		<!-- // 상담만족도 평가 팝업 -->
		
	</div><!-- #wrapper -->
	
	
	
	
	
	
	
	
	<!--<input type="text" name="auth_id" id="auth_id" value="KXRlNURNKm5AYjNas" /> -->
	<input type="hidden" name="cmd2" id="cmd2" value="" alt="전송할 cmd"/>
	<input type="hidden" name="not_read_message" id="not_read_message" value="" alt="읽지않은 메시지건수"/>
	<!-- 파일 첨부 -->
	<input type="hidden" name="file_type" id="file_type" value=""/><input type="hidden" name="cmd" id="cmd" value=""/><input type="hidden" name="loadOk" id="loadOk" value=""/><input type="hidden" name="fileExt64" id="fileExt64" value=""/>
</form>
</body>
</html>